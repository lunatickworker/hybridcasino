import{r as o,j as t}from"./react-core-BwkdTuSg.js";import{n as G,a as J,s as b,B as T,S as I,p as E,q as O,r as P,t as l,I as N}from"./index-McppjVnx.js";import{D as Q}from"./DataTable-w2U-jZDQ.js";import{k as X}from"./vendor-D410aui4.js";import{M as v}from"./MetricCard-DnMFhTGK.js";import{d as Z,s as W,a9 as ee,a2 as te,w as ae}from"./lucide-icons-CePlpqHy.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";import"./table-CKCHMZ5m.js";function me(){const{authState:m}=G(),{t:a}=J(),[w,u]=o.useState([]),[B,S]=o.useState(!0),[g,D]=o.useState({todayDeposits:0,todayWithdrawals:0,netTransfer:0}),[y,q]=o.useState("latest"),[x,F]=o.useState(""),[f,V]=o.useState(""),[_,H]=o.useState("all"),[h,K]=o.useState(""),M=async()=>{try{if(S(!0),!m.isAuthenticated||!m.user){u([]);return}let e=b.from("partner_balance_logs").select("*").not("from_partner_id","is",null).not("to_partner_id","is",null).in("transaction_type",["deposit","withdrawal"]);if(m.user.level!==1){const r=m.user.id;e=e.or(`from_partner_id.eq.${r},to_partner_id.eq.${r}`)}x&&(e=e.gte("created_at",`${x}T00:00:00`)),f&&(e=e.lte("created_at",`${f}T23:59:59`));const{data:s,error:n}=await e.order("created_at",{ascending:y==="oldest"}).limit(1e3);if(n)throw console.error("partner_balance_logs 조회 오류:",n),n;if(!s||s.length===0){u([]),D({todayDeposits:0,todayWithdrawals:0,netTransfer:0});return}const i=new Set;s.forEach(r=>{r.from_partner_id&&i.add(r.from_partner_id),r.to_partner_id&&i.add(r.to_partner_id)});const{data:p,error:c}=await b.from("partners").select("id, username, nickname, partner_type").in("id",Array.from(i));c&&console.error("partners 조회 오류:",c);const d=new Map((p||[]).map(r=>[r.id,r])),C=s.map(r=>({id:r.id,partner_id:r.partner_id,transaction_type:r.transaction_type||"",amount:r.amount||0,balance_before:r.balance_before||0,balance_after:r.balance_after||0,from_partner_id:r.from_partner_id||null,to_partner_id:r.to_partner_id||null,processed_by:r.processed_by||null,memo:r.memo||null,created_at:r.created_at,from_partner:r.from_partner_id?d.get(r.from_partner_id):void 0,to_partner:r.to_partner_id?d.get(r.to_partner_id):void 0}));u(C);const z=new Date().toISOString().split("T")[0],L=C.filter(r=>r.created_at.startsWith(z)),$=L.filter(r=>r.transaction_type==="deposit").reduce((r,j)=>r+Math.abs(Number(j.amount)),0),A=L.filter(r=>r.transaction_type==="withdrawal").reduce((r,j)=>r+Math.abs(Number(j.amount)),0);D({todayDeposits:$,todayWithdrawals:A,netTransfer:$-A})}catch(e){console.error("파트너 거래 내역 조회 오류:",e),X.error(a.partnerTransactions.loadFailed),u([])}finally{S(!1)}};o.useEffect(()=>{M()},[y,x,f]),o.useEffect(()=>{const e=b.channel("partner_balance_logs_changes").on("postgres_changes",{event:"*",schema:"public",table:"partner_balance_logs"},()=>{console.log("파트너 보유금 변경 감지 - 목록 새로고침"),M()}).subscribe();return()=>{b.removeChannel(e)}},[]);const R=e=>{const n={deposit:{text:a.partnerTransactions.deposit,className:"px-3 py-1 bg-gradient-to-r from-emerald-500/20 to-teal-500/20 text-emerald-400 border border-emerald-500/50 rounded-full shadow-[0_0_10px_rgba(16,185,129,0.5)]"},withdrawal:{text:a.partnerTransactions.withdrawal,className:"px-3 py-1 bg-gradient-to-r from-rose-500/20 to-red-500/20 text-rose-400 border border-rose-500/50 rounded-full shadow-[0_0_10px_rgba(244,63,94,0.5)]"},admin_adjustment:{text:a.partnerTransactions.adminAdjustment,className:"px-3 py-1 bg-gradient-to-r from-amber-500/20 to-orange-500/20 text-amber-400 border border-amber-500/50 rounded-full shadow-[0_0_10px_rgba(251,146,60,0.5)]"},commission:{text:a.partnerTransactions.commission,className:"px-3 py-1 bg-gradient-to-r from-blue-500/20 to-cyan-500/20 text-blue-400 border border-blue-500/50 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]"},refund:{text:a.partnerTransactions.refund,className:"px-3 py-1 bg-gradient-to-r from-purple-500/20 to-violet-500/20 text-purple-400 border border-purple-500/50 rounded-full shadow-[0_0_10px_rgba(168,85,247,0.5)]"}}[e]||{text:e,className:"px-3 py-1 bg-slate-500/20 text-slate-400 border border-slate-500/50 rounded-full"};return t.jsx(T,{className:n.className,children:n.text})},k=e=>{const n={system_admin:{text:a.partnerManagement.systemAdmin,className:"bg-purple-500/20 text-purple-400 border-purple-500/50"},head_office:{text:a.partnerManagement.headOffice,className:"bg-red-500/20 text-red-400 border-red-500/50"},main_office:{text:a.partnerManagement.mainOffice,className:"bg-orange-500/20 text-orange-400 border-orange-500/50"},sub_office:{text:a.partnerManagement.subOffice,className:"bg-yellow-500/20 text-yellow-400 border-yellow-500/50"},distributor:{text:a.partnerManagement.distributor,className:"bg-blue-500/20 text-blue-400 border-blue-500/50"},store:{text:a.partnerManagement.store,className:"bg-green-500/20 text-green-400 border-green-500/50"}}[e]||{text:e,className:"bg-slate-500/20 text-slate-400 border-slate-500/50"};return t.jsx(T,{className:`${n.className} border text-xs`,children:n.text})},U=[{key:"created_at",header:a.partnerTransactions.dateTime,cell:e=>{const s=new Date(e.created_at),n=s.getFullYear(),i=s.getMonth()+1,p=s.getDate(),c=s.getHours().toString().padStart(2,"0"),d=s.getMinutes().toString().padStart(2,"0");return t.jsxs("div",{className:"text-slate-400 text-sm whitespace-nowrap",children:[n,". ",i.toString().padStart(2,"0"),". ",p.toString().padStart(2,"0"),". ",c,":",d]})}},{key:"transaction_type",header:a.partnerTransactions.transactionType,cell:e=>t.jsxs("div",{className:"flex flex-col gap-1",children:[R(e.transaction_type),e.api_type&&t.jsx(T,{className:`px-2 py-0.5 text-xs ${e.api_type==="invest"?"bg-blue-500/20 text-blue-400 border-blue-500/50":"bg-purple-500/20 text-purple-400 border-purple-500/50"} border rounded-full`,children:e.api_type==="invest"?"Invest":"OroPlay"})]})},{key:"from_partner",header:a.partnerTransactions.sender,cell:e=>e.from_partner?t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("div",{className:"text-sm text-slate-200",children:e.from_partner.nickname||e.from_partner.username}),e.from_partner.partner_type&&k(e.from_partner.partner_type)]}):t.jsx("span",{className:"text-slate-600",children:"-"})},{key:"arrow",header:"",cell:()=>t.jsx("span",{className:"text-slate-500 text-lg",children:"→"})},{key:"to_partner",header:a.partnerTransactions.recipient,cell:e=>e.to_partner?t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("div",{className:"text-sm text-slate-200",children:e.to_partner.nickname||e.to_partner.username}),e.to_partner.partner_type&&k(e.to_partner.partner_type)]}):t.jsx("span",{className:"text-slate-600",children:"-"})},{key:"amount",header:a.partnerTransactions.amount,cell:e=>{const s=e.transaction_type==="deposit";return t.jsxs("div",{className:`font-mono ${s?"text-emerald-400":"text-rose-400"}`,children:[s?"+":"",Math.abs(e.amount).toLocaleString(),"원"]})}},{key:"balance_before",header:a.partnerTransactions.balanceBefore,cell:e=>t.jsxs("div",{className:"font-mono text-slate-400",children:[e.balance_before.toLocaleString(),"원"]})},{key:"balance_after",header:a.partnerTransactions.balanceAfter,cell:e=>t.jsxs("div",{className:"font-mono text-cyan-400",children:[e.balance_after.toLocaleString(),"원"]})},{key:"memo",header:a.partnerTransactions.memo,cell:e=>t.jsx("div",{className:"max-w-[250px] text-sm text-slate-400 truncate",title:e.memo||"",children:e.memo||"-"})}],Y=o.useMemo(()=>{let e=w;if(_!=="all"&&(e=e.filter(s=>s.transaction_type===_)),h){const s=h.toLowerCase();e=e.filter(n=>{const i=n.from_partner?.nickname||n.from_partner?.username||"",p=n.to_partner?.nickname||n.to_partner?.username||"",c=n.memo||"",d=n.amount.toString();return i.toLowerCase().includes(s)||p.toLowerCase().includes(s)||c.toLowerCase().includes(s)||d.includes(s)})}return e},[w,h,_]);return t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs("div",{className:"space-y-1",children:[t.jsxs("h1",{className:"text-2xl font-bold text-slate-100 flex items-center gap-2",children:[t.jsx(Z,{className:"h-6 w-6 text-cyan-400"}),a.partnerTransactions.title]}),t.jsx("p",{className:"text-muted-foreground",children:a.partnerTransactions.subtitle})]})}),t.jsxs("div",{className:"grid gap-5 md:grid-cols-3",children:[t.jsx(v,{title:a.partnerTransactions.todayDeposit,value:`${g.todayDeposits.toLocaleString()}원`,subtitle:a.partnerTransactions.depositTotal,icon:W,color:"green"}),t.jsx(v,{title:a.partnerTransactions.todayWithdrawal,value:`${g.todayWithdrawals.toLocaleString()}원`,subtitle:a.partnerTransactions.withdrawalTotal,icon:W,color:"red"}),t.jsx(v,{title:a.partnerTransactions.netTransfer,value:`${g.netTransfer.toLocaleString()}원`,subtitle:a.partnerTransactions.depositMinusWithdrawal,icon:ee,color:"cyan"})]}),t.jsxs("div",{className:"glass-card rounded-xl p-6",children:[t.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(te,{className:"h-5 w-5 text-slate-400"}),t.jsx("h3",{className:"font-semibold text-slate-100",children:a.partnerTransactions.title})]})}),t.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[t.jsxs(I,{value:y,onValueChange:q,children:[t.jsx(E,{className:"w-[140px] input-premium",children:t.jsx(O,{placeholder:a.partnerTransactions.period})}),t.jsxs(P,{className:"bg-slate-800 border-slate-700",children:[t.jsx(l,{value:"latest",children:a.partnerTransactions.latest}),t.jsx(l,{value:"oldest",children:a.partnerTransactions.oldest})]})]}),t.jsx(N,{type:"date",value:x,onChange:e=>F(e.target.value),className:"w-[160px] input-premium",placeholder:a.partnerTransactions.startDate}),t.jsx("span",{className:"text-slate-500",children:"-"}),t.jsx(N,{type:"date",value:f,onChange:e=>V(e.target.value),className:"w-[160px] input-premium",placeholder:a.partnerTransactions.endDate}),t.jsxs(I,{value:_,onValueChange:H,children:[t.jsx(E,{className:"w-[140px] input-premium",children:t.jsx(O,{placeholder:a.partnerTransactions.type})}),t.jsxs(P,{className:"bg-slate-800 border-slate-700",children:[t.jsx(l,{value:"all",children:a.partnerTransactions.allTypes}),t.jsx(l,{value:"deposit",children:a.partnerTransactions.deposit}),t.jsx(l,{value:"withdrawal",children:a.partnerTransactions.withdrawal}),t.jsx(l,{value:"admin_adjustment",children:a.partnerTransactions.adminAdjustment}),t.jsx(l,{value:"commission",children:a.partnerTransactions.commission}),t.jsx(l,{value:"refund",children:a.partnerTransactions.refund})]})]}),t.jsxs("div",{className:"flex-1 relative",children:[t.jsx(ae,{className:"absolute left-3 top-2.5 h-4 w-4 text-slate-400"}),t.jsx(N,{placeholder:a.partnerTransactions.searchPlaceholder,className:"pl-10 input-premium",value:h,onChange:e=>K(e.target.value)})]})]}),t.jsx(Q,{columns:U,data:Y,searchable:!1,loading:B,emptyMessage:a.partnerTransactions.noData,rowKey:"id"})]})]})}export{me as PartnerTransactions};
