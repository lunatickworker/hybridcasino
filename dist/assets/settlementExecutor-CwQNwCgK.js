import{s as u}from"./index-CGvwOXPh.js";import{a as S,b as P}from"./settlementCalculator-BoiNnd7Z.js";async function I(n,_,i,g,l="all"){try{const s=new Date(_).toISOString().split("T")[0],r=new Date(i).toISOString().split("T")[0],{data:d,error:m}=await u.rpc("check_settlement_exists",{p_partner_id:n,p_settlement_type:"partner_commission",p_period_start:s,p_period_end:r,p_api_filter:l});if(m)return console.error("중복 정산 체크 실패:",m),{success:!1,message:"중복 정산 체크에 실패했습니다.",error:m.message};if(d===!0)return{success:!1,message:"이미 정산이 완료된 기간입니다."};const o=await S(n,_,i,l);if(o.length===0)return{success:!1,message:"정산할 하위 파트너가 없습니다."};const t=o.reduce((e,a)=>e+a.rolling_commission,0),p=o.reduce((e,a)=>e+a.losing_commission,0),c=o.reduce((e,a)=>e+a.withdrawal_commission,0),f=t+p+c;if(f<=0)return{success:!1,message:"정산할 커미션이 0원입니다."};const y=o.map(e=>({partner_id:e.partner_id,partner_nickname:e.partner_nickname,partner_level:e.partner_level,rolling_commission:e.rolling_commission,losing_commission:e.losing_commission,withdrawal_commission:e.withdrawal_commission,total_commission:e.total_commission})),{data:h,error:w}=await u.from("settlements").insert({partner_id:n,settlement_type:"partner_commission",settlement_period:g,api_filter:l,period_start:s,period_end:r,total_bet_amount:o.reduce((e,a)=>e+a.total_bet_amount,0),total_win_amount:0,total_withdrawal_amount:o.reduce((e,a)=>e+a.total_withdrawal_amount,0),rolling_commission:t,losing_commission:p,withdrawal_commission:c,commission_amount:f,commission_rate:0,status:"completed",processed_at:new Date().toISOString(),executed_by:n,settlement_details:y}).select().single();return w?(console.error("정산 기록 생성 실패:",w),{success:!1,message:"정산 기록 생성에 실패했습니다.",error:w.message}):{success:!0,message:`정산 기록이 생성되었습니다. (총 정산액: ₩${f.toLocaleString()}, ${o.length}명)`,settlementId:h.id}}catch(s){return console.error("정산 실행 실패:",s),{success:!1,message:"정산 처리 중 오류가 발생했습니다.",error:s instanceof Error?s.message:String(s)}}}async function E(n,_,i,g,l,s="all"){try{const r=new Date(i).toISOString().split("T")[0],d=new Date(g).toISOString().split("T")[0],{data:m,error:o}=await u.rpc("check_settlement_exists",{p_partner_id:n,p_settlement_type:"integrated",p_period_start:r,p_period_end:d,p_api_filter:s});if(o)return{success:!1,message:"중복 정산 체크에 실패했습니다.",error:o.message};if(m===!0)return{success:!1,message:"이미 정산이 완료된 기간입니다."};const t=await P(n,_,i,g,s);if(t.netTotalProfit<=0)return{success:!1,message:"순수익이 0원 이하입니다. 정산할 수 없습니다."};const{data:p,error:c}=await u.from("settlements").insert({partner_id:n,settlement_type:"integrated",settlement_period:l,api_filter:s,period_start:r,period_end:d,total_bet_amount:0,total_win_amount:0,total_withdrawal_amount:0,rolling_commission:t.netRollingProfit,losing_commission:t.netLosingProfit,withdrawal_commission:t.netWithdrawalProfit,commission_amount:t.netTotalProfit,commission_rate:0,my_total_income:t.myTotalIncome,partner_total_payments:t.partnerTotalPayments,net_profit:t.netTotalProfit,status:"completed",processed_at:new Date().toISOString(),executed_by:n,settlement_details:{my_income:{rolling:t.myRollingIncome,losing:t.myLosingIncome,withdrawal:t.myWithdrawalIncome,total:t.myTotalIncome},partner_payments:{rolling:t.partnerRollingPayments,losing:t.partnerLosingPayments,withdrawal:t.partnerWithdrawalPayments,total:t.partnerTotalPayments},net_profit:{rolling:t.netRollingProfit,losing:t.netLosingProfit,withdrawal:t.netWithdrawalProfit,total:t.netTotalProfit}}}).select().single();return c?{success:!1,message:"정산 기록 생성에 실패했습니다.",error:c.message}:{success:!0,message:`통합 정산이 완료되었습니다. (순수익: ₩${t.netTotalProfit.toLocaleString()})`,settlementId:p.id}}catch(r){return console.error("통합 정산 실행 실패:",r),{success:!1,message:"통합 정산 처리 중 오류가 발생했습니다.",error:r instanceof Error?r.message:String(r)}}}export{E as a,I as e};
