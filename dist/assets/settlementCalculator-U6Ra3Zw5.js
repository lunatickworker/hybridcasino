import{s as d}from"./index-McppjVnx.js";import"./react-core-BwkdTuSg.js";import"./vendor-D410aui4.js";import"./radix-ui-omyR4zpf.js";import"./lucide-icons-CePlpqHy.js";import"./supabase-C8Oa5ukG.js";async function g(a){const o=[],e=[a];let l=[a];for(let n=0;n<5&&l.length!==0;n++){const{data:t}=await d.from("partners").select("id").in("parent_id",l);if(t&&t.length>0){const i=t.map(s=>s.id);e.push(...i),l=i}else break}if(e.length>0){const{data:n}=await d.from("users").select("id").in("referrer_id",e);n&&o.push(...n.map(t=>t.id))}return o}async function w(a,o,e,l="all"){if(a.length===0)return{totalBetAmount:0,totalLossAmount:0};let n=d.from("game_records").select("bet_amount, win_amount").in("user_id",a).gte("played_at",o).lte("played_at",e);l!=="all"&&(n=n.eq("api_type",l));const{data:t,error:i}=await n;if(i)return console.error("베팅 데이터 조회 오류:",i),{totalBetAmount:0,totalLossAmount:0};if(!t||t.length===0)return{totalBetAmount:0,totalLossAmount:0};let s=0,r=0;for(const m of t){const c=m.bet_amount||0,_=m.win_amount||0;s+=c;const u=c-_;u>0&&(r+=u)}return{totalBetAmount:s,totalLossAmount:r}}async function h(a,o,e){if(a.length===0)return 0;const{data:l,error:n}=await d.from("transactions").select("amount").in("user_id",a).eq("transaction_type","withdrawal").eq("status","approved").gte("created_at",o).lte("created_at",e);return n?(console.error("출금 데이터 조회 오류:",n),0):l?l.reduce((t,i)=>t+(i.amount||0),0):0}async function f(a,o,e,l,n="all"){try{const t=await g(a);if(t.length===0)return{partner_id:a,partner_username:o.username,partner_nickname:o.nickname,partner_level:o.level,commission_rolling:o.commission_rolling,commission_losing:o.commission_losing,withdrawal_fee:o.withdrawal_fee,total_bet_amount:0,total_loss_amount:0,total_withdrawal_amount:0,rolling_commission:0,losing_commission:0,withdrawal_commission:0,total_commission:0};const{totalBetAmount:i,totalLossAmount:s}=await w(t,e,l,n),r=await h(t,e,l),m=i*(o.commission_rolling/100),c=s*(o.commission_losing/100),_=r*(o.withdrawal_fee/100),u=m+c+_;return{partner_id:a,partner_username:o.username,partner_nickname:o.nickname,partner_level:o.level,commission_rolling:o.commission_rolling,commission_losing:o.commission_losing,withdrawal_fee:o.withdrawal_fee,total_bet_amount:i,total_loss_amount:s,total_withdrawal_amount:r,rolling_commission:m,losing_commission:c,withdrawal_commission:_,total_commission:u}}catch(t){return console.error("파트너 커미션 계산 실패:",t),{partner_id:a,partner_username:o.username,partner_nickname:o.nickname,partner_level:o.level,commission_rolling:o.commission_rolling,commission_losing:o.commission_losing,withdrawal_fee:o.withdrawal_fee,total_bet_amount:0,total_loss_amount:0,total_withdrawal_amount:0,rolling_commission:0,losing_commission:0,withdrawal_commission:0,total_commission:0}}}async function b(a,o,e,l="all"){try{const{data:n,error:t}=await d.from("partners").select("id, username, nickname, level, commission_rolling, commission_losing, withdrawal_fee").eq("parent_id",a).order("level").order("nickname");if(t)return console.error("하위 파트너 조회 오류:",t),[];if(!n||n.length===0)return[];const i=n.map(r=>f(r.id,r,o,e,l));return await Promise.all(i)}catch(n){return console.error("하위 파트너 커미션 계산 실패:",n),[]}}async function y(a,o,e,l,n="all"){try{const t=await g(a);if(t.length===0)return{rolling:0,losing:0,withdrawal:0,total:0};const{totalBetAmount:i,totalLossAmount:s}=await w(t,e,l,n),r=await h(t,e,l),m=i*(o.rolling/100),c=s*(o.losing/100),_=r*(o.withdrawal/100);return{rolling:m,losing:c,withdrawal:_,total:m+c+_}}catch(t){return console.error("내 수입 계산 실패:",t),{rolling:0,losing:0,withdrawal:0,total:0}}}async function p(a,o,e,l="all"){try{const{data:n,error:t}=await d.from("partners").select("id, nickname, commission_rolling, commission_losing, withdrawal_fee").eq("parent_id",a);if(t)return console.error("하위 파트너 조회 오류:",t),{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]};if(!n||n.length===0)return{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]};const i=n.map(_=>P(_,o,e,l)),s=await Promise.all(i);let r=0,m=0,c=0;for(const _ of s)r+=_.rolling_payment,m+=_.losing_payment,c+=_.withdrawal_payment;return{totalRolling:r,totalLosing:m,totalWithdrawal:c,total:r+m+c,details:s}}catch(n){return console.error("파트너 지급 계산 실패:",n),{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]}}}async function P(a,o,e,l="all"){try{const n=await g(a.id);if(n.length===0)return{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:0,losing_payment:0,withdrawal_payment:0,total_payment:0};const{totalBetAmount:t,totalLossAmount:i}=await w(n,o,e,l),s=await h(n,o,e),r=t*(a.commission_rolling/100),m=i*(a.commission_losing/100),c=s*(a.withdrawal_fee/100);return{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:r,losing_payment:m,withdrawal_payment:c,total_payment:r+m+c}}catch(n){return console.error("파트너 지급 계산 실패:",n),{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:0,losing_payment:0,withdrawal_payment:0,total_payment:0}}}async function R(a,o,e,l,n="all"){try{const t=await y(a,o,e,l,n),i=await p(a,e,l,n);return{myRollingIncome:t.rolling,myLosingIncome:t.losing,myWithdrawalIncome:t.withdrawal,myTotalIncome:t.total,partnerRollingPayments:i.totalRolling,partnerLosingPayments:i.totalLosing,partnerWithdrawalPayments:i.totalWithdrawal,partnerTotalPayments:i.total,netRollingProfit:t.rolling-i.totalRolling,netLosingProfit:t.losing-i.totalLosing,netWithdrawalProfit:t.withdrawal-i.totalWithdrawal,netTotalProfit:t.total-i.total}}catch(t){return console.error("통합 정산 계산 실패:",t),{myRollingIncome:0,myLosingIncome:0,myWithdrawalIncome:0,myTotalIncome:0,partnerRollingPayments:0,partnerLosingPayments:0,partnerWithdrawalPayments:0,partnerTotalPayments:0,netRollingProfit:0,netLosingProfit:0,netWithdrawalProfit:0,netTotalProfit:0}}}async function q(a,o,e){if(a.length===0)return 0;const{data:l,error:n}=await d.from("transactions").select("amount").eq("transaction_type","deposit").eq("status","pending").in("user_id",a).gte("created_at",o).lte("created_at",e);return n?(console.error("만충금 조회 오류:",n),0):l?l.reduce((t,i)=>t+Number(i.amount),0):0}export{b as calculateChildPartnersCommission,R as calculateIntegratedSettlement,y as calculateMyIncome,f as calculatePartnerCommission,p as calculatePartnerPayments,q as calculatePendingDeposits,w as getBettingStats,g as getDescendantUserIds,h as getWithdrawalAmount};
