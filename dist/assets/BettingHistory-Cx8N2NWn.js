import{r as d,j as s}from"./react-core-BwkdTuSg.js";import{a as z,s as l,B as K,m as U,S as V,p as Y,q as G,r as Q,t as y,I as X,i as R,Z}from"./index-McppjVnx.js";import{D as J}from"./DataTable-w2U-jZDQ.js";import{k as h}from"./vendor-D410aui4.js";import{M as x}from"./MetricCard-DnMFhTGK.js";import{d as S,R as ee,aq as te}from"./lucide-icons-CePlpqHy.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";import"./table-CKCHMZ5m.js";function me({user:u}){const{t:a}=z(),[$,L]=d.useState(!1),[_,I]=d.useState(!1),[C,A]=d.useState([]),[f,F]=d.useState("all"),[b,M]=d.useState(""),k=n=>{if(!n)return"-";const e=new Date(n),t=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),c=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),g=String(e.getSeconds()).padStart(2,"0");return`${t}ë…„${o}ì›”${r}ì¼ ${c}:${i}:${g}`},P=n=>{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate());switch(n){case"today":return{start:t.toISOString(),end:e.toISOString()};case"week":const o=new Date(t);return o.setDate(t.getDate()-7),{start:o.toISOString(),end:e.toISOString()};case"month":const r=new Date(t);return r.setMonth(t.getMonth()-1),{start:r.toISOString(),end:e.toISOString()};default:return null}},T=async()=>{try{console.log("ðŸ”„ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œìž‘"),I(!0),await Z(u),await new Promise(n=>setTimeout(n,1e3)),await w(),h.success(a.bettingHistory.refreshSuccess)}catch(n){console.error("âŒ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:",n),h.error(a.bettingHistory.refreshFailed)}finally{I(!1)}},w=async()=>{try{console.log("ðŸ”„ ë² íŒ… ë°ì´í„° ë¡œë“œ ì‹œìž‘");const n=P(f);let e=[];if(u.level===1){const{data:c}=await l.from("partners").select("id");e=c?.map(i=>i.id)||[]}else{e=[u.id];const{data:c}=await l.from("partners").select("id").eq("parent_id",u.id),i=c?.map(g=>g.id)||[];if(e.push(...i),i.length>0){const{data:g}=await l.from("partners").select("id").in("parent_id",i),v=g?.map(j=>j.id)||[];if(e.push(...v),v.length>0){const{data:j}=await l.from("partners").select("id").in("parent_id",v),H=j?.map(N=>N.id)||[];if(e.push(...H),H.length>0){const{data:N}=await l.from("partners").select("id").in("parent_id",H),D=N?.map(B=>B.id)||[];if(e.push(...D),D.length>0){const{data:B}=await l.from("partners").select("id").in("parent_id",D),q=B?.map(W=>W.id)||[];e.push(...q)}}}}}console.log("ðŸ‘¥ Child partner IDs count:",e.length);let t=l.from("game_records").select("*");if(u.level===1)e.length>0&&(t=t.in("partner_id",e)),console.log("ðŸ” System Admin: Query all partner data");else{const{data:c}=await l.from("users").select("id").in("referrer_id",e),i=c?.map(g=>g.id)||[];if(console.log("ðŸ‘¤ í•˜ìœ„ íšŒì› ID ê°œìˆ˜:",i.length),i.length>0)t=t.in("user_id",i);else{console.log("âš ï¸ í•˜ìœ„ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤."),A([]);return}}n&&(t=t.gte("played_at",n.start).lte("played_at",n.end)),t=t.order("played_at",{ascending:!1}).order("external_txid",{ascending:!1}).limit(1e3);const{data:o,error:r}=await t;if(r)throw console.error("âŒ ë² íŒ… ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:",r),r;console.log("âœ… ë² íŒ… ë°ì´í„° ë¡œë“œ ì„±ê³µ:",o?.length||0,"ê±´"),o&&o.length>0&&console.log("ðŸ“‹ ì²« ë²ˆì§¸ ë ˆì½”ë“œ:",o[0]),A(o||[])}catch(n){console.error("âŒ ë² íŒ… ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:",n),h.error(a.bettingHistory.loadFailed)}},E=()=>{try{const n=[["TX ID",a.common.username,a.bettingHistory.gameName,a.bettingHistory.provider,a.bettingHistory.betAmount,a.bettingHistory.winAmount,a.bettingHistory.balanceBefore,a.bettingHistory.balanceAfter,a.bettingHistory.profitLoss,a.bettingHistory.playTime].join(","),...m.map(r=>{const c=parseFloat(r.win_amount?.toString()||"0")-parseFloat(r.bet_amount?.toString()||"0");return[r.external_txid,r.username,r.game_title||`Game ${r.game_id}`,r.provider_name||`Provider ${r.provider_id}`,r.bet_amount,r.win_amount,r.balance_before,r.balance_after,c,k(r.played_at)].join(",")})].join(`
`),e=new Blob(["\uFEFF"+n],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),o=URL.createObjectURL(e);t.setAttribute("href",o),t.setAttribute("download",`betting_history_${f}_${new Date().toISOString().split("T")[0]}.csv`),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t),h.success(a.bettingHistory.downloadSuccess)}catch(n){console.error("ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:",n),h.error(a.bettingHistory.downloadFailed)}};d.useEffect(()=>{L(!0),w().finally(()=>L(!1))},[f]),d.useEffect(()=>{console.log("ðŸ”Œ Realtime êµ¬ë… ì‹œìž‘");const n=l.channel("betting-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"game_records"},e=>{console.log("ðŸŽ² ì‹ ê·œ ë² íŒ… ë°ì´í„° ê°ì§€:",e),w()}).subscribe(e=>{console.log("ðŸ“¡ Realtime êµ¬ë… ìƒíƒœ:",e)});return()=>{console.log("ðŸ”Œ Realtime êµ¬ë… í•´ì œ"),l.removeChannel(n)}},[]);const m=d.useMemo(()=>C.filter(n=>{if(!b)return!0;const e=b.toLowerCase();return n.username?.toLowerCase().includes(e)||n.game_title?.toLowerCase().includes(e)||n.provider_name?.toLowerCase().includes(e)||n.external_txid?.toString().includes(e)}),[C,b]),p=d.useMemo(()=>{if(m.length>0){const n=m.reduce((t,o)=>t+parseFloat(o.bet_amount?.toString()||"0"),0),e=m.reduce((t,o)=>t+parseFloat(o.win_amount?.toString()||"0"),0);return{totalBets:m.length,totalBetAmount:n,totalWinAmount:e,netProfit:e-n}}else return{totalBets:0,totalBetAmount:0,totalWinAmount:0,netProfit:0}},[m]),O=[{key:"username",header:a.common.username,render:(n,e)=>s.jsx("span",{className:"text-blue-300 font-medium",children:e?.username})},{key:"game_title",header:a.bettingHistory.gameName,render:(n,e)=>s.jsx("span",{className:"text-slate-200",children:e?.game_title||"Korean Speed Baccarat A"})},{key:"provider",header:a.bettingHistory.provider,render:(n,e)=>s.jsx(K,{variant:"secondary",className:"bg-indigo-500/20 text-indigo-300 border-indigo-400/30",children:e?.provider_name||"Evolution"})},{key:"bet_amount",header:a.bettingHistory.betAmount,render:(n,e)=>{const t=Number(e?.bet_amount||0);return t===0?s.jsx("span",{className:"text-slate-500",children:"Betting..."}):s.jsxs("span",{className:"text-orange-400 font-semibold",children:["â‚©",t.toLocaleString()]})}},{key:"win_amount",header:a.bettingHistory.winAmount,render:(n,e)=>{const t=Number(e?.win_amount||0);return t===0?s.jsx("span",{className:"text-slate-500",children:"Betting..."}):s.jsxs("span",{className:"text-emerald-400 font-semibold",children:["â‚©",t.toLocaleString()]})}},{key:"balance_before",header:a.bettingHistory.balanceBefore,render:(n,e)=>s.jsxs("span",{className:"text-slate-300",children:["â‚©",Number(e?.balance_before||0).toLocaleString()]})},{key:"balance_after",header:a.bettingHistory.balanceAfter,render:(n,e)=>s.jsxs("span",{className:"text-slate-300",children:["â‚©",Number(e?.balance_after||0).toLocaleString()]})},{key:"profit",header:a.bettingHistory.profitLoss,render:(n,e)=>{if(!e)return s.jsx("span",{children:"-"});const t=Number(e.win_amount||0)-Number(e.bet_amount||0),o=t>0?"text-green-400":t<0?"text-red-400":"text-slate-400",r=t>0?"bg-green-500/10":t<0?"bg-red-500/10":"";return s.jsxs("span",{className:`${o} ${r} px-2 py-1 rounded font-bold`,children:[t>0?"+":"","â‚©",t.toLocaleString()]})}},{key:"played_at",header:a.bettingHistory.providerTime,render:(n,e)=>s.jsx("span",{className:"text-xs text-slate-400",children:k(e?.played_at)})}];return $?s.jsx(U,{}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[s.jsx(x,{title:a.bettingHistory.totalBets,value:p.totalBets.toLocaleString(),icon:S,color:"purple"}),s.jsx(x,{title:a.bettingHistory.totalBetAmount,value:`â‚©${p.totalBetAmount.toLocaleString()}`,icon:S,color:"red"}),s.jsx(x,{title:a.bettingHistory.totalWinAmount,value:`â‚©${p.totalWinAmount.toLocaleString()}`,icon:S,color:"green"}),s.jsx(x,{title:a.bettingHistory.netProfit,value:`â‚©${p.netProfit.toLocaleString()}`,icon:S,color:p.netProfit>=0?"green":"red"})]}),s.jsxs("div",{className:"flex flex-col md:flex-row gap-4 items-center justify-between",children:[s.jsxs("div",{className:"flex gap-2 items-center w-full md:w-auto flex-wrap",children:[s.jsxs(V,{value:f,onValueChange:F,children:[s.jsx(Y,{className:"w-[140px]",children:s.jsx(G,{placeholder:a.bettingHistory.periodSelection})}),s.jsxs(Q,{children:[s.jsx(y,{value:"all",children:a.bettingHistory.all}),s.jsx(y,{value:"today",children:a.bettingHistory.today}),s.jsx(y,{value:"week",children:a.bettingHistory.last7Days}),s.jsx(y,{value:"month",children:a.bettingHistory.last30Days})]})]}),s.jsx(X,{placeholder:a.bettingHistory.searchPlaceholder,value:b,onChange:n=>M(n.target.value),className:"w-full md:w-[250px]"})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(R,{onClick:T,variant:"outline",size:"sm",disabled:_,children:[s.jsx(ee,{className:`h-4 w-4 mr-2 ${_?"animate-spin":""}`}),_?a.common.refreshing:a.common.refresh]}),s.jsxs(R,{onClick:E,variant:"outline",size:"sm",children:[s.jsx(te,{className:"h-4 w-4 mr-2"}),a.bettingHistory.csvDownload]})]})]}),s.jsx(J,{data:m,columns:O,emptyMessage:a.bettingHistory.noBettingRecords,enableSearch:!1,pageSize:20})]})}export{me as BettingHistory};
