import{r as d,j as r}from"./react-core-BwkdTuSg.js";import{a as de,B as E,h as x,s as m,A as z,D as q}from"./index-Be3DOFuy.js";import{D as me}from"./DataTable-CJW7Gi2n.js";import{k as u}from"./vendor-D410aui4.js";import{A as R,a as K,b as G,c as V,d as H,e as F}from"./AdminDialog-6C2SLoqm.js";import{M as N}from"./MetricCard-DF34t905.js";import{al as ue,am as fe,R as Q,an as W,U as he,a9 as ge,j as pe,V as _e}from"./lucide-icons-D2Pw2Rdn.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";import"./table-C50RqMyg.js";const xe={1:"ë§ˆì´í¬ë¡œê²Œì´ë°",17:"í”Œë ˆì´ì•¤ê³ ",20:"CQ9 ê²Œì´ë°",21:"ì œë„¤ì‹œìŠ¤ ê²Œì´ë°",22:"í•˜ë°”ë„¤ë¡œ",23:"ê²Œì„ì•„íŠ¸",27:"í”Œë ˆì´í…",38:"ë¸”ë£¨í”„ë¦°íŠ¸",39:"ë¶€ìš´ê³ ",40:"ë“œë¼êµ°ì†Œí”„íŠ¸",41:"ì—˜í¬ ìŠ¤íŠœë””ì˜¤",47:"ë“œë¦¼í…Œí¬",51:"ì¹¼ëŒë°” ê²Œì„ì¦ˆ",52:"ëª¨ë¹Œë¡¯",53:"ë…¸ë¦¬ë°‹ ì‹œí‹°",55:"OMI ê²Œì´ë°",56:"ì›í„°ì¹˜",59:"í”Œë ˆì´ìŠ¨",60:"í‘¸ì‰¬ ê²Œì´ë°",61:"í€µìŠ¤í•€",62:"RTG ìŠ¬ë¡¯",63:"ë¦¬ë³¼ë²„ ê²Œì´ë°",65:"ìŠ¬ë¡¯ë°€",66:"ìŠ¤í”¼ì–´í—¤ë“œ",70:"ì¬ë”í‚¥",72:"ìš°í›„ ê²Œì„ì¦ˆ",74:"ë¦´ë ‰ìŠ¤ ê²Œì´ë°",75:"ë„·ì—”íŠ¸",76:"ë ˆë“œíƒ€ì´ê±°",87:"PGì†Œí”„íŠ¸",88:"í”Œë ˆì´ìŠ¤íƒ€",90:"ë¹…íƒ€ì„ê²Œì´ë°",300:"í”„ë¼ê·¸ë§ˆí‹± í”Œë ˆì´",410:"ì—ë³¼ë£¨ì…˜ ê²Œì´ë°",77:"ë§ˆì´í¬ë¡œê²Œì´ë° ë¼ì´ë¸Œ",2:"Vivo ê²Œì´ë°",30:"ì•„ì‹œì•„ ê²Œì´ë°",78:"í”„ë¼ê·¸ë§ˆí‹± í”Œë ˆì´ ë¼ì´ë¸Œ",86:"ì„¹ì‹œê²Œì´ë°",11:"ë¹„ë¹„ì•„ì´ì—”",28:"ë“œë¦¼ê²Œì„",89:"ì˜¤ë¦¬ì—”íƒˆê²Œì„",91:"ë³´íƒ€",44:"ì´ì£¼ê¸°",85:"í”Œë ˆì´í… ë¼ì´ë¸Œ",0:"ì œë„¤ëŸ´ ì¹´ì§€ë…¸"},be={41e4:"ì—ë³¼ë£¨ì…˜ ë¼ì´ë¸Œì¹´ì§€ë…¸",77060:"ë§ˆì´í¬ë¡œê²Œì´ë° ë¼ì´ë¸Œì¹´ì§€ë…¸",2029:"Vivo ë¼ì´ë¸Œì¹´ì§€ë…¸",3e4:"ì•„ì‹œì•„ê²Œì´ë° ë¼ì´ë¸Œì¹´ì§€ë…¸",78001:"í”„ë¼ê·¸ë§ˆí‹± ë¼ì´ë¸Œì¹´ì§€ë…¸",86001:"ì„¹ì‹œê²Œì´ë° ë¼ì´ë¸Œì¹´ì§€ë…¸",11e3:"ë¹„ë¹„ì•„ì´ì—” ë¼ì´ë¸Œì¹´ì§€ë…¸",28e3:"ë“œë¦¼ê²Œì„ ë¼ì´ë¸Œì¹´ì§€ë…¸",89e3:"ì˜¤ë¦¬ì—”íƒˆê²Œì„ ë¼ì´ë¸Œì¹´ì§€ë…¸",91e3:"ë³´íƒ€ ë¼ì´ë¸Œì¹´ì§€ë…¸",44006:"ì´ì£¼ê¸° ë¼ì´ë¸Œì¹´ì§€ë…¸",85036:"í”Œë ˆì´í… ë¼ì´ë¸Œì¹´ì§€ë…¸",0:"ì œë„¤ëŸ´ ë¼ì´ë¸Œì¹´ì§€ë…¸"};function Me({user:b}){const{t}=de(),[c,Y]=d.useState([]),[D,C]=d.useState(!0),[M,A]=d.useState(!1),[j,B]=d.useState(null),[J,y]=d.useState(!1),[I,L]=d.useState(null),[ve,X]=d.useState(0),[f,w]=d.useState(new Set),[Z,k]=d.useState(!1);d.useEffect(()=>{const e=setInterval(()=>X(s=>s+1),1e3);return()=>clearInterval(e)},[]);const S=async(e=!1)=>{try{e?A(!0):c.length===0&&C(!0);let s=m.from("game_launch_sessions").select(`
          id,
          session_id,
          user_id,
          game_id,
          balance_before,
          launched_at,
          last_activity_at,
          users!inner(
            id,
            username,
            nickname,
            balance,
            ip_address,
            device_info,
            referrer_id
          )
        `).eq("status","active").order("last_activity_at",{ascending:!1});if(b.level!==1){const{data:a}=await m.from("partners").select("id").or(`parent_id.eq.${b.id},id.eq.${b.id}`),l=a?.map(_=>_.id)||[b.id];s=s.in("users.referrer_id",l)}const{data:n,error:o}=await s;if(o)throw o;const i=[...new Set((n||[]).map(a=>a.game_id).filter(Boolean))];let h={};if(i.length>0){const{data:a}=await m.from("games").select("id, name, provider_id, game_providers(name)").in("id",i);a&&(h=Object.fromEntries(a.map(l=>[l.id,l])))}const p=(n||[]).map(a=>{const l=a.users.ip_address||"-";let _="PC";if(a.users.device_info){const v=a.users.device_info;if(v.device==="Mobile"||v.device==="mobile")_="Mobile";else if(v.platform){const g=String(v.platform).toLowerCase();(g.includes("android")||g.includes("iphone")||g.includes("ipad")||g.includes("mobile"))&&(_="Mobile")}else if(v.userAgent){const g=String(v.userAgent).toLowerCase();(g.includes("mobile")||g.includes("android")||g.includes("iphone")||g.includes("ipad"))&&(_="Mobile")}}const P=Math.floor(a.game_id/1e3),ce=xe[P]||`Provider ${P}`;let U=be[a.game_id];return U||(U=h[a.game_id]?.name||`Game ${a.game_id}`),{id:a.id,session_id:a.session_id,user_id:a.users.id,username:a.users.username,nickname:a.users.nickname||a.users.username,game_name:U,provider_name:ce,balance_before:Number(a.balance_before)||0,current_balance:Number(a.users.balance)||0,device_type:_,ip_address:l,launched_at:a.launched_at,last_activity_at:a.last_activity_at}});Y(p)}catch(s){console.error("ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:",s),e&&u.error("ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨")}finally{C(!1),A(!1)}};d.useEffect(()=>{console.log("ğŸ”„ OnlineUsers 30ì´ˆ íƒ€ì´ë¨¸ ì‹œì‘"),S();const e=setInterval(()=>{console.log("â° 30ì´ˆ ê²½ê³¼ - ì„¸ì…˜ ìë™ ì¢…ë£Œ ì²´í¬ ì‹¤í–‰"),S()},3e4);return()=>{console.log("ğŸ›‘ OnlineUsers 30ì´ˆ íƒ€ì´ë¨¸ ì¢…ë£Œ"),clearInterval(e)}},[b.id,b.partner_type]),d.useEffect(()=>{const e=async()=>{try{const n=new Date(Date.now()-144e5).toISOString(),{data:o,error:i}=await m.from("game_launch_sessions").delete().in("status",["ended","force_ended"]).lt("ended_at",n).select("id");i?console.error("ì„¸ì…˜ ì •ë¦¬ ì˜¤ë¥˜:",i):o&&o.length>0&&console.log(`ğŸ—‘ï¸ ${o.length}ê°œ ì˜¤ë˜ëœ ì„¸ì…˜ ì‚­ì œ (4ì‹œê°„ ê²½ê³¼)`)}catch(n){console.error("ì„¸ì…˜ ì •ë¦¬ ì‹¤í–‰ ì˜¤ë¥˜:",n)}};e();const s=setInterval(e,3600*1e3);return()=>clearInterval(s)},[]);const ee=e=>{const s=new Date(e).getTime(),n=Date.now(),o=Math.max(0,n-s);if(isNaN(o))return"0ë¶„";const i=Math.floor(o/1e3/60);if(i<60)return`${i}ë¶„`;const h=Math.floor(i/60),p=i%60;return`${h}ì‹œê°„ ${p}ë¶„`},se=async e=>{try{L(e.user_id);const s=await z(b.id);if(!s){u.error("API ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");return}const n=await q(s.opcode,e.username,s.token,s.secret_key);n&&n.success&&typeof n.balance=="number"?(await m.from("users").update({balance:n.balance}).eq("id",e.user_id),u.success("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì™„ë£Œ"),S()):u.error(n?.error||"ë³´ìœ ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨")}catch(s){console.error("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì˜¤ë¥˜:",s),u.error("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì‹¤íŒ¨")}finally{L(null)}},T=async e=>{try{console.log(`ğŸ”„ [ë³´ìœ ê¸ˆ ë™ê¸°í™”] ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì‚¬ìš©ì ë³´ìœ ê¸ˆ ë™ê¸°í™” ì‹œì‘: user_id=${e}`);const s=await m.from("users").select("username, referrer_id").eq("id",e).single();if(!s.data){console.error(`âŒ [ë³´ìœ ê¸ˆ ë™ê¸°í™”] ì‚¬ìš©ì ì •ë³´ ì—†ìŒ: user_id=${e}`);return}let n=s.data.referrer_id;if(!n){console.error(`âŒ [ë³´ìœ ê¸ˆ ë™ê¸°í™”] referrer_id ì—†ìŒ: user_id=${e}`);return}let o=n,i=0;const h=10;for(;i<h;){const{data:l,error:_}=await m.from("partners").select("id, parent_id, level").eq("id",n).single();if(_||!l){console.error(`âŒ [ë³´ìœ ê¸ˆ ë™ê¸°í™”] íŒŒíŠ¸ë„ˆ ì •ë³´ ì—†ìŒ: partner_id=${n}`);break}if(l.level===1||!l.parent_id){o=l.id,console.log(`   âœ… ìµœìƒìœ„ Lv1 íŒŒíŠ¸ë„ˆ ì°¾ìŒ: ${o} (level: ${l.level})`);break}n=l.parent_id,i++}if(i>=h){console.error("âŒ [ë³´ìœ ê¸ˆ ë™ê¸°í™”] ìµœìƒìœ„ íŒŒíŠ¸ë„ˆ ì°¾ê¸° ì‹¤íŒ¨ (ë¬´í•œ ë£¨í”„ ë°©ì§€)");return}const p=await z(o);if(!p){console.error(`âŒ [ë³´ìœ ê¸ˆ ë™ê¸°í™”] API ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: partner_id=${o}`);return}console.log(`   ğŸ“ ì‚¬ìš© credential: partner_id=${o}`);const a=await q(p.opcode,s.data.username,p.token,p.secret_key);a&&a.success&&typeof a.balance=="number"?(await m.from("users").update({balance:a.balance}).eq("id",e),console.log(`âœ… [ë³´ìœ ê¸ˆ ë™ê¸°í™”] ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë³´ìœ ê¸ˆ ë™ê¸°í™” ì™„ë£Œ: ${e}, balance=${a.balance}`)):console.error(a?.error||"ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë³´ìœ ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨")}catch(s){console.error(`âŒ [ë³´ìœ ê¸ˆ ë™ê¸°í™”] ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë³´ìœ ê¸ˆ ë™ê¸°í™” ì˜¤ë¥˜: user_id=${e}`,s)}},re=async()=>{if(j)try{const{error:e}=await m.from("game_launch_sessions").update({status:"force_ended",ended_at:new Date().toISOString()}).eq("id",j.id);if(e){console.error("ì„¸ì…˜ ì¢…ë£Œ ì˜¤ë¥˜:",e),u.error(`ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨: ${e.message}`);return}console.log("ğŸ’° [ê°•ì œ ì¢…ë£Œ] ë³´ìœ ê¸ˆ ë™ê¸°í™” ì‹œì‘:",j.user_id),T(j.user_id).catch(s=>{console.error("âŒ [ê°•ì œ ì¢…ë£Œ] ë³´ìœ ê¸ˆ ë™ê¸°í™” ì‹¤íŒ¨:",s)}),u.success("ì„¸ì…˜ ê°•ì œ ì¢…ë£Œ ì™„ë£Œ"),y(!1),B(null),await S()}catch(e){console.error("ê°•ì œ ì¢…ë£Œ ì˜¤ë¥˜:",e),u.error("ê°•ì œ ì¢…ë£Œ ì‹¤íŒ¨")}},ne=async()=>{if(f.size!==0)try{const e=Array.from(f),{data:s}=await m.from("game_launch_sessions").select("id, user_id").in("id",e),{error:n}=await m.from("game_launch_sessions").update({status:"force_ended",ended_at:new Date().toISOString()}).in("id",e);if(n){console.error("ì¼ê´„ ì¢…ë£Œ ì˜¤ë¥˜:",n),u.error(`ì¼ê´„ ì¢…ë£Œ ì‹¤íŒ¨: ${n.message}`);return}if(s&&s.length>0){console.log(`ğŸ’° [ì¼ê´„ ê°•ì œ ì¢…ë£Œ] ${s.length}ëª… ë³´ìœ ê¸ˆ ë™ê¸°í™” ì‹œì‘`);for(const o of s)T(o.user_id).catch(i=>{console.error(`âŒ [ì¼ê´„ ê°•ì œ ì¢…ë£Œ] ë³´ìœ ê¸ˆ ë™ê¸°í™” ì‹¤íŒ¨ (${o.user_id}):`,i)})}u.success(`${f.size}ê°œ ì„¸ì…˜ ê°•ì œ ì¢…ë£Œ ì™„ë£Œ`),k(!1),w(new Set),await S()}catch(e){console.error("ì¼ê´„ ê°•ì œ ì¢…ë£Œ ì˜¤ë¥˜:",e),u.error("ì¼ê´„ ê°•ì œ ì¢…ë£Œ ì‹¤íŒ¨")}},ae=e=>{w(s=>{const n=new Set(s);return n.has(e)?n.delete(e):n.add(e),n})},te=()=>{f.size===c.length?w(new Set):w(new Set(c.map(e=>e.id)))},oe=c.length,ie=c.reduce((e,s)=>e+s.current_balance,0),$=c.reduce((e,s)=>e+(s.current_balance-s.balance_before),0);let O=0;if(c.length>0){const e=Date.now(),s=c.reduce((n,o)=>{const i=new Date(o.launched_at).getTime(),h=Math.max(0,e-i);return n+h/1e3/60},0);O=Math.floor(s/c.length)}const le=[{key:"checkbox",header:r.jsx("input",{type:"checkbox",checked:f.size===c.length&&c.length>0,onChange:te,className:"w-4 h-4 rounded border-slate-600 bg-slate-700 text-purple-500 focus:ring-purple-500 focus:ring-offset-slate-900"}),render:(e,s)=>r.jsx("input",{type:"checkbox",checked:f.has(s.id),onChange:()=>ae(s.id),className:"w-4 h-4 rounded border-slate-600 bg-slate-700 text-purple-500 focus:ring-purple-500 focus:ring-offset-slate-900"})},{key:"username",header:t.common.username,sortable:!0},{key:"nickname",header:t.common.nickname,sortable:!0},{key:"game_name",header:t.common.game,sortable:!0,render:(e,s)=>r.jsxs("div",{className:"space-y-1",children:[r.jsx("div",{className:"text-slate-200",children:e}),r.jsx(E,{variant:"outline",className:"bg-emerald-500/10 text-emerald-400 border-emerald-500/30",children:s.provider_name})]})},{key:"balance_before",header:t.onlineUsers.startingBalance,sortable:!0,render:e=>r.jsxs("span",{className:"font-mono text-slate-300",children:["â‚©",e.toLocaleString()]})},{key:"current_balance",header:t.onlineUsers.currentBalance,sortable:!0,render:(e,s)=>{const n=e-s.balance_before,o=n>=0?"text-emerald-400":"text-red-400",i=n>=0?"+":"";return r.jsxs("div",{className:"space-y-1",children:[r.jsxs("div",{className:"font-mono text-slate-200",children:["â‚©",e.toLocaleString()]}),n!==0&&r.jsxs("div",{className:`text-xs font-mono ${o}`,children:[i,"â‚©",n.toLocaleString()]})]})}},{key:"device_type",header:t.onlineUsers.deviceType,render:e=>r.jsxs(E,{variant:e==="Mobile"?"default":"secondary",className:"gap-1",children:[e==="Mobile"?r.jsx(ue,{className:"w-3 h-3"}):r.jsx(fe,{className:"w-3 h-3"}),e]})},{key:"ip_address",header:t.onlineUsers.ipAddress,sortable:!0,render:e=>r.jsx("span",{className:"text-slate-300 font-mono text-xs",children:e})},{key:"launched_at",header:t.onlineUsers.connectionTime,render:e=>r.jsx("span",{className:"text-slate-300",children:ee(e)})},{key:"actions",header:t.common.actions,render:(e,s)=>r.jsxs("div",{className:"flex items-center gap-2 justify-center",children:[r.jsx(x,{variant:"ghost",size:"sm",onClick:()=>se(s),disabled:I===s.user_id,className:"text-slate-400 hover:text-slate-200",children:r.jsx(Q,{className:`w-3 h-3 ${I===s.user_id?"animate-spin":""}`})}),r.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{B(s),y(!0)},className:"bg-red-500/10 text-red-400 hover:bg-red-500/20 hover:text-red-300",children:r.jsx(W,{className:"w-3 h-3"})})]})}];return r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("h2",{className:"text-2xl font-bold text-slate-100",children:t.onlineUsers.title}),r.jsx("p",{className:"text-sm text-slate-400 mt-1",children:t.onlineUsers.subtitle})]}),r.jsxs("div",{className:"flex items-center gap-3",children:[f.size>0&&r.jsxs(x,{variant:"destructive",onClick:()=>k(!0),className:"bg-red-500/10 text-red-400 hover:bg-red-500/20 hover:text-red-300 border border-red-500/30",children:[r.jsx(W,{className:"w-4 h-4 mr-2"}),"ì„ íƒí•œ ê²Œì„ ì¢…ë£Œ (",f.size,")"]}),r.jsxs(x,{onClick:()=>S(!0),disabled:D||M,children:[r.jsx(Q,{className:`w-4 h-4 mr-2 ${M?"animate-spin":""}`}),t.onlineUsers.refresh]})]})]}),r.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[r.jsx(N,{title:t.onlineUsers.onlineUsersTitle,value:`${oe}${t.onlineUsers.people}`,subtitle:t.onlineUsers.realtimeConnections,icon:he,color:"purple"}),r.jsx(N,{title:t.onlineUsers.totalGameBalance,value:`â‚©${ie.toLocaleString()}`,subtitle:t.onlineUsers.gameInternalBalance,icon:ge,color:"amber"}),r.jsx(N,{title:t.onlineUsers.totalProfitLoss,value:`â‚©${$.toLocaleString()}`,subtitle:$>=0?t.onlineUsers.userProfit:t.onlineUsers.userLoss,icon:pe,color:$>=0?"green":"red"}),r.jsx(N,{title:t.onlineUsers.averageSession,value:`${O}${t.onlineUsers.minutes}`,subtitle:t.onlineUsers.averageConnectionTime,icon:_e,color:"cyan"})]}),r.jsx(me,{data:c,columns:le,loading:D,emptyMessage:t.onlineUsers.noOnlineUsers}),r.jsx(R,{open:J,onOpenChange:y,children:r.jsxs(K,{children:[r.jsxs(G,{children:[r.jsx(V,{children:"ì„¸ì…˜ ê°•ì œ ì¢…ë£Œ"}),r.jsxs(H,{children:[j?.username,"(",j?.nickname,") ë‹˜ì˜ ì„¸ì…˜ì„ ê°•ì œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"]})]}),r.jsxs(F,{children:[r.jsx(x,{variant:"outline",onClick:()=>y(!1),children:"ì·¨ì†Œ"}),r.jsx(x,{variant:"destructive",onClick:re,children:"ê°•ì œ ì¢…ë£Œ"})]})]})}),r.jsx(R,{open:Z,onOpenChange:k,children:r.jsxs(K,{children:[r.jsxs(G,{children:[r.jsx(V,{children:"ì„ íƒí•œ ê²Œì„ ì¼ê´„ ì¢…ë£Œ"}),r.jsxs(H,{children:["ì„ íƒí•œ ",f.size,"ê°œì˜ ê²Œì„ ì„¸ì…˜ì„ ëª¨ë‘ ê°•ì œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"]})]}),r.jsxs(F,{children:[r.jsx(x,{variant:"outline",onClick:()=>k(!1),children:"ì·¨ì†Œ"}),r.jsxs(x,{variant:"destructive",onClick:ne,children:[f.size,"ê°œ ê°•ì œ ì¢…ë£Œ"]})]})]})})]})}export{Me as OnlineUsers};
