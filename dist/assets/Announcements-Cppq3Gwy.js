import{j as e,r as o}from"./react-core-BwkdTuSg.js";import{a as se,o as te,s as x,B as N,S as _,p as y,r as w,t as r,i as j,L as m,I as h,q as A,A as ae,m as ne}from"./index-McppjVnx.js";import{D as le}from"./DataTable-w2U-jZDQ.js";import{A as re,f as ce,a as ie,b as oe,c as de,d as ue}from"./AdminDialog-D_QT-Qbt.js";import{S as me}from"./switch-CD3uV01h.js";import{k as d}from"./vendor-D410aui4.js";import{B as T,n as xe,_ as pe,ag as he,N as ge,ax as B,a2 as ve,X as je,K as be,ay as fe,w as Ne}from"./lucide-icons-CePlpqHy.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";import"./table-CKCHMZ5m.js";function Fe({user:b}){const{t:s}=se();if(b.level>5)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(T,{className:"h-12 w-12 text-yellow-500 mx-auto"}),e.jsx("p",{className:"text-muted-foreground",children:s.announcements.accessDenied})]})});const[z,F]=o.useState(!0),[I,U]=o.useState(!1),[R,P]=o.useState([]),[C,V]=o.useState("all"),[S,O]=o.useState("all"),[g,K]=o.useState(""),[W,D]=o.useState(!1),[p,q]=o.useState(null),[l,i]=o.useState({title:"",content:"",image_url:"",is_popup:!1,target_audience:"users",target_level:"",status:"active",display_order:0,start_date:"",end_date:""}),[L,k]=o.useState(null),{sendMessage:E}=te();o.useEffect(()=>{const t=x.channel("announcements-changes").on("postgres_changes",{event:"*",schema:"public",table:"announcements"},a=>{console.log(`ðŸ”” ${s.announcements.consoleLog}`,a),f()}).subscribe();return()=>{x.removeChannel(t)}},[]);const H=async t=>{if(!t)return null;const a=t.name.split(".").pop(),u=`announcements/${`${b.id}_${Date.now()}.${a}`}`;try{U(!0);const{data:n,error:v}=await x.storage.from("announcements-images").upload(u,t,{cacheControl:"3600",upsert:!1});if(v)throw v;const{data:{publicUrl:ee}}=x.storage.from("announcements-images").getPublicUrl(u);return ee}catch(n){return console.error(`${s.announcements.imageUploadError}`,n),d.error(s.announcements.imageUploadFailed),null}finally{U(!1)}},M=async t=>{const a=t.target.files?.[0];if(!a)return;if(a.size>5*1024*1024){d.error(s.announcements.imageSizeError);return}if(!a.type.startsWith("image/")){d.error(s.announcements.imageTypeError);return}const c=await H(a);c&&(k(c),i(u=>({...u,image_url:c})),d.success(s.announcements.imageUploadSuccess))},X=()=>{k(null),i(t=>({...t,image_url:""}))},f=async()=>{try{F(!0);let t=x.from("announcements").select(`
          *,
          partners!announcements_partner_id_fkey(username)
        `);b.level>1&&(t=t.eq("partner_id",b.id)),C!=="all"&&(t=t.eq("status",C)),S!=="all"&&(t=t.eq("target_audience",S)),g&&(t=t.or(`title.ilike.%${g}%,content.ilike.%${g}%`));const{data:a,error:c}=await t.order("display_order",{ascending:!1}).order("created_at",{ascending:!1});if(c)throw c;const u=(a||[]).map(n=>({id:n.id,partner_id:n.partner_id,partner_username:n.partners?.username||s.announcements.unknown,title:n.title,content:n.content,image_url:n.image_url,is_popup:n.is_popup,target_audience:n.target_audience,target_level:n.target_level,status:n.status,display_order:n.display_order,view_count:n.view_count,start_date:n.start_date,end_date:n.end_date,created_at:n.created_at,updated_at:n.updated_at}));P(u)}catch(t){console.error(s.announcements.loadFailed,t),d.error(s.announcements.loadFailed)}finally{F(!1)}},G=async()=>{if(!l.title.trim()||!l.content.trim()){d.error(s.announcements.titleContentRequired);return}try{const t={...l,partner_id:b.id,target_level:l.target_level?parseInt(l.target_level):null,start_date:l.start_date||new Date().toISOString(),end_date:l.end_date||null};let a;if(p?a=await x.from("announcements").update(t).eq("id",p.id).select():a=await x.from("announcements").insert([t]).select(),a.error)throw a.error;d.success(p?s.announcements.updateSuccess:s.announcements.createSuccess),!p&&E&&E("new_announcement",{title:l.title,target_audience:l.target_audience,is_popup:l.is_popup}),$(),D(!1),f()}catch(t){console.error(s.announcements.saveFailed,t),d.error(s.announcements.saveFailed)}},J=async t=>{if(confirm(s.announcements.confirmDelete))try{const{error:a}=await x.from("announcements").delete().eq("id",t);if(a)throw a;d.success(s.announcements.deleteSuccess),f()}catch(a){console.error(s.announcements.deleteFailed,a),d.error(s.announcements.deleteFailed)}},Q=async(t,a)=>{try{const{error:c}=await x.from("announcements").update({status:a}).eq("id",t);if(c)throw c;P(n=>n.map(v=>v.id===t?{...v,status:a}:v));const u={active:s.announcements.statusActive,inactive:s.announcements.statusInactive,draft:s.announcements.statusDraft}[a]||a;d.success(s.announcements.statusUpdateSuccess.replace("{{status}}",u))}catch(c){console.error(s.announcements.statusUpdateFailed,c),d.error(s.announcements.statusUpdateFailed)}},$=()=>{i({title:"",content:"",image_url:"",is_popup:!1,target_audience:"users",target_level:"",status:"active",display_order:0,start_date:"",end_date:""}),k(null),q(null)},Y=t=>{i({title:t.title,content:t.content,image_url:t.image_url||"",is_popup:t.is_popup,target_audience:t.target_audience,target_level:t.target_level?.toString()||"",status:t.status,display_order:t.display_order,start_date:t.start_date?t.start_date.split("T")[0]:"",end_date:t.end_date?t.end_date.split("T")[0]:""}),k(t.image_url||null),q(t),D(!0)};o.useEffect(()=>{f()},[C,S]),o.useEffect(()=>{const t=setTimeout(()=>{g!==void 0&&f()},300);return()=>clearTimeout(t)},[g]);const Z=[{key:"title",title:s.announcements.titleColumn,render:(t,a)=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t}),e.jsxs("div",{className:"flex gap-1 mt-1",children:[a.is_popup&&e.jsx(N,{variant:"destructive",className:"text-xs",children:s.announcements.popupBadge}),a.target_audience==="partners"&&e.jsx(N,{variant:"secondary",className:"text-xs",children:s.announcements.adminBadge}),a.target_level&&e.jsx(N,{variant:"outline",className:"text-xs",children:s.announcements.levelBadge.replace("{{level}}",a.target_level.toString())})]})]})},{key:"target_audience",title:s.announcements.targetColumn,render:t=>{const a={all:s.announcements.targetAll,users:s.announcements.targetUsers,partners:s.announcements.targetPartners};return e.jsx(N,{variant:"outline",children:a[t]||t})}},{key:"status",title:s.announcements.statusColumn,render:(t,a)=>{const c={active:{label:s.announcements.statusActive,color:"bg-green-100 text-green-800"},inactive:{label:s.announcements.statusInactive,color:"bg-gray-100 text-gray-800"},draft:{label:s.announcements.statusDraft,color:"bg-yellow-100 text-yellow-800"}},u=c[t]||c.draft;return e.jsxs(_,{value:t,onValueChange:n=>Q(a.id,n),children:[e.jsx(y,{className:`w-auto h-7 ${u.color}`,children:e.jsx("span",{children:u.label})}),e.jsxs(w,{children:[e.jsx(r,{value:"active",children:s.announcements.statusActive}),e.jsx(r,{value:"inactive",children:s.announcements.statusInactive}),e.jsx(r,{value:"draft",children:s.announcements.statusDraft})]})]})}},{key:"view_count",title:s.announcements.viewCountColumn,render:t=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:t.toLocaleString()})]})},{key:"partner_username",title:s.announcements.authorColumn,render:t=>e.jsx("span",{className:"text-sm",children:t})},{key:"created_at",title:s.announcements.createdAtColumn,render:t=>new Date(t).toLocaleDateString("ko-KR")},{key:"actions",title:s.announcements.actionsColumn,render:(t,a)=>e.jsxs("div",{className:"flex gap-1",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:()=>Y(a),className:"h-8 px-2",children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsx(j,{size:"sm",variant:"outline",onClick:()=>J(a.id),className:"h-8 px-2 text-red-600 hover:text-red-700",children:e.jsx(he,{className:"h-4 w-4"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:s.announcements.title}),e.jsx("p",{className:"text-sm text-slate-400",children:s.announcements.subtitle})]}),e.jsxs(re,{open:W,onOpenChange:t=>{D(t),t||$()},children:[e.jsx(ce,{asChild:!0,children:e.jsxs(j,{className:"btn-premium-primary",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),s.announcements.create]})}),e.jsxs(ie,{className:"!max-w-[min(1000px,90vw)] w-[90vw] max-h-[85vh] overflow-hidden glass-card p-0 flex flex-col",children:[e.jsxs(oe,{className:"pb-5 border-b border-slate-700/50 bg-gradient-to-r from-blue-500/10 to-purple-500/10 px-8 pt-6 rounded-t-lg bg-slate-900 backdrop-blur-xl flex-shrink-0",children:[e.jsxs(de,{className:"flex items-center gap-3 text-2xl text-slate-50",children:[e.jsx("div",{className:"p-2.5 bg-blue-500/20 rounded-lg",children:e.jsx(T,{className:"h-7 w-7 text-blue-400"})}),p?s.announcements.editTitle:s.announcements.createTitle]}),e.jsx(ue,{className:"text-slate-300 mt-2 text-base",children:p?s.announcements.editDescription:s.announcements.createDescription})]}),e.jsxs("div",{className:"px-8 py-6 space-y-6 overflow-y-auto flex-1",children:[e.jsxs("div",{className:"space-y-4 p-5 border border-slate-700/50 rounded-xl bg-gradient-to-br from-slate-900/50 to-slate-800/30 shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"h-1 w-8 bg-blue-500 rounded-full"}),e.jsx("h4",{className:"font-semibold text-slate-100",children:s.announcements.basicInfoSection})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs(m,{htmlFor:"title",className:"text-slate-200 flex items-center gap-2",children:[e.jsx(B,{className:"h-3.5 w-3.5 text-blue-400"}),s.announcements.titleRequired]}),e.jsx(h,{id:"title",value:l.title,onChange:t=>i(a=>({...a,title:t.target.value})),placeholder:s.announcements.titlePlaceholder,className:"input-premium h-11 text-base border-slate-600 focus:border-blue-500 bg-slate-800/50"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(m,{className:"text-slate-200",children:s.announcements.statusLabel}),e.jsxs(_,{value:l.status,onValueChange:t=>i(a=>({...a,status:t})),children:[e.jsx(y,{className:"h-11 bg-slate-800/50 border-slate-600 hover:border-blue-500 transition-colors",children:e.jsx(A,{})}),e.jsxs(w,{className:"bg-slate-900 border-slate-700",children:[e.jsx(r,{value:"active",children:s.announcements.active}),e.jsx(r,{value:"inactive",children:s.announcements.inactive}),e.jsx(r,{value:"draft",children:s.announcements.draft})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(m,{className:"text-slate-200",children:s.announcements.targetLabel}),e.jsxs(_,{value:l.target_audience,onValueChange:t=>i(a=>({...a,target_audience:t})),children:[e.jsx(y,{className:"h-11 bg-slate-800/50 border-slate-600 hover:border-blue-500 transition-colors",children:e.jsx(A,{})}),e.jsxs(w,{className:"bg-slate-900 border-slate-700",children:[e.jsx(r,{value:"all",children:s.announcements.allTarget}),e.jsx(r,{value:"users",children:s.announcements.usersTarget}),e.jsx(r,{value:"partners",children:s.announcements.partnersTarget})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(m,{className:"text-slate-200",children:s.announcements.targetLevelLabel}),e.jsx(h,{type:"number",min:"1",max:"6",value:l.target_level,onChange:t=>i(a=>({...a,target_level:t.target.value})),placeholder:s.announcements.targetLevelPlaceholder,className:"input-premium h-11 bg-slate-800/50 border-slate-600 focus:border-blue-500"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(m,{className:"text-slate-200",children:s.announcements.displayOrderLabel}),e.jsx(h,{type:"number",value:l.display_order,onChange:t=>i(a=>({...a,display_order:parseInt(t.target.value)||0})),className:"input-premium h-11 bg-slate-800/50 border-slate-600 focus:border-blue-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-3 border-t border-slate-700/30",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs(m,{className:"text-slate-200 flex items-center gap-2",children:[e.jsx(ve,{className:"h-3.5 w-3.5 text-blue-400"}),s.announcements.startDateLabel]}),e.jsx(h,{type:"date",value:l.start_date,onChange:t=>i(a=>({...a,start_date:t.target.value})),className:"input-premium h-11 bg-slate-800/50 border-slate-600 focus:border-blue-500"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(m,{className:"text-slate-200",children:s.announcements.endDateLabel}),e.jsx(h,{type:"date",value:l.end_date,onChange:t=>i(a=>({...a,end_date:t.target.value})),placeholder:s.announcements.endDatePlaceholder,className:"input-premium h-11 bg-slate-800/50 border-slate-600 focus:border-blue-500"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg border border-slate-700/50",children:[e.jsx(me,{id:"is_popup",checked:l.is_popup,onCheckedChange:t=>i(a=>({...a,is_popup:t}))}),e.jsx(m,{htmlFor:"is_popup",className:"text-slate-200 cursor-pointer",children:s.announcements.popupLabel})]})]}),e.jsxs("div",{className:"space-y-4 p-5 border border-slate-700/50 rounded-xl bg-gradient-to-br from-slate-900/50 to-slate-800/30 shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"h-1 w-8 bg-green-500 rounded-full"}),e.jsx("h4",{className:"font-semibold text-slate-100",children:s.announcements.contentSection})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(m,{htmlFor:"content",className:"text-slate-200 flex items-center gap-2",children:[e.jsx(B,{className:"h-3.5 w-3.5 text-green-400"}),s.announcements.contentRequired]}),e.jsx(ae,{id:"content",value:l.content,onChange:t=>i(a=>({...a,content:t.target.value})),placeholder:s.announcements.contentPlaceholder,rows:8,className:"input-premium bg-slate-800/50 border-slate-600 focus:border-green-500 resize-none text-base leading-relaxed"}),e.jsx("div",{className:"p-3 bg-slate-800/50 rounded-lg border border-slate-700/50",children:e.jsx("p",{className:"text-xs text-slate-400",children:s.announcements.writingTip})})]})]}),e.jsxs("div",{className:"space-y-4 p-5 border border-slate-700/50 rounded-xl bg-gradient-to-br from-slate-900/50 to-slate-800/30 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-1 w-8 bg-purple-500 rounded-full"}),e.jsx("h4",{className:"font-semibold text-slate-100",children:s.announcements.imageSection})]}),L&&e.jsxs(j,{type:"button",variant:"ghost",size:"sm",onClick:X,className:"h-8 text-xs text-red-400 hover:text-red-300 hover:bg-red-500/10",children:[e.jsx(je,{className:"h-4 w-4 mr-1"}),s.announcements.imageRemove]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg",children:e.jsxs("p",{className:"text-xs text-blue-300 flex items-center gap-2",children:[e.jsx(be,{className:"h-3.5 w-3.5"}),s.announcements.imageInfo]})}),L?e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"relative border-2 border-slate-600 rounded-xl overflow-hidden bg-slate-900 shadow-xl",children:[e.jsx("div",{className:"p-4 flex items-center justify-center",children:e.jsx("img",{src:L,alt:s.announcements.imageUploadedAlt,className:"max-w-full max-h-60 object-contain rounded"})}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx(N,{variant:"secondary",className:"bg-green-500/90 text-white",children:s.announcements.imagePreview})})]})}):e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(m,{htmlFor:"image",className:"flex-1 flex items-center justify-center h-24 border-2 border-dashed border-slate-600 rounded-xl cursor-pointer hover:border-purple-500 hover:bg-purple-500/5 transition-all bg-slate-800/30 group",children:e.jsxs("div",{className:"flex items-center gap-3 text-slate-300",children:[e.jsx("div",{className:"p-3 bg-slate-700/50 rounded-full group-hover:bg-purple-500/20 transition-colors",children:e.jsx(fe,{className:"h-6 w-6 text-slate-400 group-hover:text-purple-400 transition-colors"})}),e.jsx("span",{children:s.announcements.imageUploadPlaceholder})]})}),e.jsx(h,{id:"image",type:"file",accept:"image/*",onChange:M,disabled:I,className:"hidden"}),I&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-400",children:[e.jsx("div",{className:"loading-premium w-4 h-4"}),s.announcements.uploading]})]})]})]})]}),e.jsxs("div",{className:"flex gap-4 pt-6 border-t border-slate-700/50 px-8 pb-6 bg-slate-900 backdrop-blur-xl flex-shrink-0",children:[e.jsxs(j,{onClick:G,disabled:!l.title.trim()||!l.content.trim(),className:"btn-premium-primary flex items-center gap-3 flex-1 h-12 text-base shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 transition-all",children:[e.jsx(T,{className:"h-5 w-5"}),p?s.announcements.update:s.announcements.save]}),e.jsx(j,{onClick:()=>D(!1),variant:"outline",className:"border-slate-600 hover:bg-slate-700/50 h-12 px-8 text-base",children:s.announcements.cancel})]})]})]})]}),e.jsxs("div",{className:"glass-card rounded-xl p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold text-slate-100 flex items-center gap-2",children:[e.jsx(T,{className:"h-5 w-5 text-blue-400"}),s.announcements.announcementListTitle]}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:s.announcements.announcementListDescription})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 h-4 w-4"}),e.jsx(h,{placeholder:s.announcements.searchPlaceholder,value:g,onChange:t=>K(t.target.value),className:"pl-9 input-premium"})]})}),e.jsxs(_,{value:C,onValueChange:V,children:[e.jsx(y,{className:"w-[120px] bg-slate-800/50 border-slate-600",children:e.jsx(A,{})}),e.jsxs(w,{children:[e.jsx(r,{value:"all",children:s.announcements.allStatus}),e.jsx(r,{value:"active",children:s.announcements.statusActive}),e.jsx(r,{value:"inactive",children:s.announcements.statusInactive}),e.jsx(r,{value:"draft",children:s.announcements.statusDraft})]})]}),e.jsxs(_,{value:S,onValueChange:O,children:[e.jsx(y,{className:"w-[120px] bg-slate-800/50 border-slate-600",children:e.jsx(A,{})}),e.jsxs(w,{children:[e.jsx(r,{value:"all",children:s.announcements.allTargets}),e.jsx(r,{value:"users",children:s.announcements.targetUsers}),e.jsx(r,{value:"partners",children:s.announcements.targetPartners})]})]})]}),z?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(ne,{})}):e.jsx(le,{data:R,columns:Z,enableSearch:!1})]})]})]})}export{Fe as Announcements};
