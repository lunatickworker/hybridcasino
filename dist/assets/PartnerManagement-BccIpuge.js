const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Be3DOFuy.js","assets/react-core-BwkdTuSg.js","assets/vendor-D410aui4.js","assets/radix-ui-omyR4zpf.js","assets/lucide-icons-D2Pw2Rdn.js","assets/supabase-C8Oa5ukG.js","assets/index-CW60_reT.css","assets/settlementCalculator-DhQR0qso.js"])))=>i.map(i=>d[i]);
import{m as Ya,n as Ja,a as Qa,s as c,_ as Ce,B as I,h as S,l as ua,T as Xa,i as Za,j as ga,k as Ie,C as V,E as G,F as H,G as Pe,e as R,I as M,S as Te,o as De,p as Ee,q as $e,r as P,L as w}from"./index-Be3DOFuy.js";import{r as g,j as e}from"./react-core-BwkdTuSg.js";import{A as Fe,a as Oe,b as Be,c as Ae,d as qe,e as Ue}from"./AdminDialog-6C2SLoqm.js";import{k as u}from"./vendor-D410aui4.js";import{M as T}from"./MetricCard-DF34t905.js";import{PartnerTransactions as er}from"./PartnerTransactions-BPNQQpMX.js";import{F as ar}from"./ForceTransactionModal-Bbup6gUf.js";import{f as O,U as Ve,g as Ge,h as He,a3 as rr,ap as ha,_ as xa,n as Re,ag as ze,aq as tr,N as nr,S as X,w as sr,T as lr,a9 as se,ar as fa}from"./lucide-icons-D2Pw2Rdn.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";import"./DataTable-CJW7Gi2n.js";import"./table-C50RqMyg.js";import"./popover-BEBhnF_B.js";import"./command-B168hacb.js";const W={system_admin:"bg-purple-500",head_office:"bg-red-500",main_office:"bg-orange-500",sub_office:"bg-yellow-500",distributor:"bg-blue-500",store:"bg-green-500"},_a={active:"bg-green-500",inactive:"bg-gray-500",blocked:"bg-red-500"};function Cr(){const{authState:n}=Ya(),{connected:Z,sendMessage:B}=Ja(),{t}=Qa(),A={system_admin:t.partnerManagement.systemAdmin,head_office:t.partnerManagement.headOffice,main_office:t.partnerManagement.mainOffice,sub_office:t.partnerManagement.subOffice,distributor:t.partnerManagement.distributor,store:t.partnerManagement.store},We={active:t.partnerManagement.active,inactive:t.partnerManagement.inactive,blocked:t.partnerManagement.blocked},[k,K]=g.useState([]),[z,U]=g.useState(!0),[le,va]=g.useState(""),[ie,ba]=g.useState("all"),[oe,ya]=g.useState("all"),[L,ee]=g.useState(null),[ja,ae]=g.useState(!1),[wa,Y]=g.useState(!1),[Na,J]=g.useState(!1),[C,re]=g.useState(null),[ce,Q]=g.useState(""),[de,Ke]=g.useState(!1),[me,Sa]=g.useState(!1),[pe,Ma]=g.useState("hierarchy"),[ka,La]=g.useState({}),[te,Ye]=g.useState([]),[ue,ge]=g.useState(new Set),[Je,Qe]=g.useState(!1),[he,Xe]=g.useState(""),[xe,Ca]=g.useState({rolling:.5,losing:5,fee:1}),[Ia,fe]=g.useState(!1),[Pa,_e]=g.useState("deposit"),[D,Ze]=g.useState(null),[ir,ve]=g.useState({invest:0,oroplay:0}),[Ta,Da]=g.useState(0),[Ea,be]=g.useState(0),[$a,ye]=g.useState(0),[j,je]=g.useState(null),[i,y]=g.useState({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:"",commission_rolling:.5,commission_losing:5,withdrawal_fee:0,min_withdrawal_amount:1e4,max_withdrawal_amount:1e6,daily_withdrawal_limit:5e6}),[or,ea]=g.useState(!1),[cr,aa]=g.useState(null),[dr,ra]=g.useState(""),[mr,ta]=g.useState(""),[pr,na]=g.useState("deposit"),[ur,gr]=g.useState(!1),sa=async a=>{try{const{data:r,error:l}=await c.from("partners").select("commission_rolling, commission_losing, withdrawal_fee, partner_type, nickname").eq("id",a).maybeSingle();return l?(console.error("[Partner Commission Error]:",l),null):r?{rolling:r.commission_rolling||100,losing:r.commission_losing||100,fee:r.withdrawal_fee||100,nickname:r.nickname}:null}catch(r){return console.error("[Partner Commission Fetch Failed]:",r),null}},la=async()=>{if(!n.user?.id)return;const a=await sa(n.user.id);a&&je(a)},ia=async()=>{try{const{data:a,error:r}=await c.from("system_settings").select("setting_key, setting_value").in("setting_key",["default_rolling_commission","default_losing_commission","default_withdrawal_fee"]);if(r){console.error("[System Default Commission Load Error]:",r);return}if(a&&a.length>0){const l={rolling:.5,losing:5,fee:1};a.forEach(s=>{s.setting_key==="default_rolling_commission"?l.rolling=parseFloat(s.setting_value)||.5:s.setting_key==="default_losing_commission"?l.losing=parseFloat(s.setting_value)||5:s.setting_key==="default_withdrawal_fee"&&(l.fee=parseFloat(s.setting_value)||1)}),Ca(l),y(s=>({...s,commission_rolling:l.rolling,commission_losing:l.losing,withdrawal_fee:l.fee}))}}catch(a){console.error("[System Default Commission Load Failed]:",a)}},Fa=async()=>{if(!n.user?.id||n.user?.level!==1){ve({invest:0,oroplay:0});return}try{const{data:a,error:r}=await c.from("api_configs").select("balance").eq("partner_id",n.user.id).eq("api_provider","invest").maybeSingle(),{data:l,error:s}=await c.from("api_configs").select("balance").eq("partner_id",n.user.id).eq("api_provider","oroplay").maybeSingle();r&&console.error("âš ï¸ Lv1 invest api_configs ì¡°íšŒ ì‹¤íŒ¨:",r),s&&console.error("âš ï¸ Lv1 oroplay api_configs ì¡°íšŒ ì‹¤íŒ¨:",s),ve({invest:a?.balance||0,oroplay:l?.balance||0}),console.log("ğŸ’° Lv1 API ë³´ìœ ê¸ˆ ì¡°íšŒ:",{invest:a?.balance||0,oroplay:l?.balance||0})}catch(a){console.error("âŒ Lv1 API ë³´ìœ ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨:",a)}},Oa=async()=>{if(n.user?.id)try{const{data:a,error:r}=await c.from("partners").select("balance, level").eq("id",n.user.id).single();if(r)throw r;if(console.log("ğŸ’° [PartnerManagement] ê´€ë¦¬ì ë³´ìœ ê¸ˆ ì¡°íšŒ (partners í…Œì´ë¸”):",{level:a?.level,balance:a?.balance}),a?.level===1){const{data:l,error:s}=await c.from("api_configs").select("balance").eq("partner_id",n.user.id).eq("api_provider","invest").maybeSingle(),{data:d,error:o}=await c.from("api_configs").select("balance").eq("partner_id",n.user.id).eq("api_provider","oroplay").maybeSingle();!s&&l?be(l.balance||0):(console.warn("âš ï¸ Lv1 invest api_configs ì¡°íšŒ ì‹¤íŒ¨:",s),be(0)),!o&&d?ye(d.balance||0):(console.warn("âš ï¸ Lv1 oroplay api_configs ì¡°íšŒ ì‹¤íŒ¨:",o),ye(0)),console.log("âœ… Lv1 ë³´ìœ ê¸ˆ ì„¤ì • (api_configs):",{invest:l?.balance||0,oroplay:d?.balance||0})}else a?.level===2?(be(a?.invest_balance||0),ye(a?.oroplay_balance||0),console.log("âœ… Lv2 ë³´ìœ ê¸ˆ ì„¤ì • (ë‘ ê°œ ì§€ê°‘):",{invest_balance:a?.invest_balance||0,oroplay_balance:a?.oroplay_balance||0})):(Da(a?.balance||0),console.log("âœ… Lv3~7 ë³´ìœ ê¸ˆ ì„¤ì •:",a?.balance||0))}catch(a){console.error("âŒ í˜„ì¬ ì‚¬ìš©ì ë³´ìœ ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨:",a)}};g.useEffect(()=>{n.user?.id&&(ia(),la(),E(),we(),Fa(),Oa())},[n.user?.id]),g.useEffect(()=>{if(!n.user?.id)return;console.log("âœ… Realtime êµ¬ë…: partners.balance ë³€ê²½ ê°ì§€");const a=c.channel("partner_balance_changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"partners"},s=>{const d=s.new.id,o=s.old.balance,_=s.new.balance;o!==_&&K(m=>{const p=m.find(f=>f.id===d);return p?p.level===1?(console.log("â­ï¸ Lv1 balance ë³€ê²½ ë¬´ì‹œ (api_configs ì‚¬ìš©)"),m):p.level===2?(console.log("â­ï¸ Lv2 balance ë³€ê²½ ë¬´ì‹œ (Lv2 ì „ìš© êµ¬ë…ì—ì„œ ì²˜ë¦¬)"),m):(console.log(`ğŸ’° Lv${p.level} ë³´ìœ ê¸ˆ ë³€ê²½ (partner_id: ${d}): ${o} â†’ ${_}`),m.map(f=>f.id===d?{...f,balance:_}:f)):m})}).subscribe(),r=c.channel("api_configs_balance_changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"api_configs"},async s=>{const d=s.new.partner_id,o=s.new.api_provider,_=s.old.balance||0,m=s.new.balance||0;_!==m&&(console.log(`ğŸ’° API ë³´ìœ ê¸ˆ ë³€ê²½ (partner_id: ${d}, provider: ${o}): ${_} â†’ ${m}`),d===n.user?.id&&n.user?.level===1&&(ve(p=>({...p,[o]:m})),console.log("ğŸ’° Lv1 ê´€ë¦¬ì ë³¸ì¸ API ë³´ìœ ê¸ˆ ì—…ë°ì´íŠ¸:",{provider:o,balance:m})),K(p=>{const f=p.find(b=>b.id===d);return!f||f.level!==1?p:p.map(b=>{if(b.id===d){const h={...b,balance:0};return o==="invest"?h.invest_balance=m:o==="oroplay"&&(h.oroplay_balance=m),h}return b})}))}).subscribe(),l=c.channel("lv2_balance_changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"partners"},async s=>{const d=s.new.id,o=s.old.invest_balance||0,_=s.new.invest_balance||0,m=s.old.oroplay_balance||0,p=s.new.oroplay_balance||0;(o!==_||m!==p)&&K(b=>{const h=b.find($=>$.id===d);return!h||h.level!==2?b:(console.log(`ğŸ’° Lv2 ë³´ìœ ê¸ˆ ë³€ê²½ (partner_id: ${d}):`,{invest_balance:_,oroplay_balance:p}),b.map($=>$.id===d?{...$,invest_balance:_,oroplay_balance:p}:$))})}).subscribe();return()=>{c.removeChannel(a),c.removeChannel(r),c.removeChannel(l)}},[n.user?.id]);const E=async()=>{try{if(U(!0),console.log("ğŸ” [íŒŒíŠ¸ë„ˆ ì¡°íšŒ] authState.user:",{id:n.user?.id,username:n.user?.username,level:n.user?.level,partner_type:n.user?.partner_type}),!n.user?.id){console.error("âŒ [íŒŒíŠ¸ë„ˆ ì¡°íšŒ] ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤"),u.error(t.partnerManagement.fetchLoginInfoError),K([]),U(!1);return}let a=c.from("partners").select(`
          id,
          username,
          nickname,
          partner_type,
          level,
          parent_id,
          balance,
          invest_balance,
          oroplay_balance,
          commission_rolling,
          commission_losing,
          withdrawal_fee,
          status,
          created_at,
          updated_at,
          parent:parent_id (
            nickname
          )
        `).order("level",{ascending:!0}).order("created_at",{ascending:!1});const r=n.user.level===1;console.log(`ğŸ” [íŒŒíŠ¸ë„ˆ ì¡°íšŒ] ì‹œìŠ¤í…œ ê´€ë¦¬ì ì—¬ë¶€: ${r}`);const{data:l,error:s}=r?await a:await c.rpc("get_hierarchical_partners",{p_partner_id:n.user.id});if(console.log("ğŸ“Š [íŒŒíŠ¸ë„ˆ ì¡°íšŒ] ê²°ê³¼:",{ë°ì´í„°ê°œìˆ˜:l?.length||0,ì—ëŸ¬:s?.message||"null"}),s)throw console.error("[Partner List Fetch Error]:",s),u.error(t.partnerManagement.fetchPartnersError),s;const d=await Promise.all((l||[]).map(async o=>{const{count:_}=await c.from("partners").select("*",{count:"exact"}).eq("parent_id",o.id),{count:m}=await c.from("users").select("*",{count:"exact"}).eq("referrer_id",o.id);let p=0,f=0;if(o.level===1){const{data:b}=await c.from("api_configs").select("balance").eq("partner_id",o.id).eq("api_provider","invest").maybeSingle(),{data:h}=await c.from("api_configs").select("balance").eq("partner_id",o.id).eq("api_provider","oroplay").maybeSingle();p=b?.balance||0,f=h?.balance||0}else o.level===2&&(p=o.invest_balance||0,f=o.oroplay_balance||0,console.log("ğŸ” [Lv2 ë³´ìœ ê¸ˆ ì¡°íšŒ]:",{partner_id:o.id,nickname:o.nickname,invest_balance_raw:o.invest_balance,oroplay_balance_raw:o.oroplay_balance,invest_balance_parsed:p,oroplay_balance_parsed:f,total:p+f}));return{...o,parent_nickname:o.parent?.nickname||"-",child_count:_||0,user_count:m||0,balance:o.level===1||o.level===2?0:o.balance||0,invest_balance:p,oroplay_balance:f}}));K(d)}catch(a){console.error("[Partner List Fetch Error]:",a),u.error(t.partnerManagement.fetchPartnersError)}finally{U(!1)}},oa=(a,r,l,s)=>{if(s==="head_office")return a!==100||r!==100||l!==100?(u.error(t.partnerManagement.commissionValidation),!1):!0;if(j){if(a>j.rolling)return u.error(t.partnerManagement.exceedParentRollingError.replace("{{rate}}",j.rolling.toString())),!1;if(r>j.losing)return u.error(t.partnerManagement.exceedParentLosingError.replace("{{rate}}",j.losing.toString())),!1;if(l>j.fee)return u.error(t.partnerManagement.exceedParentFeeError.replace("{{rate}}",j.fee.toString())),!1}return!0},Ba=async()=>{try{if(U(!0),!i.username.trim()){u.error(t.partnerManagement.enterUsernameError);return}if(!i.nickname.trim()){u.error(t.partnerManagement.enterNicknameError);return}if(!i.password.trim()){u.error(t.partnerManagement.enterPasswordError);return}if(!Ga(i.partner_type)){u.error(t.partnerManagement.noPermissionError);return}if(n.user?.level!==1){const h=await Ne(i.partner_type);if(h.hasGap){u.error(h.message,{duration:5e3});return}if(!h.directParentId){u.error(t.partnerManagement.parentNotFoundDetailError.replace("{{partnerType}}",A[i.partner_type]));return}}let a=i.commission_rolling,r=i.commission_losing,l=i.withdrawal_fee;if(i.partner_type==="head_office"&&(a=100,r=100,l=100),!oa(a,r,l,i.partner_type))return;const s=Se(i.partner_type);let d=n.user?.id||null;if(n.user?.level!==1){const h=await Ne(i.partner_type);h.directParentId&&(d=h.directParentId)}const{data:o,error:_}=await c.rpc("hash_password",{password:i.password});if(_){console.error("âŒ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ì˜¤ë¥˜:",_),u.error(t.common.error);return}if(i.partner_type!=="head_office"){console.log("ğŸ” [í•˜ìœ„ íŒŒíŠ¸ë„ˆ ìƒì„±] api_configsì—ì„œ API ì„¤ì • ì¡°íšŒ ì‹œì‘");try{const{getAdminOpcode:h,isMultipleOpcode:$}=await Ce(async()=>{const{getAdminOpcode:ke,isMultipleOpcode:Le}=await import("./index-Be3DOFuy.js").then(Ka=>Ka.a9);return{getAdminOpcode:ke,isMultipleOpcode:Le}},__vite__mapDeps([0,1,2,3,4,5,6]));if(console.log("ğŸ” [OPCODE ì¡°íšŒ] authState.user:",{id:n.user?.id,username:n.user?.username,partner_type:n.user?.partner_type,level:n.user?.level,parent_id:n.user?.parent_id}),!n.user)throw new Error("ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");const x=await h(n.user);let v,N,F;if($(x)){if(x.opcodes.length===0){u.error(t.partnerManagement.noApiConfigError);return}v=x.opcodes[0].opcode,N=x.opcodes[0].secretKey,F=x.opcodes[0].token}else v=x.opcode,N=x.secretKey,F=x.token;console.log("âœ… api_configsì—ì„œ API ì„¤ì • ì¡°íšŒ ì„±ê³µ:",{opcode:v});const q=i.username.replace(/^btn_/,"");console.log("ğŸ“¡ [POST /api/account] Invest API ê³„ì • ìƒì„± í˜¸ì¶œ:",{opcode:v,username:q,partner_type:i.partner_type});const{createAccount:Wa}=await Ce(async()=>{const{createAccount:ke}=await import("./index-Be3DOFuy.js").then(Le=>Le.a8);return{createAccount:ke}},__vite__mapDeps([0,1,2,3,4,5,6])),ne=await Wa(v,q,N);if(console.log("ğŸ“Š [POST /api/account] API ì‘ë‹µ:",ne),ne.error){console.error("âŒ Invest API ê³„ì • ìƒì„± ì‹¤íŒ¨:",ne.error),u.error(t.partnerManagement.apiAccountCreationError.replace("{{error}}",ne.error));return}console.log("âœ… Invest API ê³„ì • ìƒì„± ì„±ê³µ")}catch(h){console.error("âŒ API ì„¤ì • ì¡°íšŒ ì‹¤íŒ¨:",h),u.error(t.partnerManagement.apiConfigFetchFailedError.replace("{{error}}",h.message));return}}else console.log("ğŸ¢ [ëŒ€ë³¸ì‚¬ ìƒì„±] API ê³„ì • ìƒì„± ê±´ë„ˆëœ€ (ìˆ˜ë™ ì„¤ì • í•„ìš”)");const p={username:i.username,nickname:i.nickname,password_hash:o,partner_type:i.partner_type,level:s,parent_id:d,commission_rolling:a,commission_losing:r,withdrawal_fee:l,status:"active"};s===2?(p.balance=null,p.invest_balance=0,p.oroplay_balance=0):s>=3&&(p.balance=0,p.invest_balance=null,p.oroplay_balance=null),console.log("ğŸ“ íŒŒíŠ¸ë„ˆ ìƒì„± ë°ì´í„°:",{username:p.username,partner_type:p.partner_type,level:p.level,parent_id:p.parent_id,current_user:n.user?.username,current_user_level:n.user?.level});const{data:f,error:b}=await c.from("partners").insert([p]).select().single();if(b){console.error("âŒ íŒŒíŠ¸ë„ˆ ìƒì„± DB ì˜¤ë¥˜:",b),u.error(t.partnerManagement.createPartnerError);return}i.partner_type==="head_office"&&console.log("â„¹ï¸ Lv2(ëŒ€ë³¸ì‚¬)ëŠ” api_configsë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (GMS ë¨¸ë‹ˆë§Œ ì‚¬ìš©)"),console.log("âœ… íŒŒíŠ¸ë„ˆ ìƒì„± ì„±ê³µ:",{id:f.id,username:f.username,partner_type:f.partner_type,level:f.level,parent_id:f.parent_id}),u.success(t.partnerManagement.partnerCreatedSuccess),ae(!1),ca(),Z&&B&&B({type:"partner_created",data:{partner:f}}),E()}catch(a){console.error("íŒŒíŠ¸ë„ˆ ìƒì„± ì˜¤ë¥˜:",a),u.error(t.partnerManagement.createPartnerError)}finally{U(!1)}},Aa=async()=>{if(L)try{if(U(!0),!oa(i.commission_rolling,i.commission_losing,i.withdrawal_fee,L.partner_type))return;const a={nickname:i.nickname,commission_rolling:i.commission_rolling,commission_losing:i.commission_losing,withdrawal_fee:i.withdrawal_fee,min_withdrawal_amount:i.min_withdrawal_amount,max_withdrawal_amount:i.max_withdrawal_amount,daily_withdrawal_limit:i.daily_withdrawal_limit,updated_at:new Date().toISOString()};i.password&&i.password.trim()!==""&&(a.password_hash=i.password);const{error:r}=await c.from("partners").update(a).eq("id",L.id);if(r)throw r;u.success(t.partnerManagement.partnerUpdatedSuccess),Y(!1),ee(null),Z&&B&&B({type:"partner_updated",data:{partnerId:L.id,updates:a}}),E()}catch(a){console.error("íŒŒíŠ¸ë„ˆ ìˆ˜ì • ì˜¤ë¥˜:",a),u.error(t.partnerManagement.updatePartnerError)}finally{U(!1)}},qa=async()=>{if(C){if(ce!==C.username){u.error(t.partnerManagement.deleteConfirmTextError);return}try{Ke(!0);const{count:a}=await c.from("partners").select("*",{count:"exact",head:!0}).eq("parent_id",C.id);if(a&&a>0){u.error(t.partnerManagement.hasChildPartnersError.replace("{{count}}",a.toString()));return}const{count:r}=await c.from("users").select("*",{count:"exact",head:!0}).eq("referrer_id",C.id);if(r&&r>0){u.error(t.partnerManagement.hasManagedUsersError.replace("{{count}}",r.toString()));return}const{error:l}=await c.from("partners").delete().eq("id",C.id);if(l)throw l;u.success(t.partnerManagement.partnerDeletedWithName.replace("{{nickname}}",C.nickname),{duration:3e3,icon:"ğŸ—‘ï¸"}),Z&&B&&B({type:"partner_deleted",data:{partnerId:C.id}}),J(!1),re(null),Q(""),E()}catch(a){console.error("íŒŒíŠ¸ë„ˆ ì‚­ì œ ì˜¤ë¥˜:",a),u.error(t.partnerManagement.deleteFailedError)}finally{Ke(!1)}}},Ua=async a=>{if(n.user?.id)try{console.log("ğŸ’° [íŒŒíŠ¸ë„ˆ ê°•ì œ ì…ì¶œê¸ˆ] ì‹œì‘:",a);const{data:r,error:l}=await c.from("partners").select("*").eq("id",a.targetId).single();if(l||!r){u.error(t.partnerManagement.targetPartnerFetchError),console.error("âŒ ëŒ€ìƒ íŒŒíŠ¸ë„ˆ ì¡°íšŒ ì‹¤íŒ¨:",l);return}const{data:s,error:d}=await c.from("partners").select("balance, level, nickname, partner_type").eq("id",n.user.id).single();if(d||!s){u.error(t.partnerManagement.adminInfoFetchError),console.error("âŒ ê´€ë¦¬ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:",d);return}const o=s.level===1,_=r.partner_type==="head_office",m=o&&r.level===2,p=o&&r.level===3,f=s.level===2&&r.level===3;if(console.log("ğŸ“Š [íŒŒíŠ¸ë„ˆ ê°•ì œ ì…ì¶œê¸ˆ] ìƒí™©:",{isLv1ToLv2:m,adminLevel:s.level,targetLevel:r.level,apiType:a.apiType}),a.type==="withdrawal"){if(m&&a.apiType){const x=(a.apiType==="invest"?r.invest_balance:r.oroplay_balance)||0;if(x<a.amount){const v=a.apiType==="invest"?"Invest":"OroPlay";u.error(t.partnerManagement.withdrawalExceedError.replace("{{balance}}",`${v} ${x.toLocaleString()}`));return}}else if(!m&&r.balance<a.amount){u.error(t.partnerManagement.withdrawalExceedError.replace("{{balance}}",r.balance.toLocaleString()));return}}if(a.type==="deposit"){if(m&&a.apiType){const{data:x,error:v}=await c.from("api_configs").select("balance").eq("partner_id",n.user.id).eq("api_provider",a.apiType).maybeSingle();if(v||!x){u.error(t.partnerManagement.apiConfigFetchError),console.error("âŒ API ì„¤ì • ì¡°íšŒ ì‹¤íŒ¨:",v);return}const N=x.balance||0;if(console.log(`ğŸ’³ Lv1 ${a.apiType.toUpperCase()} API ë³´ìœ ê¸ˆ:`,N),N<a.amount){const F=a.apiType==="invest"?"Invest":"OroPlay";u.error(t.partnerManagement.apiBalanceInsufficientError.replace("{{apiName}}",F).replace("{{balance}}",N.toLocaleString()));return}}else if(s.level===2&&a.apiType){const x=(a.apiType==="invest"?s.invest_balance:s.oroplay_balance)||0;if(a.amount>x){const v=a.apiType==="invest"?"Invest":"OroPlay";u.error(t.partnerManagement.balanceInsufficientError.replace("{{balance}}",`${v} ${x.toLocaleString()}`));return}}else if(!m&&s.balance<a.amount){u.error(t.partnerManagement.balanceInsufficientError.replace("{{balance}}",s.balance.toLocaleString()));return}}if(m&&a.type==="deposit"&&a.apiType){console.log("âœ… [Lv1â†’Lv2 ì…ê¸ˆ] Lv1 ì™¸ë¶€ ì§€ê°‘ì€ ë³€ê²½í•˜ì§€ ì•Šê³  Lv2ì—ê²Œë§Œ í• ë‹¹"),console.log("ğŸ” [ì…ê¸ˆ ëŒ€ìƒ í™•ì¸]",{"Lv1 ID (authState.user.id)":n.user.id,"Lv1 ë‹‰ë„¤ì„":s.nickname,"Lv2 ID (data.targetId)":a.targetId,"Lv2 ë‹‰ë„¤ì„":r.nickname,"Lv2 ë ˆë²¨":r.level});const x=a.apiType==="invest"?"invest_balance":"oroplay_balance",v=(a.apiType==="invest"?r.invest_balance:r.oroplay_balance)||0,N=v+a.amount;console.log(`ğŸ” Lv2 partners.${x} ì¦ê°€ ì˜ˆì • (partner_id: ${a.targetId}):`,{before:v,after:N,amount:a.amount});const{error:F}=await c.from("partners").update({[x]:N,updated_at:new Date().toISOString()}).eq("id",a.targetId);if(F){u.error(t.partnerManagement.lv2BalanceUpdateError),console.error("âŒ Lv2 partners ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:",F);return}console.log(`âœ… Lv2 partners.${x} ì¦ê°€:`,{before:v,after:N,amount:a.amount});const q=a.apiType==="invest"?"Invest":"OroPlay";await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:v,balance_after:N,amount:a.amount,transaction_type:"deposit",from_partner_id:n.user.id,to_partner_id:a.targetId,processed_by:n.user.id,api_type:a.apiType,memo:`[${q} API í• ë‹¹] ${s.nickname}ìœ¼ë¡œë¶€í„° ${a.amount.toLocaleString()}ì› í• ë‹¹${a.memo?`: ${a.memo}`:""}`}),u.success(t.partnerManagement.apiAllocationSuccess.replace("{{nickname}}",r.nickname).replace("{{apiName}}",q).replace("{{amount}}",a.amount.toLocaleString())),E();return}if(m&&a.type==="withdrawal"&&a.apiType){console.log("âœ… [Lv1â†’Lv2 ì¶œê¸ˆ] Lv1 ì™¸ë¶€ ì§€ê°‘ì€ ë³€ê²½í•˜ì§€ ì•Šê³  Lv2ì—ì„œë§Œ íšŒìˆ˜");const x=a.apiType==="invest"?"invest_balance":"oroplay_balance",v=(a.apiType==="invest"?r.invest_balance:r.oroplay_balance)||0,N=v-a.amount;console.log(`ğŸ” Lv2 partners.${x} ì°¨ê° ì˜ˆì • (partner_id: ${a.targetId}):`,{before:v,after:N,amount:-a.amount});const{error:F}=await c.from("partners").update({[x]:N,updated_at:new Date().toISOString()}).eq("id",a.targetId);if(F){u.error(t.partnerManagement.lv2WithdrawalDeductError),console.error("âŒ Lv2 partners ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:",F);return}console.log(`âœ… Lv2 partners.${x} ì°¨ê°:`,{before:v,after:N,amount:-a.amount});const q=a.apiType==="invest"?"Invest":"OroPlay";await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:v,balance_after:N,amount:-a.amount,transaction_type:"withdrawal",from_partner_id:a.targetId,to_partner_id:n.user.id,processed_by:n.user.id,api_type:a.apiType,memo:`[${q} API íšŒìˆ˜] ${s.nickname}ì´(ê°€) ${a.amount.toLocaleString()}ì› íšŒìˆ˜${a.memo?`: ${a.memo}`:""}`}),u.success(t.partnerManagement.apiRecoveryCompletedFromPartner.replace("{{nickname}}",r.nickname).replace("{{apiName}}",q).replace("{{amount}}",a.amount.toLocaleString())),E();return}console.log("âœ… [íŒŒíŠ¸ë„ˆ ê°•ì œ ì…ì¶œê¸ˆ] ì™¸ë¶€ API í˜¸ì¶œ ê±´ë„ˆëœ€ - ë‚´ë¶€ DBë§Œ ì²˜ë¦¬");let b=s.balance,h=r.balance;if(a.type==="deposit"){if((p||f)&&r.level===3){console.log("âœ… [Lv1/Lv2â†’Lv3 ì…ê¸ˆ] Lv2 ë³€ë™ ì—†ìŒ, Lv3 balanceë§Œ ì¦ê°€");const x=r.balance,v=x+a.amount;await c.from("partners").update({balance:v,updated_at:new Date().toISOString()}).eq("id",a.targetId),await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:x,balance_after:v,amount:a.amount,transaction_type:"deposit",from_partner_id:n.user.id,to_partner_id:a.targetId,processed_by:n.user.id,memo:`[Lv3 ìˆ˜ì‹ ] ${s.nickname}ìœ¼ë¡œë¶€í„° ${a.amount.toLocaleString()}ì› ì…ê¸ˆ${a.memo?`: ${a.memo}`:""}`}),u.success(t.partnerManagement.depositCompleted.replace("{{nickname}}",r.nickname).replace("{{amount}}",a.amount.toLocaleString())),E();return}if(s.level===2&&r.level>=4&&a.apiType){const x=a.apiType==="invest"?"invest_balance":"oroplay_balance",N=((a.apiType==="invest"?s.invest_balance:s.oroplay_balance)||0)-a.amount;await c.from("partners").update({[x]:N,updated_at:new Date().toISOString()}).eq("id",n.user.id),h=r.balance+a.amount,await c.from("partners").update({balance:h,updated_at:new Date().toISOString()}).eq("id",a.targetId),await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:r.balance,balance_after:h,amount:a.amount,transaction_type:"deposit",from_partner_id:n.user.id,to_partner_id:a.targetId,processed_by:n.user.id,memo:`[ê°•ì œì…ê¸ˆ] ${s.nickname}ìœ¼ë¡œë¶€í„° ${a.amount.toLocaleString()}ì› ì…ê¸ˆ${a.memo?`: ${a.memo}`:""}`})}else b=s.balance-a.amount,await c.from("partners").update({balance:b,updated_at:new Date().toISOString()}).eq("id",n.user.id),h=r.balance+a.amount,await c.from("partners").update({balance:h,updated_at:new Date().toISOString()}).eq("id",a.targetId),await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:r.balance,balance_after:h,amount:a.amount,transaction_type:"deposit",from_partner_id:n.user.id,to_partner_id:a.targetId,processed_by:n.user.id,memo:`[ê°•ì œì…ê¸ˆ] ${s.nickname}ìœ¼ë¡œë¶€í„° ${a.amount.toLocaleString()}ì› ì…ê¸ˆ${a.memo?`: ${a.memo}`:""}`})}else{if((p||f)&&r.level===3){console.log("âœ… [Lv1/Lv2â†’Lv3 íšŒìˆ˜] Lv2 ë³€ë™ ì—†ìŒ, Lv3 balanceë§Œ ì°¨ê°");const x=r.balance,v=x-a.amount;await c.from("partners").update({balance:v,updated_at:new Date().toISOString()}).eq("id",a.targetId),await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:x,balance_after:v,amount:-a.amount,transaction_type:"withdrawal",from_partner_id:a.targetId,to_partner_id:n.user.id,processed_by:n.user.id,memo:`[Lv3 íšŒìˆ˜] ${s.nickname}ì—ê²Œ ${a.amount.toLocaleString()}ì› ì¶œê¸ˆ${a.memo?`: ${a.memo}`:""}`}),u.success(t.partnerManagement.withdrawalCompleted.replace("{{nickname}}",r.nickname).replace("{{amount}}",a.amount.toLocaleString())),E();return}if(s.level===2&&r.level>=4&&a.apiType){h=r.balance-a.amount,await c.from("partners").update({balance:h,updated_at:new Date().toISOString()}).eq("id",a.targetId);const x=a.apiType==="invest"?"invest_balance":"oroplay_balance",N=((a.apiType==="invest"?s.invest_balance:s.oroplay_balance)||0)+a.amount;await c.from("partners").update({[x]:N,updated_at:new Date().toISOString()}).eq("id",n.user.id),await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:r.balance,balance_after:h,amount:-a.amount,transaction_type:"withdrawal",from_partner_id:a.targetId,to_partner_id:n.user.id,processed_by:n.user.id,memo:`[ê°•ì œì¶œê¸ˆ] ${s.nickname}ì—ê²Œ ${a.amount.toLocaleString()}ì› ì¶œê¸ˆ${a.memo?`: ${a.memo}`:""}`})}else h=r.balance-a.amount,await c.from("partners").update({balance:h,updated_at:new Date().toISOString()}).eq("id",a.targetId),b=s.balance+a.amount,await c.from("partners").update({balance:b,updated_at:new Date().toISOString()}).eq("id",n.user.id),await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:r.balance,balance_after:h,amount:-a.amount,transaction_type:"withdrawal",from_partner_id:a.targetId,to_partner_id:n.user.id,processed_by:n.user.id,memo:`[ê°•ì œì¶œê¸ˆ] ${s.nickname}ì—ê²Œ ${a.amount.toLocaleString()}ì› ì¶œê¸ˆ${a.memo?`: ${a.memo}`:""}`})}Z&&B&&B({type:"partner_balance_updated",data:{partnerId:a.targetId,amount:a.amount,type:a.type}});const $=a.type==="deposit"?t.partnerManagement.depositTypeLabel:t.partnerManagement.withdrawalTypeLabel;u.success(t.partnerManagement.forceTransactionSuccess.replace("{{type}}",$).replace("{{amount}}",a.amount.toLocaleString())),E()}catch(r){console.error("âŒ [íŒŒíŠ¸ë„ˆ ê°•ì œ ì…ì¶œê¸ˆ] ì˜¤ë¥˜:",r)}},we=async()=>{try{if(!n.user)return;const a=new Date().toISOString().split("T")[0],{data:r}=await c.from("transactions").select("transaction_type, amount").eq("partner_id",n.user.id).gte("created_at",a),l=new Date,s=new Date(l.getFullYear(),l.getMonth(),1),d=new Date(l.getFullYear(),l.getMonth()+1,0,23,59,59),{calculateIntegratedSettlement:o}=await Ce(async()=>{const{calculateIntegratedSettlement:m}=await import("./settlementCalculator-DhQR0qso.js");return{calculateIntegratedSettlement:m}},__vite__mapDeps([7,0,1,2,3,4,5,6])),_=await o(n.user.id,{rolling:n.user.commission_rolling||0,losing:n.user.commission_losing||0,withdrawal:n.user.withdrawal_fee||0},s.toISOString(),d.toISOString());La({todayDeposits:r?.filter(m=>m.transaction_type==="deposit").reduce((m,p)=>m+Number(p.amount),0)||0,todayWithdrawals:r?.filter(m=>m.transaction_type==="withdrawal").reduce((m,p)=>m+Number(p.amount),0)||0,monthlyCommission:Math.round(_.netTotalProfit)}),await Va()}catch(a){console.error("[Dashboard Data Fetch Error]:",a)}},Va=async()=>{try{if(!n.user)return;const a=k.map(o=>o.id);if((n.user.level===1?a:[n.user.id,...a]).length===0){Ye([]);return}const l=new Map;(n.user.level===1?k:[n.user,...k]).forEach(o=>{const _=o.partner_type;l.has(_)||l.set(_,{level:o.level,type:o.partner_type,typeName:A[o.partner_type],partnerIds:[]}),l.get(_).partnerIds.push(o.id)});const d=await Promise.all(Array.from(l.values()).map(async o=>{const{data:_}=await c.from("users").select("balance").in("referrer_id",o.partnerIds),m=_?.reduce((p,f)=>p+(f.balance||0),0)||0;return{level:o.level,type:o.type,typeName:o.typeName,partnerCount:o.partnerIds.length,usersBalance:m}}));d.sort((o,_)=>o.level-_.level),Ye(d)}catch(a){console.error("ë ˆë²¨ë³„ ë¶„í¬ ì¡°íšŒ ì˜¤ë¥˜:",a)}},Ne=async a=>{if(!n.user)return{hasGap:!0,missingLevels:[],directParentId:null,message:"ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."};const r=n.user.level,l=Se(a);if(r===1)return{hasGap:!1,missingLevels:[],directParentId:n.user.id,message:""};if(l===r+1)return{hasGap:!1,missingLevels:[],directParentId:n.user.id,message:""};const s=[];let d=null;for(let m=r+1;m<l;m++){const{data:p,error:f}=await c.from("partners").select("id, level, partner_type, nickname").eq("level",m).eq("status","active");if(f){console.error(`ë ˆë²¨ ${m} íŒŒíŠ¸ë„ˆ ì¡°íšŒ ì˜¤ë¥˜:`,f);continue}const{data:b,error:h}=await c.rpc("get_hierarchical_partners",{p_partner_id:n.user.id});if(h){console.error("ê³„ì¸µ íŒŒíŠ¸ë„ˆ ì¡°íšŒ ì˜¤ë¥˜:",h),s.push(m);continue}(b||[]).filter(x=>x.level===m&&x.status==="active").length===0&&s.push(m)}if(s.length===0){const m=l-1,{data:p}=await c.rpc("get_hierarchical_partners",{p_partner_id:n.user.id}),f=(p||[]).filter(b=>b.level===m&&b.status==="active");f.length>0&&(d=f.sort((b,h)=>new Date(h.created_at).getTime()-new Date(b.created_at).getTime())[0].id)}const o={2:"ëŒ€ë³¸ì‚¬",3:"ë³¸ì‚¬",4:"ë¶€ë³¸ì‚¬",5:"ì´íŒ",6:"ë§¤ì¥"};let _="";if(s.length>0){const m=s.map(p=>o[p]||`Level ${p}`).join(", ");_=`âš ï¸ ${A[a]}ì„(ë¥¼) ìƒì„±í•˜ë ¤ë©´ ë¨¼ì € ì¤‘ê°„ ê³„ì¸µ(${m})ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.`}return{hasGap:s.length>0,missingLevels:s,directParentId:d,message:_}},Ga=a=>{if(!n.user)return!1;const r=n.user.level,l=Se(a);return r===1?!0:r===2?l>2:l>r},Se=a=>({system_admin:1,head_office:2,main_office:3,sub_office:4,distributor:5,store:6})[a],ca=()=>{y({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:"",opcode:"",secret_key:"",api_token:"",commission_rolling:xe.rolling,commission_losing:xe.losing,withdrawal_fee:xe.fee})},da=a=>{y({username:a.username,nickname:a.nickname,password:"",partner_type:a.partner_type,parent_id:a.parent_id||"",opcode:a.opcode||"",secret_key:a.secret_key||"",api_token:a.api_token||"",commission_rolling:a.commission_rolling,commission_losing:a.commission_losing,withdrawal_fee:a.withdrawal_fee})},Ha=a=>{const r=new Map,l=[];return a.forEach(s=>{r.set(s.id,{...s,children:[]})}),a.forEach(s=>{const d=r.get(s.id);if(d)if(s.parent_id&&r.has(s.parent_id)){const o=r.get(s.parent_id);o&&o.children&&o.children.push(d)}else l.push(d)}),l},ma=a=>{ge(r=>{const l=new Set(r);return l.has(a)?l.delete(a):l.add(a),l})},Ra=()=>{if(Je)ge(new Set),Qe(!1);else{const a=new Set,r=l=>{l.forEach(s=>{s.children&&s.children.length>0&&(a.add(s.id),r(s.children))})};r(Me),ge(a),Qe(!0)}},za=k.filter(a=>{const r=a.username.toLowerCase().includes(le.toLowerCase())||a.nickname.toLowerCase().includes(le.toLowerCase()),l=ie==="all"||a.partner_type===ie,s=oe==="all"||a.status===oe;return r&&l&&s}),Me=Ha(za),pa=(a,r)=>{const l=ue.has(a.id),s=a.children&&a.children.length>0,d=r*24;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 p-2.5 rounded-lg hover:bg-slate-800/50 transition-colors border border-slate-700/30 bg-slate-800/20 min-w-[1200px]",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-[130px] flex-shrink-0",style:{paddingLeft:`${d}px`},children:[e.jsx("button",{onClick:()=>s&&ma(a.id),className:`flex items-center justify-center w-5 h-5 rounded transition-colors flex-shrink-0 ${s?"hover:bg-slate-700 text-slate-300 cursor-pointer":"invisible"}`,children:s&&(l?e.jsx(Ge,{className:"h-3 w-3"}):e.jsx(He,{className:"h-3 w-3"}))}),e.jsx("span",{className:"font-medium text-white text-sm truncate",children:a.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("div",{className:"min-w-[90px] flex-shrink-0",children:e.jsx("span",{className:"text-slate-300 text-sm truncate",children:a.nickname})}),e.jsx("div",{className:"min-w-[85px] flex-shrink-0",children:e.jsx(I,{className:`${W[a.partner_type]} text-white text-xs`,children:A[a.partner_type]})}),e.jsx("div",{className:"min-w-[60px] flex-shrink-0",children:e.jsx(I,{className:`${_a[a.status]} text-white text-xs`,children:We[a.status]})}),e.jsxs("div",{className:"min-w-[110px] text-right flex-shrink-0",children:[e.jsxs("span",{className:"font-mono text-green-400 text-sm",children:[a.level===1||a.level===2?((a.invest_balance||0)+(a.oroplay_balance||0)).toLocaleString():a.balance.toLocaleString(),"ì›"]}),(a.level===1||a.level===2)&&e.jsxs("div",{className:"text-[10px] text-slate-400 mt-0.5",children:["(I:",(a.invest_balance||0).toLocaleString()," + O:",(a.oroplay_balance||0).toLocaleString(),")"]})]}),e.jsx("div",{className:"min-w-[170px] flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[e.jsxs(I,{variant:"outline",className:"bg-green-500/10 text-green-400 border-green-500/30 text-xs px-1",children:["R:",a.commission_rolling,"%"]}),e.jsxs(I,{variant:"outline",className:"bg-orange-500/10 text-orange-400 border-orange-500/30 text-xs px-1",children:["L:",a.commission_losing,"%"]}),e.jsxs(I,{variant:"outline",className:"bg-blue-500/10 text-blue-400 border-blue-500/30 text-xs px-1",children:["F:",a.withdrawal_fee,"%"]})]})}),e.jsxs("div",{className:"flex items-center gap-1.5 min-w-[110px] flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(O,{className:"h-3 w-3 text-slate-400"}),e.jsx("span",{className:"text-xs text-slate-400",children:a.child_count||0})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ve,{className:"h-3 w-3 text-slate-400"}),e.jsx("span",{className:"text-xs text-slate-400",children:a.user_count||0})]})]}),e.jsx("div",{className:"min-w-[120px] flex-shrink-0",children:a.last_login_at?(()=>{const o=new Date(a.last_login_at),_=o.getFullYear(),m=String(o.getMonth()+1).padStart(2,"0"),p=String(o.getDate()).padStart(2,"0"),f=String(o.getHours()).padStart(2,"0"),b=String(o.getMinutes()).padStart(2,"0");return e.jsx("span",{className:"text-xs text-slate-400",children:`${_}/${m}/${p} ${f}:${b}`})})():e.jsx("span",{className:"text-xs text-slate-600",children:"-"})})]}),e.jsxs("div",{className:"flex items-center gap-1.5 w-[240px] flex-shrink-0",children:[(n.user?.level===1&&a.partner_type==="head_office"||a.parent_id===n.user?.id&&a.partner_type!=="head_office")&&e.jsxs(e.Fragment,{children:[e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{Ze(a),_e("deposit"),fe(!0)},className:"bg-green-500/10 border-green-500/50 text-green-400 hover:bg-green-500/20 flex-shrink-0",title:n.user?.level===1&&a.partner_type==="head_office"?"ì…ê¸ˆ":"ë³´ìœ ê¸ˆ ì§€ê¸‰",children:e.jsx(se,{className:"h-4 w-4"})}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{Ze(a),_e("withdrawal"),fe(!0)},className:"bg-orange-500/10 border-orange-500/50 text-orange-400 hover:bg-orange-500/20 flex-shrink-0",title:n.user?.level===1&&a.partner_type==="head_office"?"ì¶œê¸ˆ":"ë³´ìœ ê¸ˆ íšŒìˆ˜",children:e.jsx(ha,{className:"h-4 w-4"})})]}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{ee(a),da(a),Y(!0)},className:"bg-blue-500/10 border-blue-500/50 text-blue-400 hover:bg-blue-500/20 flex-shrink-0",children:e.jsx(xa,{className:"h-3 w-3"})}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{u.info(`${a.nickname} íŒŒíŠ¸ë„ˆì˜ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.`)},className:"bg-slate-700/50 border-slate-600 text-slate-300 hover:bg-slate-700 flex-shrink-0",children:e.jsx(Re,{className:"h-3 w-3"})}),a.partner_type!=="system_admin"&&e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{re(a),Q(""),J(!0)},className:"bg-red-500/10 border-red-500/50 text-red-400 hover:bg-red-500/20 flex-shrink-0",children:e.jsx(ze,{className:"h-3 w-3"})})]})]}),l&&s&&e.jsx("div",{className:"mt-1 space-y-1",children:a.children.map(o=>pa(o,r+1))})]},a.id)};return t.partnerManagement.partnerUsername,t.partnerManagement.partnerNickname,t.partnerManagement.partnerGrade,t.partnerManagement.parentPartner,t.partnerManagement.status,t.partnerManagement.balance,g.useEffect(()=>{ia(),la(),E(),we()},[]),g.useEffect(()=>{pe==="dashboard"&&we()},[pe]),z&&k.length===0?e.jsx(ua,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:t.partnerManagement.title}),e.jsx("p",{className:"text-sm text-slate-400",children:n.user?.nickname})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{onClick:Ra,variant:"outline",className:"border-blue-500/30 bg-blue-500/10 text-blue-300 hover:bg-blue-500/20 hover:border-blue-400/50",children:Je?e.jsxs(e.Fragment,{children:[e.jsx(Ge,{className:"h-4 w-4 mr-2"}),t.partnerManagement.collapseView]}):e.jsxs(e.Fragment,{children:[e.jsx(He,{className:"h-4 w-4 mr-2"}),t.partnerManagement.expandView]})}),e.jsxs(S,{onClick:()=>Sa(!me),variant:"outline",className:"border-slate-700 text-slate-300 hover:bg-slate-700/50",children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),me?t.partnerManagement.listViewToggle:t.partnerManagement.hierarchyViewToggle]}),e.jsxs(S,{variant:"outline",className:"border-slate-700 text-slate-300 hover:bg-slate-700/50",children:[e.jsx(tr,{className:"h-4 w-4 mr-2"}),t.partnerManagement.export]}),e.jsxs(S,{onClick:()=>ae(!0),children:[e.jsx(nr,{className:"h-4 w-4 mr-2"}),t.partnerManagement.createPartner]})]})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-4",children:[e.jsx(T,{title:t.partnerManagement.allSubPartners,value:k.filter(a=>a.id!==n.user?.id).length.toLocaleString(),subtitle:t.partnerManagement.managingPartners,icon:O,color:"purple"}),n.user?.level===2&&e.jsx(T,{title:t.partnerManagement.mainOffice,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="main_office").length.toLocaleString(),subtitle:`${t.partnerManagement.mainOffice} ${t.partnerManagement.partnerLabel}`,icon:X,color:"red"}),n.user?.level===3&&e.jsx(T,{title:t.partnerManagement.subOffice,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="sub_office").length.toLocaleString(),subtitle:`${t.partnerManagement.subOffice} ${t.partnerManagement.partnerLabel}`,icon:X,color:"red"}),n.user?.level===4&&e.jsx(T,{title:t.partnerManagement.distributor,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="distributor").length.toLocaleString(),subtitle:`${t.partnerManagement.distributor} ${t.partnerManagement.partnerLabel}`,icon:X,color:"red"}),n.user?.level===2&&e.jsx(T,{title:t.partnerManagement.subOfficeDistributorStore,value:k.filter(a=>a.id!==n.user?.id&&(a.partner_type==="sub_office"||a.partner_type==="distributor"||a.partner_type==="store")).length.toLocaleString(),subtitle:t.partnerManagement.subPartnerLabel,icon:O,color:"orange"}),n.user?.level===3&&e.jsx(T,{title:t.partnerManagement.distributorStore,value:k.filter(a=>a.id!==n.user?.id&&(a.partner_type==="distributor"||a.partner_type==="store")).length.toLocaleString(),subtitle:t.partnerManagement.subPartnerLabel,icon:O,color:"orange"}),n.user?.level===4&&e.jsx(T,{title:t.partnerManagement.storePartner,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="store").length.toLocaleString(),subtitle:t.partnerManagement.storePartnerLabel,icon:O,color:"orange"}),n.user?.level===5&&e.jsxs(e.Fragment,{children:[e.jsx(T,{title:t.partnerManagement.storePartner,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="store").length.toLocaleString(),subtitle:t.partnerManagement.storePartnerLabel,icon:X,color:"red"}),e.jsx(T,{title:t.partnerManagement.emptyLabel,value:"0",subtitle:t.partnerManagement.noSubPartnerLabel,icon:O,color:"orange"})]}),(n.user?.level===1||n.user?.level===6)&&e.jsxs(e.Fragment,{children:[e.jsx(T,{title:t.partnerManagement.headOfficePartner,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="head_office").length.toLocaleString(),subtitle:t.partnerManagement.headOfficePartnerLabel,icon:X,color:"red"}),e.jsx(T,{title:t.partnerManagement.mainSubOffice,value:k.filter(a=>a.id!==n.user?.id&&(a.partner_type==="main_office"||a.partner_type==="sub_office")).length.toLocaleString(),subtitle:t.partnerManagement.middlePartner,icon:O,color:"orange"})]}),e.jsx(T,{title:t.partnerManagement.activePartners,value:k.filter(a=>a.id!==n.user?.id&&a.status==="active").length.toLocaleString(),subtitle:t.partnerManagement.normalOperation,icon:Re,color:"green"})]}),e.jsxs(Xa,{value:pe,onValueChange:Ma,className:"space-y-6",children:[e.jsx("div",{className:"bg-slate-800/30 rounded-xl p-1.5 border border-slate-700/40",children:e.jsxs(Za,{className:"bg-transparent h-auto p-0 border-0 gap-2 w-full grid grid-cols-2",children:[e.jsx(ga,{value:"hierarchy",className:"bg-transparent text-slate-400 rounded-lg px-6 py-3 data-[state=active]:bg-gradient-to-br data-[state=active]:from-blue-500/20 data-[state=active]:to-cyan-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-blue-500/20 data-[state=active]:border data-[state=active]:border-blue-400/30 transition-all duration-200",children:t.partnerManagement.partnerHierarchyManagement}),e.jsx(ga,{value:"dashboard",className:"bg-transparent text-slate-400 rounded-lg px-6 py-3 data-[state=active]:bg-gradient-to-br data-[state=active]:from-purple-500/20 data-[state=active]:to-pink-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-purple-500/20 data-[state=active]:border data-[state=active]:border-purple-400/30 transition-all duration-200",children:t.partnerManagement.partnerDashboard})]})}),e.jsx(Ie,{value:"hierarchy",className:"space-y-4",children:e.jsxs(V,{className:"bg-slate-900/40 border-slate-700/50 backdrop-blur",children:[e.jsxs(G,{children:[e.jsx(H,{className:"text-white",children:t.partnerManagement.hierarchyManagementTitle}),e.jsx(Pe,{className:"text-slate-400",children:t.partnerManagement.hierarchyManagementDesc})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(sr,{className:"absolute left-2 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(M,{placeholder:t.partnerManagement.searchIdOrNickname,className:"pl-8 bg-slate-800/50 border-slate-700 text-white",value:le,onChange:a=>va(a.target.value)})]})}),e.jsxs(Te,{value:ie,onValueChange:ba,children:[e.jsx(De,{className:"w-[180px] bg-slate-800/50 border-slate-700 text-white",children:e.jsx(Ee,{placeholder:t.partnerManagement.partnerGradeFilter})}),e.jsxs($e,{children:[e.jsx(P,{value:"all",children:t.partnerManagement.allGrades}),e.jsx(P,{value:"head_office",children:t.partnerManagement.headOffice}),e.jsx(P,{value:"main_office",children:t.partnerManagement.mainOffice}),e.jsx(P,{value:"sub_office",children:t.partnerManagement.subOffice}),e.jsx(P,{value:"distributor",children:t.partnerManagement.distributor}),e.jsx(P,{value:"store",children:t.partnerManagement.store})]})]}),e.jsxs(Te,{value:oe,onValueChange:ya,children:[e.jsx(De,{className:"w-[180px] bg-slate-800/50 border-slate-700 text-white",children:e.jsx(Ee,{placeholder:t.partnerManagement.statusFilter})}),e.jsxs($e,{children:[e.jsx(P,{value:"all",children:t.partnerManagement.allStatus}),e.jsx(P,{value:"active",children:t.partnerManagement.active}),e.jsx(P,{value:"inactive",children:t.partnerManagement.inactive}),e.jsx(P,{value:"blocked",children:t.partnerManagement.blocked})]})]})]}),e.jsx("div",{className:"mb-3 px-3 py-2 bg-slate-800/50 rounded-lg border border-slate-700/30",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"min-w-[130px] flex-shrink-0",children:e.jsx("div",{className:"text-xs font-medium text-slate-400",children:t.partnerManagement.id})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("div",{className:"min-w-[90px] text-xs font-medium text-slate-400",children:t.partnerManagement.nickname}),e.jsx("div",{className:"min-w-[85px] text-xs font-medium text-slate-400",children:t.partnerManagement.gradeLabel}),e.jsx("div",{className:"min-w-[60px] text-xs font-medium text-slate-400",children:t.partnerManagement.statusLabel}),e.jsx("div",{className:"min-w-[110px] text-xs font-medium text-slate-400 text-right",children:t.partnerManagement.balanceLabel}),e.jsx("div",{className:"min-w-[170px] text-xs font-medium text-slate-400",children:t.partnerManagement.commissionLabel}),e.jsx("div",{className:"min-w-[110px] text-xs font-medium text-slate-400",children:t.partnerManagement.subMembers}),e.jsx("div",{className:"min-w-[120px] text-xs font-medium text-slate-400",children:t.partnerManagement.recentAccess})]}),e.jsx("div",{className:"w-[240px] text-xs font-medium text-slate-400 text-center flex-shrink-0",children:t.partnerManagement.management})]})}),z?e.jsx(ua,{}):Me.length===0?e.jsx("div",{className:"text-center py-12 text-slate-400",children:t.partnerManagement.noPartners}):e.jsx("div",{className:"space-y-1 overflow-x-auto",children:Me.map(a=>pa(a,0))})]})]})}),e.jsx(Ie,{value:"transactions",className:"space-y-4",children:e.jsx(er,{})}),e.jsx(Ie,{value:"dashboard",className:"space-y-4",children:e.jsxs(V,{className:"bg-slate-900/40 border-slate-700/50 backdrop-blur",children:[e.jsxs(G,{children:[e.jsxs(H,{className:"flex items-center gap-2 text-white",children:[e.jsx(lr,{className:"h-5 w-5"}),"íŒŒíŠ¸ë„ˆ ëŒ€ì‹œë³´ë“œ"]}),e.jsx(Pe,{className:"text-slate-400",children:"íŒŒíŠ¸ë„ˆë³„ ì„±ê³¼ ë° ìˆ˜ìµ í˜„í™©ì„ í™•ì¸í•©ë‹ˆë‹¤."})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3 mb-6",children:[e.jsxs(V,{children:[e.jsxs(G,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(H,{className:"text-sm font-medium",children:"ì´ë²ˆë‹¬ ìˆœìˆ˜ìµ"}),e.jsx(se,{className:"h-4 w-4 text-green-500"})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[(ka.monthlyCommission||0).toLocaleString(),"ì›"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"ë‚´ ìˆ˜ì… - í•˜ìœ„ íŒŒíŠ¸ë„ˆ ì§€ê¸‰"})]})]}),e.jsxs(V,{children:[e.jsxs(G,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(H,{className:"text-sm font-medium",children:"ì´ íŒŒíŠ¸ë„ˆ ìˆ˜"}),e.jsx(O,{className:"h-4 w-4 text-blue-500"})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[k.length.toLocaleString(),"ê°œ"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"+2 new this month"})]})]}),e.jsxs(V,{children:[e.jsxs(G,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(H,{className:"text-sm font-medium",children:"í™œì„± íšŒì› ìˆ˜"}),e.jsx(Ve,{className:"h-4 w-4 text-purple-500"})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[k.reduce((a,r)=>a+(r.user_count||0),0).toLocaleString(),"ëª…"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"+5% from last month"})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(V,{children:[e.jsx(G,{children:e.jsx(H,{className:"text-lg",children:"ìƒìœ„ ì„±ê³¼ íŒŒíŠ¸ë„ˆ"})}),e.jsx(R,{children:e.jsx("div",{className:"space-y-3",children:k.filter(a=>a.partner_type!=="system_admin").sort((a,r)=>(r.user_count||0)-(a.user_count||0)).slice(0,5).map((a,r)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(I,{className:`${W[a.partner_type]} text-white`,children:["#",r+1]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.nickname}),e.jsx("p",{className:"text-sm text-muted-foreground",children:A[a.partner_type]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-medium",children:[a.user_count||0,"ëª…"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"ê´€ë¦¬ íšŒì›"})]})]},a.id))})})]}),e.jsxs(V,{children:[e.jsxs(G,{children:[e.jsx(H,{className:"text-lg",children:"íŒŒíŠ¸ë„ˆ ë ˆë²¨ë³„ ë¶„í¬"}),e.jsx(Pe,{className:"text-xs",children:"ê° ë ˆë²¨ íŒŒíŠ¸ë„ˆë“¤ì´ ë³´ìœ í•œ ì‚¬ìš©ìë“¤ì˜ ì´ ë³´ìœ ê¸ˆ"})]}),e.jsx(R,{children:e.jsx("div",{className:"space-y-4",children:te.length>0?e.jsxs(e.Fragment,{children:[te.map(a=>{const r=Math.max(...te.map(s=>s.usersBalance),1),l=Math.round(a.usersBalance/r*100);return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(I,{className:`${W[a.type]} text-white text-xs`,children:["LV.",a.level]}),e.jsx("span",{className:"text-sm font-medium",children:a.typeName}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",a.partnerCount,"ê°œ)"]})]}),e.jsxs("span",{className:"text-sm font-medium text-blue-600",children:["â‚©",a.usersBalance.toLocaleString()]})]}),e.jsx("div",{className:"w-full bg-slate-800/40 rounded-full h-3 overflow-hidden",children:e.jsx("div",{className:`h-3 rounded-full transition-all duration-500 ${W[a.type]}`,style:{width:`${Math.max(l,2)}%`}})})]},a.type)}),e.jsx("div",{className:"pt-3 border-t border-slate-700/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-slate-300",children:"ì´ ì‚¬ìš©ì ë³´ìœ ê¸ˆ"}),e.jsxs("span",{className:"text-sm font-bold text-emerald-400",children:["â‚©",te.reduce((a,r)=>a+r.usersBalance,0).toLocaleString()]})]})})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground text-sm",children:"í•˜ìœ„ íŒŒíŠ¸ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤"})})})]})]})]})]})})]}),e.jsx(Fe,{open:ja,onOpenChange:ae,children:e.jsxs(Oe,{className:"sm:max-w-[600px] max-h-[80vh] overflow-y-auto",children:[e.jsxs(Be,{children:[e.jsx(Ae,{children:t.partnerManagement.newPartner}),e.jsx(qe,{children:t.partnerManagement.createPartnerDescription})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"username",children:t.partnerManagement.partnerUsername}),e.jsx(M,{id:"username",value:i.username,onChange:a=>y(r=>({...r,username:a.target.value})),placeholder:t.partnerManagement.partnerUsernameInput})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"nickname",children:t.partnerManagement.partnerNickname}),e.jsx(M,{id:"nickname",value:i.nickname,onChange:a=>y(r=>({...r,nickname:a.target.value})),placeholder:t.partnerManagement.partnerNicknameInput})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"password",children:t.common.password}),e.jsx(M,{id:"password",type:"password",value:i.password,onChange:a=>y(r=>({...r,password:a.target.value})),placeholder:t.partnerManagement.initialPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"partner_type",children:t.partnerManagement.partnerGrade}),e.jsxs(Te,{value:i.partner_type,onValueChange:async a=>{if(y(r=>({...r,partner_type:a})),n.user?.level!==1){const r=await Ne(a);if(Xe(r.message),r.directParentId&&!r.hasGap){const l=await sa(r.directParentId);l&&(je(l),console.log(`âœ… ${A[a]} ìƒìœ„ íŒŒíŠ¸ë„ˆ ì»¤ë¯¸ì…˜ ë¡œë“œ:`,l))}}else a==="head_office"&&je({rolling:100,losing:100,fee:100,nickname:t.partnerManagement.system})},children:[e.jsx(De,{children:e.jsx(Ee,{})}),e.jsxs($e,{children:[n.user?.level===1&&e.jsx(P,{value:"head_office",children:t.partnerManagement.headOffice}),n.user?.level===2&&e.jsx(P,{value:"main_office",children:t.partnerManagement.mainOffice}),n.user?.level===3&&e.jsx(P,{value:"sub_office",children:t.partnerManagement.subOffice}),n.user?.level===4&&e.jsx(P,{value:"distributor",children:t.partnerManagement.distributor}),n.user?.level===5&&e.jsx(P,{value:"store",children:t.partnerManagement.store})]})]}),he&&e.jsx("div",{className:"p-3 bg-red-50 dark:bg-red-900/10 rounded-lg border border-red-200 dark:border-red-800",children:e.jsx("p",{className:"text-xs text-red-700 dark:text-red-300",children:he})})]})]}),i.partner_type==="head_office"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(w,{htmlFor:"opcode",className:"flex items-center gap-2",children:[e.jsx(fa,{className:"h-4 w-4"}),"OPCODE"]}),e.jsx(M,{id:"opcode",value:i.opcode,onChange:a=>y(r=>({...r,opcode:a.target.value})),placeholder:t.partnerManagement.opcodeInput})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"secret_key",children:t.partnerManagement.secretKey}),e.jsx(M,{id:"secret_key",value:i.secret_key,onChange:a=>y(r=>({...r,secret_key:a.target.value})),placeholder:t.partnerManagement.secretKeyInput})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"api_token",children:t.partnerManagement.token}),e.jsx(M,{id:"api_token",value:i.api_token,onChange:a=>y(r=>({...r,api_token:a.target.value})),placeholder:t.partnerManagement.apiTokenInput})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4 text-green-500"}),t.partnerManagement.commissionSettingsLabel]}),i.partner_type!=="head_office"&&j&&e.jsxs(I,{variant:"outline",className:"text-xs",children:[t.partnerManagement.upperLimit," ",j.rolling,"% / ",j.losing,"%"]})]}),i.partner_type==="head_office"?e.jsx("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/10 rounded-lg border border-purple-200 dark:border-purple-800",children:e.jsx("p",{className:"text-xs text-purple-700 dark:text-purple-300",dangerouslySetInnerHTML:{__html:t.partnerManagement.headOfficeNote}})}):e.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-900/10 rounded-lg border border-blue-200 dark:border-blue-800",children:e.jsx("p",{className:"text-xs text-blue-700 dark:text-blue-300",children:t.partnerManagement.commissionCreateNote})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"commission_rolling",children:t.partnerManagement.rollingCommissionLabel}),e.jsx(M,{id:"commission_rolling",type:"text",step:"0.1",min:"0",max:i.partner_type==="head_office"?100:j?.rolling||100,value:i.partner_type==="head_office"?100:i.commission_rolling,onChange:a=>{if(i.partner_type==="head_office")return;const r=a.target.value;if(r===""){y(d=>({...d,commission_rolling:0}));return}const l=parseFloat(r);if(isNaN(l))return;const s=j?.rolling||100;if(l>s){u.error(t.partnerManagement.rollingExceedError.replace("{{max}}",s.toString()));return}y(d=>({...d,commission_rolling:l}))},disabled:i.partner_type==="head_office",className:i.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.partner_type==="head_office"?t.partnerManagement.headOfficeFixed:t.partnerManagement.totalBettingAmount})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"commission_losing",children:t.partnerManagement.losingCommissionLabel}),e.jsx(M,{id:"commission_losing",type:"text",step:"0.1",min:"0",max:i.partner_type==="head_office"?100:j?.losing||100,value:i.partner_type==="head_office"?100:i.commission_losing,onChange:a=>{if(i.partner_type==="head_office")return;const r=a.target.value;if(r===""){y(d=>({...d,commission_losing:0}));return}const l=parseFloat(r);if(isNaN(l))return;const s=j?.losing||100;if(l>s){u.error(t.partnerManagement.losingExceedError.replace("{{max}}",s.toString()));return}y(d=>({...d,commission_losing:l}))},disabled:i.partner_type==="head_office",className:i.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.partner_type==="head_office"?t.partnerManagement.headOfficeFixed:t.partnerManagement.memberNetLoss})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"withdrawal_fee",children:t.partnerManagement.withdrawalFeeLabel}),e.jsx(M,{id:"withdrawal_fee",type:"text",step:"0.1",min:"0",max:i.partner_type==="head_office"?100:j?.fee||100,value:i.partner_type==="head_office"?100:i.withdrawal_fee,onChange:a=>{if(i.partner_type==="head_office")return;const r=a.target.value;if(r===""){y(d=>({...d,withdrawal_fee:0}));return}const l=parseFloat(r);if(isNaN(l))return;const s=j?.fee||100;if(l>s){u.error(t.partnerManagement.feeExceedError.replace("{{max}}",s.toString()));return}y(d=>({...d,withdrawal_fee:l}))},disabled:i.partner_type==="head_office",className:i.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.partner_type==="head_office"?t.partnerManagement.headOfficeFixed:t.partnerManagement.withdrawalFeeDesc})]})]})]})]}),e.jsxs(Ue,{children:[e.jsx(S,{variant:"outline",onClick:()=>{ae(!1),ca(),Xe("")},children:t.common.cancel}),e.jsx(S,{onClick:Ba,disabled:z||!!he&&n.user?.level!==1,children:z?t.partnerManagement.creating:t.partnerManagement.createPartnerButton})]})]})}),e.jsx(Fe,{open:wa,onOpenChange:Y,children:e.jsxs(Oe,{className:"sm:max-w-[600px] max-h-[80vh] overflow-y-auto",children:[e.jsxs(Be,{children:[e.jsx(Ae,{children:"íŒŒíŠ¸ë„ˆ ì •ë³´ ìˆ˜ì •"}),e.jsx(qe,{children:"íŒŒíŠ¸ë„ˆì˜ ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_username",children:"ì•„ì´ë””"}),e.jsx(M,{id:"edit_username",value:i.username,disabled:!0,className:"bg-muted"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_nickname",children:"ë‹‰ë„¤ì„"}),e.jsx(M,{id:"edit_nickname",value:i.nickname,onChange:a=>y(r=>({...r,nickname:a.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_password",children:t.partnerManagement.passwordChangeOnly}),e.jsx(M,{id:"edit_password",type:"password",value:i.password,onChange:a=>y(r=>({...r,password:a.target.value})),placeholder:t.partnerManagement.passwordChangeHint}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.partnerManagement.passwordChangeNote})]}),L?.partner_type==="head_office"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(w,{htmlFor:"edit_opcode",className:"flex items-center gap-2",children:[e.jsx(fa,{className:"h-4 w-4"}),"OPCODE"]}),e.jsx(M,{id:"edit_opcode",value:i.opcode,onChange:a=>y(r=>({...r,opcode:a.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_secret_key",children:"Secret Key"}),e.jsx(M,{id:"edit_secret_key",value:i.secret_key,onChange:a=>y(r=>({...r,secret_key:a.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_api_token",children:"API Token"}),e.jsx(M,{id:"edit_api_token",value:i.api_token,onChange:a=>y(r=>({...r,api_token:a.target.value}))})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4 text-green-500"}),"ì»¤ë¯¸ì…˜ ì„¤ì •"]}),L?.partner_type!=="head_office"&&j&&e.jsxs(I,{variant:"outline",className:"text-xs",children:["ìƒìœ„ í•œë„: ",j.rolling,"% / ",j.losing,"% / ",j.fee,"%"]})]}),L?.partner_type==="head_office"?e.jsx("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/10 rounded-lg border border-purple-200 dark:border-purple-800",children:e.jsxs("p",{className:"text-xs text-purple-700 dark:text-purple-300",children:["ğŸ¢ ",e.jsx("strong",{children:"ëŒ€ë³¸ì‚¬"}),"ëŠ” ìµœìƒìœ„ íŒŒíŠ¸ë„ˆë¡œ ì»¤ë¯¸ì…˜ì´ ",e.jsx("strong",{children:"100%"}),"ë¡œ ê³ ì •ë©ë‹ˆë‹¤."]})}):e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-900/10 rounded-lg border border-amber-200 dark:border-amber-800",children:e.jsx("p",{className:"text-xs text-amber-700 dark:text-amber-300",children:"âš ï¸ ì»¤ë¯¸ì…˜ ë³€ê²½ ì‹œ ì •ì‚°ì— ì¦‰ì‹œ ë°˜ì˜ë˜ë©°, ìƒìœ„ íŒŒíŠ¸ë„ˆ ìš”ìœ¨ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_commission_rolling",children:"ë¡¤ë§ ì»¤ë¯¸ì…˜ (%)"}),e.jsx(M,{id:"edit_commission_rolling",type:"number",step:"0.1",min:"0",max:L?.partner_type==="head_office"?100:j?.rolling||100,value:i.commission_rolling,onChange:a=>y(r=>({...r,commission_rolling:parseFloat(a.target.value)||0})),disabled:L?.partner_type==="head_office",className:L?.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:L?.partner_type==="head_office"?"ëŒ€ë³¸ì‚¬ ê³ ì •ê°’":"íšŒì› ì´ ë² íŒ…ì•¡ Ã— ì»¤ë¯¸ì…˜ ìš”ìœ¨"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_commission_losing",children:"ë£¨ì§• ì»¤ë¯¸ì…˜ (%)"}),e.jsx(M,{id:"edit_commission_losing",type:"number",step:"0.1",min:"0",max:L?.partner_type==="head_office"?100:j?.losing||100,value:i.commission_losing,onChange:a=>y(r=>({...r,commission_losing:parseFloat(a.target.value)||0})),disabled:L?.partner_type==="head_office",className:L?.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:L?.partner_type==="head_office"?"ëŒ€ë³¸ì‚¬ ê³ ì •ê°’":"íšŒì› ìˆœì†ì‹¤ì•¡ Ã— ì»¤ë¯¸ì…˜ ìš”ìœ¨"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_withdrawal_fee",children:"í™˜ì „ ìˆ˜ìˆ˜ë£Œ (%)"}),e.jsx(M,{id:"edit_withdrawal_fee",type:"number",step:"0.1",min:"0",max:L?.partner_type==="head_office"?100:j?.fee||100,value:i.withdrawal_fee,onChange:a=>y(r=>({...r,withdrawal_fee:parseFloat(a.target.value)||0})),disabled:L?.partner_type==="head_office",className:L?.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:L?.partner_type==="head_office"?"ëŒ€ë³¸ì‚¬ ê³ ì •ê°’":"í™˜ì „ ê¸ˆì•¡ì— ì ìš©ë˜ëŠ” ìˆ˜ìˆ˜ë£Œ"})]})]})]})]}),e.jsxs(Ue,{children:[e.jsx(S,{variant:"outline",onClick:()=>{Y(!1),ee(null)},children:"ì·¨ì†Œ"}),e.jsx(S,{onClick:Aa,disabled:z,children:z?"ìˆ˜ì • ì¤‘...":"ìˆ˜ì • ì™„ë£Œ"})]})]})}),e.jsx(Fe,{open:Na,onOpenChange:J,children:e.jsxs(Oe,{className:"sm:max-w-[500px]",children:[e.jsxs(Be,{children:[e.jsx(Ae,{className:"text-red-600",children:"âš ï¸ íŒŒíŠ¸ë„ˆ ì‚­ì œ í™•ì¸"}),e.jsx(qe,{children:"ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚­ì œí•˜ë ¤ë©´ ì•„ë˜ì— íŒŒíŠ¸ë„ˆ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."})]}),C&&e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"íŒŒíŠ¸ë„ˆ"}),e.jsxs("span",{className:"font-medium",children:[C.nickname," (",C.username,")"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"ë“±ê¸‰"}),e.jsx(I,{className:`${W[C.partner_type]} text-white`,children:A[C.partner_type]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"í•˜ìœ„ íŒŒíŠ¸ë„ˆ"}),e.jsxs("span",{className:"font-medium",children:[C.child_count||0,"ëª…"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"ê´€ë¦¬ íšŒì›"}),e.jsxs("span",{className:"font-medium",children:[C.user_count||0,"ëª…"]})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(w,{htmlFor:"delete-confirm",className:"text-red-600",children:["ì‚­ì œ í™•ì¸: ",e.jsx("span",{className:"font-mono",children:C.username})," ì…ë ¥"]}),e.jsx(M,{id:"delete-confirm",value:ce,onChange:a=>Q(a.target.value),placeholder:"íŒŒíŠ¸ë„ˆ ì•„ì´ë””ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”",className:"border-red-300 focus:border-red-500"})]}),e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg border border-yellow-200 dark:border-yellow-800",children:e.jsxs("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:[e.jsx("strong",{children:"ì£¼ì˜:"})," í•˜ìœ„ íŒŒíŠ¸ë„ˆë‚˜ ê´€ë¦¬ íšŒì›ì´ ìˆìœ¼ë©´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."]})})]}),e.jsxs(Ue,{children:[e.jsx(S,{variant:"outline",onClick:()=>{J(!1),re(null),Q("")},disabled:de,children:"ì·¨ì†Œ"}),e.jsx(S,{variant:"destructive",onClick:qa,disabled:de||ce!==C?.username,children:de?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"ì‚­ì œ ì¤‘..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),"ì‚­ì œ"]})})]})]})}),e.jsx(ar,{open:Ia,onOpenChange:fe,type:Pa,targetType:"partner",selectedTarget:D?{id:D.id,username:D.username,nickname:D.nickname,balance:D.level===2?(D.invest_balance||0)+(D.oroplay_balance||0):D.balance||0,level:D.level,invest_balance:D.invest_balance||0,oroplay_balance:D.oroplay_balance||0}:null,onSubmit:Ua,onTypeChange:_e,currentUserLevel:n.user?.level,currentUserBalance:Ta,currentUserInvestBalance:Ea,currentUserOroplayBalance:$a})]})}export{Cr as PartnerManagement,Cr as default};
