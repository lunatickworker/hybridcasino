import{s as d}from"./index-CGvwOXPh.js";async function g(a){const o=[],e=[a];let i=[a];for(let n=0;n<5&&i.length!==0;n++){const{data:t}=await d.from("partners").select("id").in("parent_id",i);if(t&&t.length>0){const l=t.map(r=>r.id);e.push(...l),i=l}else break}if(e.length>0){const{data:n}=await d.from("users").select("id").in("referrer_id",e);n&&o.push(...n.map(t=>t.id))}return o}async function w(a,o,e,i="all"){if(a.length===0)return{totalBetAmount:0,totalLossAmount:0};let n=d.from("game_records").select("bet_amount, win_amount").in("user_id",a).gte("played_at",o).lte("played_at",e);i!=="all"&&(n=n.eq("api_type",i));const{data:t,error:l}=await n;if(l)return console.error("베팅 데이터 조회 오류:",l),{totalBetAmount:0,totalLossAmount:0};if(!t||t.length===0)return{totalBetAmount:0,totalLossAmount:0};let r=0,s=0;for(const m of t){const c=m.bet_amount||0,_=m.win_amount||0;r+=c;const u=c-_;u>0&&(s+=u)}return{totalBetAmount:r,totalLossAmount:s}}async function h(a,o,e){if(a.length===0)return 0;const{data:i,error:n}=await d.from("transactions").select("amount").in("user_id",a).eq("transaction_type","withdrawal").eq("status","approved").gte("created_at",o).lte("created_at",e);return n?(console.error("출금 데이터 조회 오류:",n),0):i?i.reduce((t,l)=>t+(l.amount||0),0):0}async function f(a,o,e,i,n="all"){try{const t=await g(a);if(t.length===0)return{partner_id:a,partner_username:o.username,partner_nickname:o.nickname,partner_level:o.level,commission_rolling:o.commission_rolling,commission_losing:o.commission_losing,withdrawal_fee:o.withdrawal_fee,total_bet_amount:0,total_loss_amount:0,total_withdrawal_amount:0,rolling_commission:0,losing_commission:0,withdrawal_commission:0,total_commission:0};const{totalBetAmount:l,totalLossAmount:r}=await w(t,e,i,n),s=await h(t,e,i),m=l*(o.commission_rolling/100),c=r*(o.commission_losing/100),_=s*(o.withdrawal_fee/100),u=m+c+_;return{partner_id:a,partner_username:o.username,partner_nickname:o.nickname,partner_level:o.level,commission_rolling:o.commission_rolling,commission_losing:o.commission_losing,withdrawal_fee:o.withdrawal_fee,total_bet_amount:l,total_loss_amount:r,total_withdrawal_amount:s,rolling_commission:m,losing_commission:c,withdrawal_commission:_,total_commission:u}}catch(t){return console.error("파트너 커미션 계산 실패:",t),{partner_id:a,partner_username:o.username,partner_nickname:o.nickname,partner_level:o.level,commission_rolling:o.commission_rolling,commission_losing:o.commission_losing,withdrawal_fee:o.withdrawal_fee,total_bet_amount:0,total_loss_amount:0,total_withdrawal_amount:0,rolling_commission:0,losing_commission:0,withdrawal_commission:0,total_commission:0}}}async function A(a,o,e,i="all"){try{const{data:n,error:t}=await d.from("partners").select("id, username, nickname, level, commission_rolling, commission_losing, withdrawal_fee").eq("parent_id",a).order("level").order("nickname");if(t)return console.error("하위 파트너 조회 오류:",t),[];if(!n||n.length===0)return[];const l=n.map(s=>f(s.id,s,o,e,i));return await Promise.all(l)}catch(n){return console.error("하위 파트너 커미션 계산 실패:",n),[]}}async function y(a,o,e,i,n="all"){try{const t=await g(a);if(t.length===0)return{rolling:0,losing:0,withdrawal:0,total:0};const{totalBetAmount:l,totalLossAmount:r}=await w(t,e,i,n),s=await h(t,e,i),m=l*(o.rolling/100),c=r*(o.losing/100),_=s*(o.withdrawal/100);return{rolling:m,losing:c,withdrawal:_,total:m+c+_}}catch(t){return console.error("내 수입 계산 실패:",t),{rolling:0,losing:0,withdrawal:0,total:0}}}async function p(a,o,e,i="all"){try{const{data:n,error:t}=await d.from("partners").select("id, nickname, commission_rolling, commission_losing, withdrawal_fee").eq("parent_id",a);if(t)return console.error("하위 파트너 조회 오류:",t),{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]};if(!n||n.length===0)return{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]};const l=n.map(_=>P(_,o,e,i)),r=await Promise.all(l);let s=0,m=0,c=0;for(const _ of r)s+=_.rolling_payment,m+=_.losing_payment,c+=_.withdrawal_payment;return{totalRolling:s,totalLosing:m,totalWithdrawal:c,total:s+m+c,details:r}}catch(n){return console.error("파트너 지급 계산 실패:",n),{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]}}}async function P(a,o,e,i="all"){try{const n=await g(a.id);if(n.length===0)return{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:0,losing_payment:0,withdrawal_payment:0,total_payment:0};const{totalBetAmount:t,totalLossAmount:l}=await w(n,o,e,i),r=await h(n,o,e),s=t*(a.commission_rolling/100),m=l*(a.commission_losing/100),c=r*(a.withdrawal_fee/100);return{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:s,losing_payment:m,withdrawal_payment:c,total_payment:s+m+c}}catch(n){return console.error("파트너 지급 계산 실패:",n),{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:0,losing_payment:0,withdrawal_payment:0,total_payment:0}}}async function k(a,o,e,i,n="all"){try{const t=await y(a,o,e,i,n),l=await p(a,e,i,n);return{myRollingIncome:t.rolling,myLosingIncome:t.losing,myWithdrawalIncome:t.withdrawal,myTotalIncome:t.total,partnerRollingPayments:l.totalRolling,partnerLosingPayments:l.totalLosing,partnerWithdrawalPayments:l.totalWithdrawal,partnerTotalPayments:l.total,netRollingProfit:t.rolling-l.totalRolling,netLosingProfit:t.losing-l.totalLosing,netWithdrawalProfit:t.withdrawal-l.totalWithdrawal,netTotalProfit:t.total-l.total}}catch(t){return console.error("통합 정산 계산 실패:",t),{myRollingIncome:0,myLosingIncome:0,myWithdrawalIncome:0,myTotalIncome:0,partnerRollingPayments:0,partnerLosingPayments:0,partnerWithdrawalPayments:0,partnerTotalPayments:0,netRollingProfit:0,netLosingProfit:0,netWithdrawalProfit:0,netTotalProfit:0}}}async function W(a,o,e){if(a.length===0)return 0;const{data:i,error:n}=await d.from("transactions").select("amount").eq("transaction_type","deposit").eq("status","pending").in("user_id",a).gte("created_at",o).lte("created_at",e);return n?(console.error("만충금 조회 오류:",n),0):i?i.reduce((t,l)=>t+Number(l.amount),0):0}export{A as a,k as b,W as c,p as d};
