const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Be3DOFuy.js","assets/react-core-BwkdTuSg.js","assets/vendor-D410aui4.js","assets/radix-ui-omyR4zpf.js","assets/lucide-icons-D2Pw2Rdn.js","assets/supabase-C8Oa5ukG.js","assets/index-CW60_reT.css"])))=>i.map(i=>d[i]);
import{a as H,s as _,B as C,h as D,L as W,I as G,l as q,_ as Q,X as V}from"./index-Be3DOFuy.js";import{r as l,j as a}from"./react-core-BwkdTuSg.js";import{D as X}from"./DataTable-CJW7Gi2n.js";import{k as i}from"./vendor-D410aui4.js";import{Q as E,aw as Y,aq as z}from"./lucide-icons-D2Pw2Rdn.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";import"./table-C50RqMyg.js";function re({user:f}){const{t:e}=H(),[y,M]=l.useState(!1),[w,v]=l.useState(!1),[j,$]=l.useState([]),[p,A]=l.useState(""),[T,R]=l.useState(0),[S,k]=l.useState(null);if(f.level>2)return a.jsx("div",{className:"flex items-center justify-center h-64",children:a.jsxs("div",{className:"text-center space-y-4",children:[a.jsx(E,{className:"h-12 w-12 text-yellow-500 mx-auto"}),a.jsx("p",{className:"text-muted-foreground",children:e("bettingManagement.accessDenied")})]})});l.useEffect(()=>{b()},[]),l.useEffect(()=>{const t=_.channel("game-records-changes").on("postgres_changes",{event:"*",schema:"public",table:"game_records"},m=>{console.log("ðŸŽ® game_records í…Œì´ë¸” ë³€ê²½ ê°ì§€:",m),b()}).subscribe();return()=>{_.removeChannel(t)}},[]);const b=async()=>{try{M(!0),console.log("ðŸ“Š ì „ì²´ ë² íŒ… ë‚´ì—­ ì¡°íšŒ ì‹œìž‘...");const{data:t,error:m,count:r}=await _.from("game_records").select(`
          id,
          external_txid,
          user_id,
          username,
          game_id,
          provider_id,
          bet_amount,
          win_amount,
          balance_before,
          balance_after,
          played_at,
          games(name),
          game_providers(name),
          users!game_records_user_id_fkey(
            referrer_id,
            referrer:partners!users_referrer_id_fkey(nickname)
          )
        `,{count:"exact"}).order("played_at",{ascending:!1}).limit(1e3);if(m)throw console.error("âŒ ì¡°íšŒ ì˜¤ë¥˜:",m),i.error(e("bettingManagement.fetchError"),{description:`${m.message}`}),m;console.log("âœ… ì¡°íšŒ ê²°ê³¼:",{count:r,dataLength:t?.length,sampleData:t?.slice(0,2)});const c=(t||[]).map(s=>({id:s.id,external_txid:s.external_txid||0,user_id:s.user_id,username:s.username||"Unknown",referrer_nickname:s.users?.referrer?.nickname||"-",game_name:s.games?.name||`Game ${s.game_id}`,provider_name:s.game_providers?.name||`Provider ${s.provider_id}`,bet_amount:parseFloat(s.bet_amount||0),win_amount:parseFloat(s.win_amount||0),balance_before:parseFloat(s.balance_before||0),balance_after:parseFloat(s.balance_after||0),played_at:s.played_at,profit_loss:parseFloat(s.win_amount||0)-parseFloat(s.bet_amount||0)}));$(c),R(r||0),c.length===0?i.warning(e("bettingManagement.fetchWarning"),{description:e("bettingManagement.fetchWarningDesc")}):i.success(`âœ… ${c.length}${e("bettingManagement.count")} ${e("bettingManagement.fetchSuccess")} (${e("bettingManagement.totalCount")} ${r}${e("bettingManagement.count")})`)}catch(t){console.error("âŒ ë² íŒ… ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜:",t),i.error(e("bettingManagement.fetchFailed"),{description:t instanceof Error?t.message:e("bettingManagement.unknownError")}),$([])}finally{M(!1)}},B=async()=>{try{v(!0);const{getAdminOpcode:t,isMultipleOpcode:m}=await Q(async()=>{const{getAdminOpcode:n,isMultipleOpcode:u}=await import("./index-Be3DOFuy.js").then(K=>K.a9);return{getAdminOpcode:n,isMultipleOpcode:u}},__vite__mapDeps([0,1,2,3,4,5,6]));let r,c;try{const n=await t(f);if(m(n)){if(n.opcodes.length===0){i.error(e("bettingManagement.noMasterAgent"));return}const u=n.opcodes[0];r=u.opcode,c=u.secretKey,i.info(`${u.partnerName}${e("bettingManagement.syncStarting")}`,{description:`${e("common.total")} ${n.opcodes.length}${e("bettingManagement.syncStartingDesc")}`})}else r=n.opcode,c=n.secretKey,console.log(`âœ… ${f.partner_type} - ${n.partnerName} ${e("bettingManagement.opcodeUsing")}`)}catch(n){i.error(e("bettingManagement.opcodeFetchFailed"),{description:n.message});return}const s=new Date,N=s.getFullYear().toString(),F=(s.getMonth()+1).toString();console.log("ðŸ“¥ ë² íŒ… ë‚´ì—­ API í˜¸ì¶œ:",{year:N,month:F,opcode:r});const h=await V(r,N,F,0,4e3,c);if(h.error){i.error(e("bettingManagement.apiCallError"),{description:h.error});return}const d=h.data?.DATA||[];if(!Array.isArray(d)||d.length===0){i.info(e("bettingManagement.noDataToFetch")),k(new Date().toISOString());return}console.log("âœ… API ì‘ë‹µ:",{ë ˆì½”ë“œìˆ˜:d.length,ìƒ˜í”Œ:d[0]});const U=d.map(n=>({txid:n.txid?.toString()||n.id?.toString(),username:n.username||n.user_id,provider_id:n.provider_id||Math.floor((n.game_id||0)/1e3),game_id:n.game_id?.toString()||"0",game_name:n.game_name||"Unknown",bet_amount:parseFloat(n.bet_amount||n.bet||0),win_amount:parseFloat(n.win_amount||n.win||0),profit_loss:parseFloat(n.profit_loss||n.win_loss||(n.win_amount||n.win||0)-(n.bet_amount||n.bet||0)),currency:n.currency||"KRW",status:n.status||"completed",round_id:n.round_id,session_id:n.session_id,game_start_time:n.game_start_time||n.start_time,game_end_time:n.game_end_time||n.end_time||n.played_at||n.created_at})),{data:P,error:x}=await _.rpc("save_betting_records_from_api",{p_records:U});if(x){console.error("âŒ ì €ìž¥ í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨:",x),i.error(e("bettingManagement.syncFailed"),{description:x.message});return}const o=P?.[0]||{saved_count:0,skipped_count:0,error_count:0,errors:[]};console.log("âœ… ì €ìž¥ ê²°ê³¼:",o);const L=new Date().toISOString();k(L),o.saved_count>0?(i.success(`${e("bettingManagement.saveSuccess")} ${o.saved_count}${e("bettingManagement.count")} ${e("bettingManagement.saveSuccessDesc")}`,{description:`${e("bettingManagement.syncTime")} ${L}${o.skipped_count>0?` (${e("bettingManagement.duplicateSkipped")} ${o.skipped_count}${e("bettingManagement.skipped")})`:""}`}),b()):o.skipped_count>0&&i.info(`${e("bettingManagement.alreadyExists")} (${o.skipped_count}${e("bettingManagement.count")})`),o.error_count>0&&o.errors&&o.errors.length>0&&(console.warn("âš ï¸ ì¼ë¶€ ì €ìž¥ ì˜¤ë¥˜:",o.errors),i.warning(`${o.error_count}${e("bettingManagement.partialSaveFailed")}`,{description:`${e("bettingManagement.saveSuccessCount")} ${o.saved_count}${e("bettingManagement.count")}, ${e("bettingManagement.skipCount")} ${o.skipped_count}${e("bettingManagement.count")}
${e("bettingManagement.firstError")} ${o.errors[0]}`}))}catch(t){console.error("âŒ ë² íŒ… ë™ê¸°í™” ì˜¤ë¥˜:",t),i.error(e("bettingManagement.syncFailed"),{description:t instanceof Error?t.message:e("bettingManagement.unknownError")})}finally{v(!1)}},O=()=>{try{const t=[[e("bettingManagement.username"),e("bettingManagement.affiliation"),e("bettingManagement.gameName"),e("bettingManagement.provider"),e("bettingManagement.betAmount"),e("bettingManagement.winAmount"),e("bettingManagement.profitLoss"),e("bettingManagement.playTime")].join(","),...g.map(s=>[s.username,s.referrer_nickname,`"${s.game_name}"`,s.provider_name,s.bet_amount,s.win_amount,s.profit_loss,s.played_at].join(","))].join(`
`),m=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),c=URL.createObjectURL(m);r.setAttribute("href",c),r.setAttribute("download",`betting_${new Date().toISOString().split("T")[0]}.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),i.success(e("bettingManagement.downloadComplete"))}catch(t){console.error("ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:",t),i.error(e("bettingManagement.downloadFailed"))}};l.useEffect(()=>{b()},[]);const g=p?j.filter(t=>t.username.toLowerCase().includes(p.toLowerCase())):j,I=[{key:"username",title:e("bettingManagement.username")},{key:"referrer_nickname",title:e("bettingManagement.affiliation"),render:t=>a.jsx(C,{variant:"outline",className:"bg-slate-800/50 border-slate-600",children:t})},{key:"game_name",title:e("bettingManagement.gameName"),render:t=>a.jsx("span",{className:"max-w-[200px] truncate",title:t,children:t})},{key:"provider_name",title:e("bettingManagement.provider"),render:t=>a.jsx(C,{variant:"secondary",children:t})},{key:"bet_amount",title:e("bettingManagement.betAmount"),render:t=>a.jsxs("span",{className:"font-mono text-blue-600",children:["â‚©",t.toLocaleString()]})},{key:"win_amount",title:e("bettingManagement.winAmount"),render:t=>a.jsxs("span",{className:`font-mono ${t>0?"text-green-600":"text-gray-500"}`,children:["â‚©",t.toLocaleString()]})},{key:"profit_loss",title:e("bettingManagement.profitLoss"),render:t=>a.jsxs("span",{className:`font-mono ${t>0?"text-green-600":"text-red-600"}`,children:[t>0?"+":"","â‚©",t.toLocaleString()]})},{key:"played_at",title:e("bettingManagement.playTime"),render:t=>t?new Date(t).toISOString().replace("T"," ").substring(0,19):"-"}];return a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:e("bettingManagement.title")}),a.jsxs("p",{className:"text-sm text-slate-400",children:[e("bettingManagement.viewCount"),": ",g.length,e("bettingManagement.count")," ",e("bettingManagement.of")," ",e("bettingManagement.totalCount"),": ",T,e("bettingManagement.count"),S&&a.jsxs("span",{className:"ml-4 text-green-400",children:[e("bettingManagement.lastSync"),": ",new Date(S).toLocaleString("ko-KR")]})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs(D,{onClick:B,disabled:w,className:"btn-premium-primary",children:[a.jsx(Y,{className:"h-4 w-4 mr-2"}),e(w?"bettingManagement.fetching":"bettingManagement.fetchBettingHistory")]}),a.jsxs(D,{onClick:O,disabled:y||g.length===0,variant:"outline",className:"border-slate-600 hover:bg-slate-700",children:[a.jsx(z,{className:"h-4 w-4 mr-2"}),e("common.download")]})]})]}),a.jsx("div",{className:"glass-card rounded-xl p-6",children:a.jsxs("div",{className:"space-y-4",children:[a.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:a.jsxs("div",{children:[a.jsx(W,{htmlFor:"betting-user-search",className:"text-slate-300",children:e("bettingManagement.searchUsername")}),a.jsx(G,{id:"betting-user-search",name:"user_search",placeholder:e("bettingManagement.searchUsernamePlaceholder"),value:p,onChange:t=>A(t.target.value),className:"input-premium max-w-xs"})]})}),y?a.jsx("div",{className:"flex justify-center py-12",children:a.jsx(q,{})}):g.length>0?a.jsx(X,{columns:I,data:g,enableSearch:!1}):a.jsxs("div",{className:"text-center py-12 text-slate-400",children:[a.jsx(E,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),a.jsx("p",{children:e("bettingManagement.noBettingHistory")}),a.jsx("p",{className:"text-sm mt-2",children:e(p?"bettingManagement.changeSearchCondition":"bettingManagement.clickToSync")})]})]})})]})}export{re as BettingManagement};
