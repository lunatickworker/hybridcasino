import{r as a,j as e}from"./react-core-BwkdTuSg.js";import{a as M,s as l,I as $,S as B,o as O,p as P,q as H,r as g,l as K,C as z,e as U,B as C,h as b,L as c,z as V}from"./index-CGvwOXPh.js";import{A as W,f as G,a as J,b as Q,c as X,d as Y}from"./AdminDialog-CFXz2Dfn.js";import{k as u}from"./vendor-D410aui4.js";import{C as Z,w as ee,c as w,t as se,a3 as te}from"./lucide-icons-CAeZOOE5.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";function de({user:p}){const{t}=M(),[D,y]=a.useState(!0),[S,R]=a.useState([]),[m,T]=a.useState("all"),[i,k]=a.useState(""),[n,f]=a.useState(null),[x,h]=a.useState(""),[A,N]=a.useState(!1);a.useEffect(()=>{const s=l.channel("customer-messages-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver_id=eq.${p.id}`},async r=>{if(console.log("ðŸ”” ìƒˆ ë¬¸ì˜ ë„ì°©:",r),r.new.sender_type==="user"&&!r.new.parent_id){const{data:j}=await l.from("users").select("username").eq("id",r.new.sender_id).single(),v=j?.username||t.customerSupport.author,d=r.new.subject.replace(/^\[.+?\]\s*/,"");u.info(t.customerSupport.newInquiryArrived,{description:`${v}: ${d}`,duration:5e3})}o()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages"},r=>{console.log("ðŸ”” ë©”ì‹œì§€ ì—…ë°ì´íŠ¸:",r),o()}).subscribe();return()=>{l.removeChannel(s)}},[p.id]);const o=async()=>{try{y(!0);let s=l.from("messages").select("*").eq("receiver_type","partner").eq("receiver_id",p.id).eq("sender_type","user").is("parent_id",null);m!=="all"&&(s=s.eq("status",m)),i&&(s=s.or(`subject.ilike.%${i}%,content.ilike.%${i}%`));const{data:r,error:j}=await s.order("created_at",{ascending:!1});if(j)throw j;const v=await Promise.all((r||[]).map(async d=>{const{data:L}=await l.from("messages").select("*").eq("parent_id",d.id).order("created_at",{ascending:!0}),{data:F}=await l.from("users").select("username").eq("id",d.sender_id).single();return{...d,sender_username:F?.username||t.settlement.unknown,replies:L||[]}}));R(v)}catch(s){console.error("ë©”ì‹œì§€ ì¡°íšŒ ì˜¤ë¥˜:",s),u.error(t.customerSupport.loadInquiriesFailed)}finally{y(!1)}},I=async s=>{try{const{error:r}=await l.from("messages").update({status:"read",read_at:new Date().toISOString()}).eq("id",s);if(r)throw r}catch(r){console.error("ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:",r)}},E=async()=>{if(!n||!x.trim()){u.error(t.customerSupport.enterReplyContent);return}try{const{error:s}=await l.from("messages").insert([{sender_type:"partner",sender_id:p.id,receiver_type:"user",receiver_id:n.sender_id,subject:`Re: ${n.subject}`,content:x.trim(),message_type:"normal",status:"unread",parent_id:n.id}]);if(s)throw s;const{error:r}=await l.from("messages").update({status:"replied"}).eq("id",n.id);if(r)throw r;u.success(t.customerSupport.replyRegistered),N(!1),h(""),f(null),o()}catch(s){console.error("ë‹µë³€ ë“±ë¡ ì˜¤ë¥˜:",s),u.error(t.customerSupport.replyRegisterFailed)}};a.useEffect(()=>{o()},[m]),a.useEffect(()=>{const s=setTimeout(()=>{i!==void 0&&o()},300);return()=>clearTimeout(s)},[i]);const _=s=>{const r={unread:{label:t.customerSupport.unread,color:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30"},read:{label:t.customerSupport.read,color:"bg-blue-500/20 text-blue-400 border-blue-500/30"},replied:{label:t.customerSupport.replied,color:"bg-green-500/20 text-green-400 border-green-500/30"}}[s]||{label:s,color:""};return e.jsx(C,{variant:"outline",className:r.color,children:r.label})},q=s=>{const r=s.match(/^\[(.+?)\]/);return r?r[1]:t.customerSupport.general};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-slate-100",children:t.customerSupport.customerServiceCenter}),e.jsx("p",{className:"text-sm text-slate-400",children:t.customerSupport.subtitle})]})}),e.jsxs("div",{className:"glass-card rounded-xl p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-slate-100 flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5 text-blue-400"}),t.customerSupport.inquiryManagement]}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:t.customerSupport.totalInquiries.replace("{count}",S.length.toString())})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 h-4 w-4"}),e.jsx($,{placeholder:t.customerSupport.searchPlaceholder,value:i,onChange:s=>k(s.target.value),className:"pl-9 input-premium"})]})}),e.jsxs(B,{value:m,onValueChange:T,children:[e.jsx(O,{className:"w-[140px]",children:e.jsx(P,{})}),e.jsxs(H,{children:[e.jsx(g,{value:"all",children:t.customerSupport.allStatus}),e.jsx(g,{value:"unread",children:t.customerSupport.unread}),e.jsx(g,{value:"read",children:t.customerSupport.read}),e.jsx(g,{value:"replied",children:t.customerSupport.replied})]})]})]}),D?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(K,{})}):S.length===0?e.jsxs("div",{className:"text-center py-12 text-slate-400",children:[e.jsx(w,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:t.customerSupport.noInquiries})]}):e.jsx("div",{className:"space-y-3",children:S.map(s=>e.jsx(z,{className:"bg-slate-800/50 border-slate-700 hover:bg-slate-800/70 transition-colors",children:e.jsx(U,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(C,{variant:"secondary",className:"text-xs",children:q(s.subject)}),_(s.status),e.jsx("span",{className:"text-xs text-slate-500",children:new Date(s.created_at).toLocaleString("ko-KR")})]}),e.jsx("h3",{className:"text-slate-100",children:s.subject.replace(/^\[.+?\]\s*/,"")}),e.jsx("p",{className:"text-sm text-slate-400 line-clamp-2",children:s.content}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500",children:[e.jsx(se,{className:"h-3 w-3"}),e.jsx("span",{children:s.sender_username}),s.replies&&s.replies.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-1",children:"â€¢"}),e.jsx(w,{className:"h-3 w-3"}),e.jsx("span",{children:t.customerSupport.repliesCount.replace("{count}",s.replies.length.toString())})]})]})]}),e.jsxs(W,{open:A&&n?.id===s.id,onOpenChange:r=>{N(r),r?(f(s),h(""),s.status==="unread"&&I(s.id)):(f(null),h(""))},children:[e.jsx(G,{asChild:!0,children:e.jsxs(b,{size:"sm",variant:"outline",className:"shrink-0",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),s.replies&&s.replies.length>0?t.customerSupport.viewReply:t.customerSupport.writeReply]})}),e.jsxs(J,{className:"max-w-3xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(Q,{children:[e.jsx(X,{children:t.customerSupport.inquiryDetails}),e.jsx(Y,{children:t.customerSupport.inquiryDetailsDesc})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx(c,{className:"text-slate-400",children:t.customerSupport.author}),e.jsx("p",{className:"text-slate-100",children:s.sender_username})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-slate-400",children:t.customerSupport.writtenDate}),e.jsx("p",{className:"text-slate-100",children:new Date(s.created_at).toLocaleString("ko-KR")})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-slate-400",children:t.customerSupport.classification}),e.jsx("p",{className:"text-slate-100",children:q(s.subject)})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-slate-400",children:t.common.status}),e.jsx("div",{className:"mt-1",children:_(s.status)})]})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-slate-400",children:t.customerSupport.inquiryTitle}),e.jsx("p",{className:"text-slate-100 mt-1",children:s.subject})]}),e.jsxs("div",{children:[e.jsx(c,{className:"text-slate-400",children:t.customerSupport.inquiryContent}),e.jsx("div",{className:"p-4 bg-slate-900/50 border border-slate-700 rounded-lg mt-2",children:e.jsx("p",{className:"text-sm text-slate-200 whitespace-pre-wrap",children:s.content})})]}),s.replies&&s.replies.length>0&&e.jsxs("div",{children:[e.jsx(c,{className:"text-slate-400",children:t.customerSupport.replyHistory}),e.jsx("div",{className:"space-y-2 mt-2",children:s.replies.map(r=>e.jsxs("div",{className:"p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg",children:[e.jsx("p",{className:"text-sm text-slate-200 whitespace-pre-wrap",children:r.content}),e.jsx("div",{className:"mt-2 text-xs text-slate-500",children:new Date(r.created_at).toLocaleString("ko-KR")})]},r.id))})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"response",className:"text-slate-400",children:s.replies&&s.replies.length>0?t.customerSupport.additionalReply:t.customerSupport.writeReplyLabel}),e.jsx(V,{id:"response",placeholder:t.customerSupport.replyPlaceholder,value:x,onChange:r=>h(r.target.value),rows:5,className:"mt-2"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(b,{variant:"outline",onClick:()=>N(!1),children:t.common.cancel}),e.jsxs(b,{onClick:E,disabled:!x.trim(),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),t.customerSupport.registerReply]})]})]})]})]})]})})},s.id))})]})]})]})}export{de as CustomerSupport,de as default};
