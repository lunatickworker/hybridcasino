import{j as e,r as h}from"./react-core-BwkdTuSg.js";import{H as se,a as le,s as C,Z as A,$ as L,L as T,S as te,o as re,p as ae,q as ce,r as H,h as _,I as ne,B as M,a0 as ie,a1 as oe,a2 as de,a3 as he}from"./index-CGvwOXPh.js";import{C as xe}from"./checkbox-CovRkp6-.js";import{T as D,a as F,b as S,c as m,d as I,e as u}from"./table-BXx61AEI.js";import{U as N}from"./UnifiedCard-DCP7c5YG.js";import{k as c}from"./vendor-D410aui4.js";import{Q as q,R as ye,A as pe}from"./lucide-icons-CAeZOOE5.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";function B({title:d,description:s,icon:g,actions:n,children:f,className:o}){return e.jsxs("div",{className:se("space-y-6",o),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[g&&e.jsx("div",{className:"p-2 rounded-lg bg-blue-500/20",children:e.jsx(g,{className:"h-6 w-6 text-blue-400"})}),e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:d})]}),s&&e.jsx("p",{className:"text-sm text-slate-400 ml-14",children:s})]}),n&&e.jsx("div",{className:"flex items-center gap-2",children:n})]}),f]})}function Se({user:d}){const{t:s}=le(),g=d.level===0||d.level===1,[n,f]=h.useState("set"),[o,G]=h.useState(""),[U,O]=h.useState([]),[y,$]=h.useState([]),[r,p]=h.useState([]),[x,Q]=h.useState(85),[P,j]=h.useState(!1),[k,v]=h.useState([]),[V,z]=h.useState([]);h.useEffect(()=>{g&&(K(),W(),w())},[g]);const R=async()=>await he(d.id),K=async()=>{try{const{data:l,error:t}=await C.from("game_providers").select("vendor_code").limit(1);if(t&&t.code==="42703"){c.error(s.callCycle.databaseSetupRequired,{description:s.callCycle.runMigrationSQL,duration:1e4});return}const{data:i,error:a}=await C.from("game_providers").select("name, vendor_code").eq("api_type","oroplay").eq("type","slot").not("vendor_code","is",null).order("name");if(a){console.error("게임사 로드 오류:",a);return}const b=(i||[]).map(E=>({code:E.vendor_code,name:E.name}));b.length===0&&c.warning(s.callCycle.noOroplayVendors,{description:s.callCycle.syncGamesFirst,duration:7e3}),O(b)}catch(l){console.error("게임사 로드 실패:",l)}},W=async()=>{try{const{data:l,error:t}=await C.from("users").select("id, username").order("username");if(t){console.error("사용자 로드 오류:",t);return}$(l||[])}catch(l){console.error("사용자 로드 실패:",l)}},w=async()=>{try{const{data:l,error:t}=await C.from("rtp_settings").select(`
          id,
          vendor_code,
          setting_type,
          rtp_value,
          user_id,
          created_at,
          applied_by:partners!rtp_settings_applied_by_fkey(username)
        `).eq("partner_id",d.id).order("created_at",{ascending:!1}).limit(50);if(t){console.error("RTP 이력 로드 오류:",t);return}const i=(l||[]).map(a=>({id:a.id,vendor_code:a.vendor_code,setting_type:a.setting_type,rtp_value:a.rtp_value,user_id:a.user_id,created_at:a.created_at,applied_by_username:a.applied_by?.username||"알 수 없음"}));z(i)}catch(l){console.error("RTP 이력 로드 실패:",l)}},Z=async()=>{if(!o){c.error(s.callCycle.selectVendorError);return}if(r.length===0){c.error(s.callCycle.selectUsersError);return}if(x<30||x>99){c.error(s.callCycle.rtpRangeError);return}j(!0);let l=0;try{const t=await R();for(const i of r)try{await ie(t,o,i,x),l++;const a=y.find(b=>b.username===i);await C.from("rtp_settings").insert({partner_id:d.id,vendor_code:o,user_id:a?.id||null,setting_type:"set",rtp_value:x,applied_by:d.id})}catch(a){console.error(`${i} RTP 설정 실패:`,a)}c.success(s.callCycle.rtpSetSuccess.replace("{{count}}",String(l))),await w(),p([])}catch(t){c.error(s.callCycle.rtpSetFailed,{description:t.message})}finally{j(!1)}},J=async()=>{if(!o){c.error(s.callCycle.selectVendorError);return}if(r.length===0){c.error(s.callCycle.selectUsersError);return}j(!0),v([]);try{const l=await R(),t=[];for(const i of r)try{const a=await oe(l,o,i);t.push({username:i,rtp:a})}catch(a){console.error(`${i} RTP 조회 실패:`,a)}v(t),c.success(s.callCycle.rtpGetSuccess)}catch(l){c.error(s.callCycle.rtpGetFailed,{description:l.message})}finally{j(!1)}},X=async()=>{if(!o){c.error(s.callCycle.selectVendorError);return}if(r.length===0){c.error(s.callCycle.selectUsersError);return}if(r.length>500){c.error(s.callCycle.maxUsersError);return}if(x<30||x>99){c.error(s.callCycle.rtpRangeError);return}j(!0);try{const l=await R(),t=r.map(i=>({userCode:i,rtp:x}));await de(l,o,t),c.success(s.callCycle.batchRtpSetSuccess.replace("{{count}}",String(r.length))),await C.from("rtp_settings").insert({partner_id:d.id,vendor_code:o,user_id:null,setting_type:"reset",rtp_value:x,applied_by:d.id}),await w(),p([])}catch(l){c.error(s.callCycle.batchRtpSetFailed,{description:l.message})}finally{j(!1)}},Y=l=>{if(r.includes(l))p(t=>t.filter(i=>i!==l));else{if(n==="reset"&&r.length>=500){c.warning(s.callCycle.maxUsersWarning);return}p(t=>[...t,l])}},ee=()=>{if(r.length===y.length)p([]);else{const l=n==="reset"?500:y.length;p(y.slice(0,l).map(t=>t.username))}};return g?e.jsx(B,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl mb-2",children:s.callCycle.title}),e.jsx("p",{className:"text-sm text-gray-400",children:s.callCycle.subtitle})]}),e.jsx(N,{title:s.callCycle.vendorSelection,children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:s.callCycle.vendorCode}),e.jsxs(te,{value:o,onValueChange:G,children:[e.jsx(re,{children:e.jsx(ae,{placeholder:s.callCycle.selectVendor})}),e.jsx(ce,{children:U.length===0?e.jsx(H,{value:"none",disabled:!0,children:s.callCycle.noVendors}):U.map(l=>e.jsx(H,{value:l.code,children:l.name},l.code))})]}),e.jsx("p",{className:"text-xs text-gray-500",children:s.callCycle.vendorDescription})]})}),e.jsx(N,{title:s.callCycle.actionSelection,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx(_,{variant:n==="set"?"default":"outline",onClick:()=>{f("set"),v([])},children:s.callCycle.setUserRTP}),e.jsx(_,{variant:n==="get"?"default":"outline",onClick:()=>{f("get"),v([])},children:s.callCycle.getUserRTP}),e.jsx(_,{variant:n==="reset"?"default":"outline",onClick:()=>{f("reset"),v([]),r.length>500&&p(r.slice(0,500))},children:s.callCycle.resetUserRTP})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(T,{children:s.callCycle.targetUsers}),e.jsx(_,{variant:"ghost",size:"sm",onClick:ee,children:r.length===y.length?s.callCycle.deselectAll:s.callCycle.selectAll})]}),e.jsx("div",{className:"border border-slate-700 rounded-lg p-4 max-h-60 overflow-y-auto bg-slate-900/50",children:y.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:s.callCycle.noUsers}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3",children:y.map(l=>e.jsxs("label",{className:"flex items-center space-x-2 cursor-pointer hover:bg-slate-800/50 p-2 rounded",children:[e.jsx(xe,{checked:r.includes(l.username),onCheckedChange:()=>Y(l.username)}),e.jsx("span",{className:"text-sm",children:l.username})]},l.id))})}),e.jsx("p",{className:"text-xs text-gray-500",children:n==="reset"?s.callCycle.resetModeLimit.replace("{{count}}",String(r.length)):n==="get"?s.callCycle.getModeInfo.replace("{{count}}",String(r.length)):s.callCycle.setModeInfo.replace("{{count}}",String(r.length))})]}),n!=="get"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:s.callCycle.rtpValue}),e.jsx(ne,{type:"number",value:x,onChange:l=>Q(parseInt(l.target.value)||85),min:30,max:99,className:"bg-slate-900/50 border-slate-700"}),e.jsx("p",{className:"text-xs text-gray-500",children:s.callCycle.rtpDescription})]}),e.jsx(_,{onClick:()=>{n==="set"?Z():n==="get"?J():X()},disabled:P||!o||r.length===0,className:"w-full",children:P?e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-4 h-4 mr-2 animate-spin"}),s.callCycle.processing]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),n==="set"?s.callCycle.setRTP:n==="get"?s.callCycle.getRTP:s.callCycle.batchSetRTP]})})]})}),n==="get"&&k.length>0&&e.jsx(N,{title:s.callCycle.rtpResults,children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(D,{children:[e.jsx(F,{children:e.jsxs(S,{children:[e.jsx(m,{children:s.callCycle.username}),e.jsx(m,{children:s.callCycle.currentRTP})]})}),e.jsx(I,{children:k.map(l=>e.jsxs(S,{children:[e.jsx(u,{children:l.username}),e.jsx(u,{children:e.jsxs(M,{variant:"outline",children:[l.rtp,"%"]})})]},l.username))})]})})}),e.jsxs(A,{children:[e.jsx(q,{className:"h-4 w-4"}),e.jsx(L,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{children:e.jsx("strong",{children:s.callCycle.noticeTitle})}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-sm",children:[e.jsx("li",{children:s.callCycle.noticeOroplayOnly}),e.jsx("li",{children:s.callCycle.noticeSetUser}),e.jsx("li",{children:s.callCycle.noticeGetUser}),e.jsx("li",{children:s.callCycle.noticeResetUser}),e.jsx("li",{children:s.callCycle.noticeInvestNA})]})]})})]}),e.jsx(N,{title:s.callCycle.recentHistory,children:e.jsx("div",{className:"overflow-x-auto",children:V.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:s.callCycle.noHistory}):e.jsxs(D,{children:[e.jsx(F,{children:e.jsxs(S,{children:[e.jsx(m,{children:s.callCycle.time}),e.jsx(m,{children:s.callCycle.vendor}),e.jsx(m,{children:s.callCycle.settingMethod}),e.jsx(m,{children:s.callCycle.rtp}),e.jsx(m,{children:s.callCycle.appliedBy})]})}),e.jsx(I,{children:V.map(l=>e.jsxs(S,{children:[e.jsx(u,{children:new Date(l.created_at).toLocaleString("ko-KR")}),e.jsx(u,{children:l.vendor_code}),e.jsx(u,{children:e.jsx(M,{variant:l.setting_type==="set"?"default":l.setting_type==="reset"?"secondary":"outline",children:l.setting_type==="set"?s.callCycle.individualSetting:l.setting_type==="reset"?s.callCycle.batchSetting:l.setting_type})}),e.jsxs(u,{children:[l.rtp_value,"%"]}),e.jsx(u,{children:l.applied_by_username})]},l.id))})]})})})]})}):e.jsx(B,{children:e.jsxs(A,{children:[e.jsx(q,{className:"h-4 w-4"}),e.jsx(L,{children:s.callCycle.accessDenied})]})})}export{Se as CallCycle};
