import{r as o,j as e}from"./react-core-BwkdTuSg.js";import{a as z,s as H,l as Y,h as y,H as b,C as B,E as G,F as K,G as U,S as I,o as T,p as D,q as C,r as i,e as Z}from"./index-Be3DOFuy.js";import{P as J,a as Q,b as X}from"./popover-BEBhnF_B.js";import{C as ee}from"./calendar-SAx7o28H.js";import{k as g,n as j,p as x}from"./vendor-D410aui4.js";import{M as w}from"./MetricCard-DF34t905.js";import{calculateIntegratedSettlement as te,calculatePartnerPayments as ae}from"./settlementCalculator-DhQR0qso.js";import{a as ne}from"./settlementExecutor-C2Z0GKaW.js";import{R as se,at as re,au as le,av as oe,a9 as ie,a2 as ce,K as me}from"./lucide-icons-D2Pw2Rdn.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";function Ne({user:l}){const{t}=z(),[R,P]=o.useState(!0),[p,L]=o.useState(!1),[S,N]=o.useState(!1),[de,O]=o.useState("direct_subordinate"),[m,_]=o.useState("today"),[r,F]=o.useState(),[d,k]=o.useState("all"),[n,M]=o.useState({myRollingIncome:0,myLosingIncome:0,myWithdrawalIncome:0,myTotalIncome:0,partnerRollingPayments:0,partnerLosingPayments:0,partnerWithdrawalPayments:0,partnerTotalPayments:0,netRollingProfit:0,netLosingProfit:0,netWithdrawalProfit:0,netTotalProfit:0}),[u,W]=o.useState([]);o.useEffect(()=>{E(),f()},[l.id,m,r,d]);const E=async()=>{try{const{data:a,error:s}=await H.from("system_settings").select("setting_value").eq("setting_key","settlement_method").maybeSingle();if(s)throw s;a&&O(a.setting_value)}catch(a){console.error(t.settlement.settlementMethodLoadFailed,a)}},v=()=>{const a=new Date,s=new Date(a.getFullYear(),a.getMonth(),a.getDate());switch(m){case"today":return{start:s.toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};case"yesterday":return{start:new Date(s.getTime()-1440*60*1e3).toISOString(),end:s.toISOString()};case"week":return{start:new Date(s.getTime()-10080*60*1e3).toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};case"month":return{start:new Date(a.getFullYear(),a.getMonth(),1).toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};case"custom":if(r?.from){const V=new Date(r.from),q=r.to?new Date(r.to):new Date(r.from);return{start:V.toISOString(),end:new Date(q.getTime()+1440*60*1e3).toISOString()}}return{start:s.toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};default:return{start:s.toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()}}},f=async()=>{try{p||P(!0);const{start:a,end:s}=v(),h=await te(l.id,{rolling:l.commission_rolling,losing:l.commission_losing,withdrawal:l.withdrawal_fee},a,s,d);M(h);const c=await ae(l.id,a,s,d);W(c.details)}catch(a){console.error("통합 정산 계산 실패:",a),g.error(t.settlement.commissionLoadFailed)}finally{P(!1),L(!1)}},A=()=>{L(!0),f()},$=async()=>{if(n.netTotalProfit<=0){g.error(t.settlement.netProfitZeroOrLess);return}const a=t.settlement.confirmIntegratedSettlement.replace("{myRolling}",n.myRollingIncome.toLocaleString()).replace("{myLosing}",n.myLosingIncome.toLocaleString()).replace("{myWithdrawal}",n.myWithdrawalIncome.toLocaleString()).replace("{myTotal}",n.myTotalIncome.toLocaleString()).replace("{partnerRolling}",n.partnerRollingPayments.toLocaleString()).replace("{partnerLosing}",n.partnerLosingPayments.toLocaleString()).replace("{partnerWithdrawal}",n.partnerWithdrawalPayments.toLocaleString()).replace("{partnerTotal}",n.partnerTotalPayments.toLocaleString()).replace("{netTotal}",n.netTotalProfit.toLocaleString());if(window.confirm(a)){N(!0);try{const{start:s,end:h}=v(),c=await ne(l.id,{rolling:l.commission_rolling,losing:l.commission_losing,withdrawal:l.withdrawal_fee},s,h,m,d);c.success?(g.success(c.message),f()):g.error(c.message||t.settlement.integratedSettlementFailed)}catch(s){console.error("통합 정산 실행 오류:",s),g.error(t.settlement.integratedSettlementError)}finally{N(!1)}}};return R?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(Y,{})}):e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl text-white mb-2",children:t.settlement.integratedSettlementTitle}),e.jsx("p",{className:"text-slate-400",children:t.settlement.integratedSettlementSubtitle})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(y,{variant:"outline",size:"sm",onClick:A,disabled:p,children:[e.jsx(se,{className:b("h-4 w-4 mr-2",p&&"animate-spin")}),t.common.refresh]}),e.jsxs(y,{variant:"default",size:"sm",onClick:$,disabled:S||n.netTotalProfit<=0,className:"bg-purple-600 hover:bg-purple-700",children:[e.jsx(re,{className:b("h-4 w-4 mr-2",S&&"animate-spin")}),S?t.settlement.savingSettlement:t.settlement.saveSettlementRecord]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-5",children:[e.jsx(w,{title:t.settlement.myTotalIncome,value:`₩${n.myTotalIncome.toLocaleString()}`,subtitle:t.settlement.myTotalIncomeSubtitle.replace("{rolling}",n.myRollingIncome.toLocaleString()).replace("{losing}",n.myLosingIncome.toLocaleString()),icon:le,color:"emerald"}),e.jsx(w,{title:t.settlement.partnerTotalPayments,value:`₩${n.partnerTotalPayments.toLocaleString()}`,subtitle:t.settlement.partnerTotalPaymentsSubtitle.replace("{rolling}",n.partnerRollingPayments.toLocaleString()).replace("{losing}",n.partnerLosingPayments.toLocaleString()),icon:oe,color:"red"}),e.jsx(w,{title:t.settlement.netProfit,value:`₩${n.netTotalProfit.toLocaleString()}`,subtitle:t.settlement.netProfitSubtitle.replace("{rolling}",n.netRollingProfit.toLocaleString()).replace("{losing}",n.netLosingProfit.toLocaleString()),icon:ie,color:"blue"})]}),e.jsxs(B,{children:[e.jsx(G,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(K,{children:t.settlement.partnerPaymentDetails}),e.jsx(U,{children:t.settlement.partnerPaymentDetailsDesc.replace("{count}",u.length.toString())})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(I,{value:d,onValueChange:a=>k(a),children:[e.jsx(T,{className:"w-[140px]",children:e.jsx(D,{})}),e.jsxs(C,{children:[e.jsx(i,{value:"all",children:t.settlement.allApi}),e.jsx(i,{value:"invest",children:t.settlement.investOnly}),e.jsx(i,{value:"oroplay",children:t.settlement.oroplaysOnly})]})]}),e.jsxs(I,{value:m,onValueChange:_,children:[e.jsx(T,{className:"w-[180px]",children:e.jsx(D,{})}),e.jsxs(C,{children:[e.jsx(i,{value:"today",children:t.settlement.today}),e.jsx(i,{value:"yesterday",children:t.settlement.yesterday}),e.jsx(i,{value:"week",children:t.settlement.lastWeek}),e.jsx(i,{value:"month",children:t.settlement.thisMonth}),e.jsx(i,{value:"custom",children:t.settlement.customPeriod})]})]}),m==="custom"&&e.jsxs(J,{children:[e.jsx(Q,{asChild:!0,children:e.jsxs(y,{variant:"outline",className:"w-[280px] justify-start text-left",children:[e.jsx(ce,{className:"mr-2 h-4 w-4"}),r?.from?r.to?e.jsxs(e.Fragment,{children:[j(r.from,"PPP",{locale:x})," -"," ",j(r.to,"PPP",{locale:x})]}):j(r.from,"PPP",{locale:x}):e.jsx("span",{children:t.settlement.selectDate})]})}),e.jsx(X,{className:"w-auto p-0",align:"end",children:e.jsx(ee,{initialFocus:!0,mode:"range",defaultMonth:r?.from,selected:r,onSelect:F,numberOfMonths:2,locale:x})})]})]})]})}),e.jsx(Z,{children:u.length===0?e.jsxs("div",{className:"text-center py-12 text-slate-400",children:[e.jsx(me,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:t.settlement.noPartnersToPayDesc})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-slate-700",children:[e.jsx("th",{className:"text-left p-3 text-slate-400",children:t.settlement.partner}),e.jsx("th",{className:"text-right p-3 text-slate-400",children:t.settlement.rollingPayment}),e.jsx("th",{className:"text-right p-3 text-slate-400",children:t.settlement.losingPayment}),e.jsx("th",{className:"text-right p-3 text-slate-400",children:t.settlement.withdrawalPayment}),e.jsx("th",{className:"text-right p-3 text-slate-400",children:t.settlement.totalPayment})]})}),e.jsx("tbody",{children:u.map(a=>e.jsxs("tr",{className:"border-b border-slate-800 hover:bg-slate-800/30",children:[e.jsx("td",{className:"p-3",children:e.jsx("p",{className:"text-white",children:a.partner_nickname})}),e.jsxs("td",{className:"p-3 text-right text-blue-400 font-mono",children:["₩",a.rolling_payment.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-purple-400 font-mono",children:["₩",a.losing_payment.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-green-400 font-mono",children:["₩",a.withdrawal_payment.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-orange-400 font-mono",children:["₩",a.total_payment.toLocaleString()]})]},a.partner_id))}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"bg-slate-800/50 border-t-2 border-slate-600",children:[e.jsx("td",{className:"p-3 text-white",children:t.settlement.totalSum}),e.jsxs("td",{className:"p-3 text-right text-blue-400 font-mono",children:["₩",n.partnerRollingPayments.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-purple-400 font-mono",children:["₩",n.partnerLosingPayments.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-green-400 font-mono",children:["₩",n.partnerWithdrawalPayments.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-orange-400 font-mono",children:["₩",n.partnerTotalPayments.toLocaleString()]})]})})]})})})]})]})}export{Ne as IntegratedSettlement};
