import{r as i,j as t}from"./react-core-BwkdTuSg.js";import{a as F,s as x,B as _,I as W}from"./index-McppjVnx.js";import{D as K}from"./DataTable-w2U-jZDQ.js";import{M as C}from"./MetricCard-DnMFhTGK.js";import{w as Q,ao as O,d as z,U as G,W as H}from"./lucide-icons-CePlpqHy.js";import"./vendor-D410aui4.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";import"./table-CKCHMZ5m.js";function re({user:u}){const{t:a}=F(),[g,N]=i.useState([]),[w,b]=i.useState([]),[h,D]=i.useState(""),[T,P]=i.useState({totalUsers:0,totalUserBalance:0}),[I,y]=i.useState(!0),d=i.useRef(null),[j,L]=i.useState([]),R=async e=>{const n=[],s=[e];for(;s.length>0;){const o=s.shift(),{data:c,error:p}=await x.from("partners").select("id").eq("parent_id",o);if(!p&&c)for(const f of c)n.push(f.id),s.push(f.id)}return n},U=async(e=!1)=>{try{e&&y(!0);let n=[];u.level!==1&&(n=await R(u.id));let s=x.from("partners").select(`
          id,
          username,
          nickname,
          level,
          partner_type,
          balance,
          last_login_at,
          status,
          parent_id
        `).order("last_login_at",{ascending:!1,nullsFirst:!1});if(u.level!==1&&n.length>0)s=s.in("id",n);else if(u.level!==1&&n.length===0){N([]),L([]),e&&y(!1);return}const{data:o,error:c}=await s;if(c)throw c;const p=[...new Set((o||[]).map(r=>r.parent_id).filter(Boolean))];let f={};if(p.length>0){const{data:r}=await x.from("partners").select("id, nickname").in("id",p);r&&(f=r.reduce((m,l)=>(m[l.id]=l.nickname,m),{}))}const S={};if(o&&o.length>0){const r=o.map(l=>l.id),{data:m}=await x.from("users").select("referrer_id, balance").in("referrer_id",r);m&&m.forEach(l=>{S[l.referrer_id]||(S[l.referrer_id]={count:0,balance:0}),S[l.referrer_id].count+=1,S[l.referrer_id].balance+=l.balance||0})}const v=(o||[]).map(r=>{const m=S[r.id]||{count:0,balance:0};return{id:r.id,username:r.username,nickname:r.nickname,level:r.level,partner_type:r.partner_type,balance:r.balance||0,last_login_at:r.last_login_at,status:r.status,parent_nickname:r.parent_id&&f[r.parent_id]||"-",user_count:m.count,users_balance:m.balance}});N(v),b(v);const k=u.level===1?v.map(r=>r.id):[u.id,...n];L(k),await B(k)}catch(n){console.error("íŒŒíŠ¸ë„ˆ ì ‘ì† í˜„í™© ë¡œë“œ ì˜¤ë¥˜:",n)}finally{e&&y(!1)}},B=async e=>{try{if(e.length===0){P({totalUsers:0,totalUserBalance:0});return}const{data:n,error:s}=await x.from("users").select("id, balance").in("referrer_id",e);if(s)throw s;const o=n?.length||0,c=n?.reduce((p,f)=>p+(f.balance||0),0)||0;P({totalUsers:o,totalUserBalance:c})}catch(n){console.error("ì‚¬ìš©ìž í†µê³„ ë¡œë“œ ì˜¤ë¥˜:",n)}};i.useEffect(()=>{if(!h.trim()){b(g);return}const e=h.toLowerCase(),n=g.filter(s=>s.username.toLowerCase().includes(e)||s.nickname.toLowerCase().includes(e)||s.parent_nickname.toLowerCase().includes(e)||M(s.partner_type).toLowerCase().includes(e));b(n)},[h,g]),i.useEffect(()=>{U(!0)},[u.id]),i.useEffect(()=>{console.log("ðŸ”” Realtime êµ¬ë… ì‹œìž‘: partners, users");const e=x.channel("partner-connections-realtime").on("postgres_changes",{event:"*",schema:"public",table:"partners"},n=>{console.log("ðŸ”” partners ë³€ê²½ ê°ì§€:",n),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{U()},500)}).on("postgres_changes",{event:"*",schema:"public",table:"users"},n=>{console.log("ðŸ”” users ë³€ê²½ ê°ì§€:",n),j.length>0&&(d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{B(j)},500))}).subscribe();return()=>{x.removeChannel(e),d.current&&clearTimeout(d.current)}},[u.id,j]);const M=e=>({system_admin:a.partnerCreation.partnerTypes.system_admin,head_office:a.partnerCreation.partnerTypes.head_office,main_office:a.partnerCreation.partnerTypes.main_office,sub_office:a.partnerCreation.partnerTypes.sub_office,distributor:a.partnerCreation.partnerTypes.distributor,store:a.partnerCreation.partnerTypes.store})[e]||e,E=e=>{if(!e)return"-";const n=new Date(e).getTime(),s=Date.now(),o=Math.floor((s-n)/1e3/60);if(o<60)return a.partnerConnectionStatus.minutesAgo.replace("{{minutes}}",o.toString());const c=Math.floor(o/60),p=o%60;return a.partnerConnectionStatus.hoursMinutesAgo.replace("{{hours}}",c.toString()).replace("{{minutes}}",p.toString())},$=g.filter(e=>e.last_login_at?Math.floor((Date.now()-new Date(e.last_login_at).getTime())/1e3/60)<=30&&e.status==="active":!1),q=g.reduce((e,n)=>e+n.balance,0),A=[{header:a.partnerConnectionStatus.partnerInfo,cell:e=>t.jsxs("div",{className:"flex flex-col gap-2 py-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"font-medium",children:e.username}),t.jsx(_,{variant:"outline",className:"text-xs px-2 py-0.5",children:e.nickname})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs(_,{variant:"secondary",className:"text-xs px-2 py-0.5",children:[a.partnerConnectionStatus.levelPrefix,e.level]}),t.jsx("span",{className:"text-xs text-muted-foreground",children:M(e.partner_type)})]}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:[a.partnerConnectionStatus.parentLabel,": ",e.parent_nickname]})]})},{header:a.partnerConnectionStatus.partnerBalance,cell:e=>t.jsx("div",{className:"flex flex-col gap-1 py-2",children:t.jsxs("span",{className:`font-medium ${e.balance<0?"text-red-400":"text-emerald-400"}`,children:["â‚©",e.balance.toLocaleString()]})})},{header:a.partnerConnectionStatus.userCount,cell:e=>t.jsx("div",{className:"flex flex-col gap-1 py-2",children:t.jsx("span",{className:"font-medium text-cyan-400",children:a.partnerConnectionStatus.peopleCount.replace("{{count}}",e.user_count.toLocaleString())})})},{header:a.partnerConnectionStatus.userBalanceSum,cell:e=>t.jsx("div",{className:"flex flex-col gap-1 py-2",children:t.jsxs("span",{className:`font-medium ${e.users_balance<0?"text-red-400":"text-blue-400"}`,children:["â‚©",e.users_balance.toLocaleString()]})})},{header:a.partnerConnectionStatus.connectionStatus,cell:e=>{const n=e.last_login_at&&(Date.now()-new Date(e.last_login_at).getTime())/1e3/60<=30&&e.status==="active";return t.jsxs("div",{className:"flex flex-col gap-2 py-2",children:[t.jsx(_,{variant:n?"default":"outline",className:n?"bg-emerald-500/20 text-emerald-400 border-emerald-500/50":"",children:n?a.partnerConnectionStatus.online:a.partnerConnectionStatus.offline}),e.status==="suspended"&&t.jsx(_,{variant:"destructive",className:"text-xs",children:a.partnerConnectionStatus.suspended})]})}},{header:a.partnerConnectionStatus.lastLoginTime,cell:e=>t.jsxs("div",{className:"flex flex-col gap-1 py-2",children:[t.jsx("span",{className:"text-sm",children:e.last_login_at?new Date(e.last_login_at).toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).replace(/\. /g,".").replace(/\.$/,""):"-"}),e.last_login_at&&t.jsx("span",{className:"text-xs text-muted-foreground",children:a.partnerConnectionStatus.elapsedTime.replace("{{time}}",E(e.last_login_at))})]})}];return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-3xl",children:a.partnerConnectionStatus.title}),t.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:a.partnerConnectionStatus.subtitle})]}),t.jsxs("div",{className:"relative max-w-md",children:[t.jsx(Q,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),t.jsx(W,{placeholder:a.partnerConnectionStatus.searchPlaceholder,value:h,onChange:e=>D(e.target.value),className:"pl-9 bg-card/50 border-border/50"})]})]}),t.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[t.jsx(C,{title:a.partnerConnectionStatus.onlinePartners,value:a.partnerConnectionStatus.peopleCount.replace("{{count}}",$.length.toString()),subtitle:a.partnerConnectionStatus.onlineSubtitle,icon:O,color:"purple"}),t.jsx(C,{title:a.partnerConnectionStatus.partnerBalanceTotal,value:`â‚©${q.toLocaleString()}`,subtitle:a.partnerConnectionStatus.partnerBalanceSubtitle,icon:z,color:"pink"}),t.jsx(C,{title:a.partnerConnectionStatus.managedUsersCount,value:a.partnerConnectionStatus.peopleCount.replace("{{count}}",T.totalUsers.toLocaleString()),subtitle:a.partnerConnectionStatus.managedUsersSubtitle,icon:G,color:"cyan"}),t.jsx(C,{title:a.partnerConnectionStatus.userBalanceTotal,value:`â‚©${T.totalUserBalance.toLocaleString()}`,subtitle:a.partnerConnectionStatus.userBalanceSubtitle,icon:H,color:"amber"})]}),I?t.jsx("div",{className:"flex items-center justify-center py-16",children:t.jsxs("div",{className:"text-center space-y-3",children:[t.jsx("div",{className:"w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:a.partnerConnectionStatus.loadingData})]})}):t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"flex items-center justify-between px-1",children:t.jsxs("p",{className:"text-sm text-muted-foreground",children:[a.partnerConnectionStatus.totalPartners.replace("{{count}}",w.length.toString()),h&&` ${a.partnerConnectionStatus.searchResults.replace("{{total}}",g.length.toString())}`]})}),t.jsx(K,{data:w,columns:A,emptyMessage:h?a.partnerConnectionStatus.noSearchResults:a.partnerConnectionStatus.noPartners,rowKey:"id"})]})]})}export{re as PartnerConnectionStatus};
