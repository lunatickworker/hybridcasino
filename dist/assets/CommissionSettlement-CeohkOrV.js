import{r as o,j as t}from"./react-core-BwkdTuSg.js";import{a as Y,s as G,l as Q,h as p,H as O,C as U,E as J,F as K,G as X,S as T,o as R,p as I,q as k,r as i,e as Z,B as tt}from"./index-CGvwOXPh.js";import{P as et,a as st,b as nt}from"./popover-zgyRlH_H.js";import{C as at}from"./calendar-ChZkltzG.js";import{k as r,n as v,p as j}from"./vendor-D410aui4.js";import{M as S}from"./MetricCard-Bg9coGoy.js";import{a as lt}from"./settlementCalculator-BoiNnd7Z.js";import{e as ot}from"./settlementExecutor-CwQNwCgK.js";import{R as it,ap as rt,o as mt,T as ct,ar as dt,W as xt,e as ht,a2 as gt,Q as ut}from"./lucide-icons-CAeZOOE5.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";function _t({user:C}){const{t:e}=Y(),[F,b]=o.useState(!0),[f,y]=o.useState(!1),[w,L]=o.useState(!1),[pt,M]=o.useState("direct_subordinate"),[h,W]=o.useState("today"),[l,E]=o.useState(),[g,A]=o.useState("all"),[u,D]=o.useState([]),[a,_]=o.useState({totalRollingCommission:0,totalLosingCommission:0,totalWithdrawalCommission:0,totalCommission:0,partnerCount:0});o.useEffect(()=>{B(),N()},[C.id,h,l,g]);const B=async()=>{try{const{data:s,error:n}=await G.from("system_settings").select("setting_value").eq("setting_key","settlement_method").maybeSingle();if(n)throw n;s&&M(s.setting_value)}catch(s){console.error(e.settlement.settlementMethodLoadFailed,s)}},P=()=>{const s=new Date,n=new Date(s.getFullYear(),s.getMonth(),s.getDate());switch(h){case"today":return{start:n.toISOString(),end:new Date(n.getTime()+1440*60*1e3).toISOString()};case"yesterday":return{start:new Date(n.getTime()-1440*60*1e3).toISOString(),end:n.toISOString()};case"week":return{start:new Date(n.getTime()-10080*60*1e3).toISOString(),end:new Date(n.getTime()+1440*60*1e3).toISOString()};case"month":return{start:new Date(s.getFullYear(),s.getMonth(),1).toISOString(),end:new Date(n.getTime()+1440*60*1e3).toISOString()};case"custom":if(l?.from){const x=new Date(l.from),H=l.to?new Date(l.to):new Date(l.from);return{start:x.toISOString(),end:new Date(H.getTime()+1440*60*1e3).toISOString()}}return{start:n.toISOString(),end:new Date(n.getTime()+1440*60*1e3).toISOString()};default:return{start:n.toISOString(),end:new Date(n.getTime()+1440*60*1e3).toISOString()}}},N=async()=>{try{f||b(!0);const{start:s,end:n}=P(),m=await lt(C.id,s,n,g);if(m.length===0){D([]),_({totalRollingCommission:0,totalLosingCommission:0,totalWithdrawalCommission:0,totalCommission:0,partnerCount:0});return}D(m);const c=m.reduce((d,x)=>({totalRollingCommission:d.totalRollingCommission+x.rolling_commission,totalLosingCommission:d.totalLosingCommission+x.losing_commission,totalWithdrawalCommission:d.totalWithdrawalCommission+x.withdrawal_commission,totalCommission:d.totalCommission+x.total_commission,partnerCount:d.partnerCount+1}),{totalRollingCommission:0,totalLosingCommission:0,totalWithdrawalCommission:0,totalCommission:0,partnerCount:0});_(c)}catch(s){console.error("수수료 계산 실패:",s),r.error(e.settlement.commissionLoadFailed)}finally{b(!1),y(!1)}},$=()=>{y(!0),N()},z=()=>{r.info(e.settlement.exportExcelPreparing)},V=async()=>{if(a.totalCommission<=0){r.error(e.settlement.noCommissionToSettle);return}if(u.length===0){r.error(e.settlement.noPartnersToSettle);return}const s=e.settlement.confirmSettlement.replace("{count}",u.length.toString()).replace("{total}",a.totalCommission.toLocaleString()).replace("{rolling}",a.totalRollingCommission.toLocaleString()).replace("{losing}",a.totalLosingCommission.toLocaleString()).replace("{withdrawal}",a.totalWithdrawalCommission.toLocaleString());if(window.confirm(s)){L(!0);try{const{start:n,end:m}=P(),c=await ot(C.id,n,m,h,g);c.success?(r.success(c.message),N()):r.error(c.message||e.settlement.integratedSettlementFailed)}catch(n){console.error("정산 실행 오류:",n),r.error(e.settlement.integratedSettlementError)}finally{L(!1)}}},q=s=>{switch(s){case 2:return e.settlement.masterAgency;case 3:return e.settlement.mainAgency;case 4:return e.settlement.subAgency;case 5:return e.settlement.distributor;case 6:return e.settlement.store;default:return e.settlement.unknown}};return F?t.jsx("div",{className:"flex items-center justify-center h-96",children:t.jsx(Q,{})}):t.jsxs("div",{className:"space-y-6 p-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl text-white mb-2",children:e.settlement.commissionSettlementTitle}),t.jsx("p",{className:"text-slate-400",children:e.settlement.commissionSettlementSubtitle})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs(p,{variant:"outline",size:"sm",onClick:$,disabled:f,children:[t.jsx(it,{className:O("h-4 w-4 mr-2",f&&"animate-spin")}),e.common.refresh]}),t.jsxs(p,{variant:"outline",size:"sm",onClick:z,children:[t.jsx(rt,{className:"h-4 w-4 mr-2"}),e.settlement.exportExcel]}),t.jsxs(p,{variant:"default",size:"sm",onClick:V,disabled:w||a.totalCommission<=0,className:"bg-orange-600 hover:bg-orange-700",children:[t.jsx(mt,{className:O("h-4 w-4 mr-2",w&&"animate-spin")}),w?e.settlement.settling:e.settlement.executeSettlement]})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-5",children:[t.jsx(S,{title:e.settlement.rollingCommission,value:`₩${a.totalRollingCommission.toLocaleString()}`,subtitle:e.settlement.rollingCommissionSubtitle,icon:ct,color:"blue"}),t.jsx(S,{title:e.settlement.losingCommission,value:`₩${a.totalLosingCommission.toLocaleString()}`,subtitle:e.settlement.losingCommissionSubtitle,icon:dt,color:"purple"}),t.jsx(S,{title:e.settlement.withdrawalCommission,value:`₩${a.totalWithdrawalCommission.toLocaleString()}`,subtitle:e.settlement.withdrawalCommissionSubtitle,icon:xt,color:"emerald"}),t.jsx(S,{title:e.settlement.totalCommission,value:`₩${a.totalCommission.toLocaleString()}`,subtitle:e.settlement.totalCommissionSubtitle,icon:ht,color:"orange"})]}),t.jsxs(U,{children:[t.jsx(J,{children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx(K,{children:e.settlement.partnerCommissionDetails}),t.jsx(X,{children:e.settlement.partnerCommissionDetailsDesc.replace("{count}",a.partnerCount.toString())})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs(T,{value:g,onValueChange:s=>A(s),children:[t.jsx(R,{className:"w-[140px]",children:t.jsx(I,{})}),t.jsxs(k,{children:[t.jsx(i,{value:"all",children:e.settlement.allApi}),t.jsx(i,{value:"invest",children:e.settlement.investOnly}),t.jsx(i,{value:"oroplay",children:e.settlement.oroplaysOnly})]})]}),t.jsxs(T,{value:h,onValueChange:W,children:[t.jsx(R,{className:"w-[180px]",children:t.jsx(I,{})}),t.jsxs(k,{children:[t.jsx(i,{value:"today",children:e.settlement.today}),t.jsx(i,{value:"yesterday",children:e.settlement.yesterday}),t.jsx(i,{value:"week",children:e.settlement.lastWeek}),t.jsx(i,{value:"month",children:e.settlement.thisMonth}),t.jsx(i,{value:"custom",children:e.settlement.customPeriod})]})]}),h==="custom"&&t.jsxs(et,{children:[t.jsx(st,{asChild:!0,children:t.jsxs(p,{variant:"outline",className:"w-[280px] justify-start text-left",children:[t.jsx(gt,{className:"mr-2 h-4 w-4"}),l?.from?l.to?t.jsxs(t.Fragment,{children:[v(l.from,"PPP",{locale:j})," -"," ",v(l.to,"PPP",{locale:j})]}):v(l.from,"PPP",{locale:j}):t.jsx("span",{children:e.settlement.selectDate})]})}),t.jsx(nt,{className:"w-auto p-0",align:"end",children:t.jsx(at,{initialFocus:!0,mode:"range",defaultMonth:l?.from,selected:l,onSelect:E,numberOfMonths:2,locale:j})})]})]})]})}),t.jsx(Z,{children:u.length===0?t.jsxs("div",{className:"text-center py-12 text-slate-400",children:[t.jsx(ut,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),t.jsx("p",{children:e.settlement.noSubPartners})]}):t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"border-b border-slate-700",children:[t.jsx("th",{className:"text-left p-3 text-slate-400",children:e.settlement.partner}),t.jsx("th",{className:"text-left p-3 text-slate-400",children:e.settlement.grade}),t.jsx("th",{className:"text-right p-3 text-slate-400",children:e.settlement.betAmount}),t.jsx("th",{className:"text-right p-3 text-slate-400",children:e.settlement.rollingCommission}),t.jsx("th",{className:"text-right p-3 text-slate-400",children:e.settlement.losingCommission}),t.jsx("th",{className:"text-right p-3 text-slate-400",children:e.settlement.withdrawalCommission}),t.jsx("th",{className:"text-right p-3 text-slate-400",children:e.settlement.totalCommission})]})}),t.jsx("tbody",{children:u.map(s=>t.jsxs("tr",{className:"border-b border-slate-800 hover:bg-slate-800/30",children:[t.jsx("td",{className:"p-3",children:t.jsxs("div",{children:[t.jsx("p",{className:"text-white",children:s.partner_nickname}),t.jsx("p",{className:"text-xs text-slate-400",children:s.partner_username})]})}),t.jsx("td",{className:"p-3",children:t.jsx(tt,{variant:"outline",children:q(s.partner_level)})}),t.jsxs("td",{className:"p-3 text-right text-slate-300",children:["₩",s.total_bet_amount.toLocaleString()]}),t.jsx("td",{className:"p-3 text-right",children:t.jsxs("div",{children:[t.jsxs("p",{className:"text-blue-400",children:["₩",s.rolling_commission.toLocaleString()]}),t.jsxs("p",{className:"text-xs text-slate-500",children:[s.commission_rolling,"%"]})]})}),t.jsx("td",{className:"p-3 text-right",children:t.jsxs("div",{children:[t.jsxs("p",{className:"text-purple-400",children:["₩",s.losing_commission.toLocaleString()]}),t.jsxs("p",{className:"text-xs text-slate-500",children:[s.commission_losing,"%"]})]})}),t.jsx("td",{className:"p-3 text-right",children:t.jsxs("div",{children:[t.jsxs("p",{className:"text-green-400",children:["₩",s.withdrawal_commission.toLocaleString()]}),t.jsxs("p",{className:"text-xs text-slate-500",children:[s.withdrawal_fee,"%"]})]})}),t.jsx("td",{className:"p-3 text-right",children:t.jsxs("p",{className:"text-orange-400 font-mono",children:["₩",s.total_commission.toLocaleString()]})})]},s.partner_id))}),t.jsx("tfoot",{children:t.jsxs("tr",{className:"bg-slate-800/50 border-t-2 border-slate-600",children:[t.jsx("td",{colSpan:3,className:"p-3 text-white",children:e.settlement.totalSum}),t.jsxs("td",{className:"p-3 text-right text-blue-400 font-mono",children:["₩",a.totalRollingCommission.toLocaleString()]}),t.jsxs("td",{className:"p-3 text-right text-purple-400 font-mono",children:["₩",a.totalLosingCommission.toLocaleString()]}),t.jsxs("td",{className:"p-3 text-right text-green-400 font-mono",children:["₩",a.totalWithdrawalCommission.toLocaleString()]}),t.jsxs("td",{className:"p-3 text-right text-orange-400 font-mono",children:["₩",a.totalCommission.toLocaleString()]})]})})]})})})]})]})}export{_t as CommissionSettlement};
