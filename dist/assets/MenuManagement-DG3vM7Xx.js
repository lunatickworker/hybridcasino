import{r as c,j as e}from"./react-core-BwkdTuSg.js";import{a as Y,B as p,h as q,S as Z,o as ee,p as se,q as te,r as ae,s as u}from"./index-Be3DOFuy.js";import{S as ne}from"./switch-DeEE5hHI.js";import{k as m}from"./vendor-D410aui4.js";import{b as I,f as re,R as b,aC as z,Q as G,M as le,o as _,n as ie,E as me}from"./lucide-icons-D2Pw2Rdn.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";function fe({user:d}){const{t:n}=Y(),[f,v]=c.useState([]),[x,V]=c.useState(""),[Q,M]=c.useState(null),[h,y]=c.useState([]),[j,N]=c.useState([]),[P,E]=c.useState(!1),[S,B]=c.useState(!1),[T,L]=c.useState(!1),[ce,F]=c.useState(new Set),D=async()=>{try{if(E(!0),d.level===1){const{data:s,error:t}=await u.from("partners").select("id, username, nickname, level, status").eq("status","active").order("level",{ascending:!0}).order("nickname",{ascending:!0});if(t)throw t;v(s||[]),(!s||s.length===0)&&m.warning(n.menuManagement.noActivePartners)}else{const{data:s,error:t}=await u.rpc("get_hierarchical_partners",{p_partner_id:d.id});if(t){console.error("í•˜ìœ„ íŒŒíŠ¸ë„ˆ ì¡°íšŒ ì‹¤íŒ¨:",t);const{data:a,error:r}=await u.from("partners").select("id, username, nickname, level, status").eq("status","active").eq("parent_id",d.id).order("level",{ascending:!0}).order("nickname",{ascending:!0});r?(console.error("ì§ì ‘ í•˜ìœ„ ì¡°íšŒë„ ì‹¤íŒ¨:",r),v([])):(v(a||[]),(!a||a.length===0)&&m.warning(n.menuManagement.noPartners))}else{const a=(s||[]).filter(r=>r.status==="active");v(a),console.log("âœ… ê³„ì¸µ íŒŒíŠ¸ë„ˆ ì¡°íšŒ ì™„ë£Œ:",{total:a.length,by_level:a.reduce((r,i)=>(r[i.level]=(r[i.level]||0)+1,r),{})}),a.length===0&&m.warning(n.menuManagement.noPartners)}}}catch(s){console.error("íŒŒíŠ¸ë„ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:",s),m.error(n.menuManagement.loadPartnersFailed)}finally{E(!1)}},A=async()=>{try{const{data:s,error:t,count:a}=await u.from("menu_permissions").select("*",{count:"exact"}).eq("is_visible",!0).order("display_order",{ascending:!0}).order("menu_name",{ascending:!0});if(console.log("ë©”ë‰´ ê¶Œí•œ ì¡°íšŒ ê²°ê³¼:",{success:!t,count:a,dataLength:s?.length,error:t}),t){console.error("ë©”ë‰´ ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì—ëŸ¬:",t),t.code==="PGRST116"||t.message?.includes("permission")?m.error("ë©”ë‰´ ë°ì´í„° ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."):m.error(`ë©”ë‰´ ê¶Œí•œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${t.message}`),y([]);return}y(s||[]),!s||s.length===0?m.warning("ë©”ë‰´ ê¶Œí•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. DB ìŠ¤í‚¤ë§ˆ(205ë²ˆ)ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.",{description:"Supabase SQL Editorì—ì„œ database/205_menu-management-schema.sql íŒŒì¼ì„ ì‹¤í–‰í•˜ì„¸ìš”."}):console.log(`âœ… ë©”ë‰´ ê¶Œí•œ ${s.length}ê°œ ë¡œë“œ ì„±ê³µ`)}catch(s){console.error("ë©”ë‰´ ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:",s),m.error("ë©”ë‰´ ê¶Œí•œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),y([])}},k=async s=>{if(!s){N([]),M(null);return}try{B(!0);const t=f.find(l=>l.id===s);if(M(t||null),!t){m.error("ì„ íƒëœ íŒŒíŠ¸ë„ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");return}let a=h;if(d.level!==1&&t.parent_id){const{data:l,error:g}=await u.from("partner_menu_permissions").select(`
            menu_permission_id,
            is_enabled,
            menu_permission:menu_permissions(*)
          `).eq("partner_id",t.parent_id).eq("is_enabled",!0);if(g)console.error("ìƒìœ„ íŒŒíŠ¸ë„ˆ ë©”ë‰´ ì¡°íšŒ ì˜¤ë¥˜:",g);else if(l&&l.length>0){const w=new Set(l.map($=>$.menu_permission_id));a=h.filter($=>w.has($.id))}}const{data:r,error:i}=await u.from("partner_menu_permissions").select(`
          *,
          menu_permission:menu_permissions(*)
        `).eq("partner_id",s);if(i)throw i;const o=a.filter(l=>!r?.some(g=>g.menu_permission_id===l.id));if(o.length>0){const l=o.map(w=>({partner_id:s,menu_permission_id:w.id,is_enabled:t.level<=w.partner_level})),{error:g}=await u.from("partner_menu_permissions").insert(l);g&&console.error("ê¸°ë³¸ ë©”ë‰´ ê¶Œí•œ ìƒì„± ì‹¤íŒ¨:",g)}const{data:C,error:R}=await u.from("partner_menu_permissions").select(`
          *,
          menu_permission:menu_permissions(*)
        `).eq("partner_id",s);if(R)throw R;const K=(C||[]).map(l=>({...l,menu_permission:Array.isArray(l.menu_permission)?l.menu_permission[0]:l.menu_permission})),W=new Set(a.map(l=>l.id)),H=K.filter(l=>W.has(l.menu_permission_id));N(H);const X=new Set(H.map(l=>l.menu_permission?.parent_menu||"ê¸°ë³¸ ë©”ë‰´").filter(Boolean));F(X)}catch(t){console.error("íŒŒíŠ¸ë„ˆ ë©”ë‰´ ê¶Œí•œ ë¡œë“œ ì‹¤íŒ¨:",t),m.error("íŒŒíŠ¸ë„ˆ ë©”ë‰´ ê¶Œí•œì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),N([])}finally{B(!1)}},U=async(s,t)=>{try{L(!0);const a=s.menu_permission?.menu_name||"ë©”ë‰´";if(console.log("ğŸ”§ ë©”ë‰´ ê¶Œí•œ ì—…ë°ì´íŠ¸ ì‹œì‘:",{menu_name:a,pmp_id:s.id,menu_permission_id:s.menu_permission_id,current_enabled:s.is_enabled,new_enabled:t,has_menu_permission:!!s.menu_permission}),!s.id){console.error("âŒ PMP IDê°€ ì—†ìŠµë‹ˆë‹¤:",s),m.error(`${a}: IDê°€ ì—†ì–´ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);return}if(!s.menu_permission_id){console.error("âŒ menu_permission_idê°€ ì—†ìŠµë‹ˆë‹¤:",s),m.error(`${a}: menu_permission_idê°€ ì—†ì–´ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);return}const{error:r}=await u.from("partner_menu_permissions").update({is_enabled:t,updated_at:new Date().toISOString()}).eq("id",s.id);if(r)throw console.error("âŒ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:",{menu_name:a,error_code:r.code,error_message:r.message,error_details:r.details}),r;console.log("âœ… DB ì—…ë°ì´íŠ¸ ì„±ê³µ:",{menu_name:a,new_enabled:t}),N(i=>i.map(o=>o.id===s.id?{...o,is_enabled:t}:o)),m.success(`${a} ${t?"í™œì„±í™”":"ë¹„í™œì„±í™”"} ì™„ë£Œ`,{description:`ë©”ë‰´ ê¶Œí•œì´ ì„±ê³µì ìœ¼ë¡œ ${t?"í™œì„±í™”":"ë¹„í™œì„±í™”"}ë˜ì—ˆìŠµë‹ˆë‹¤.`})}catch(a){const r=s.menu_permission?.menu_name||"ë©”ë‰´";console.error("âŒ ë©”ë‰´ ê¶Œí•œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:",a),m.error(`${r} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${a.message||"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`)}finally{L(!1)}};c.useEffect(()=>{D(),A()},[d.id]),c.useEffect(()=>{if(x&&h.length>0){const s=f.find(t=>t.id===x);M(s||null),k(x)}},[x,h,f]);const J=j.reduce((s,t)=>{const a=t.menu_permission?.parent_menu||"ê¸°ë³¸ ë©”ë‰´";return s[a]||(s[a]=[]),s[a].push(t),s},{}),O=s=>{switch(s){case 1:return"badge-premium-danger";case 2:return"badge-premium-primary";case 3:return"badge-premium-success";default:return"badge-premium-warning"}};return e.jsxs("div",{className:"h-full flex flex-col overflow-hidden p-4 space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between px-4 py-2 rounded-lg bg-slate-900/50 border border-blue-500/30 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-blue-500/20 to-blue-600/20 border border-blue-400/30",children:e.jsx(I,{className:"h-5 w-5 text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-slate-100",children:n.menu.menuManagement}),e.jsx("p",{className:"text-xs text-slate-400",children:d.nickname})]})]})}),e.jsxs("div",{className:"glass-card p-3 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4 text-blue-400"}),e.jsx("span",{className:"text-sm text-slate-200",children:d.level===1?n.menuManagement.selectHeadOffice:n.menuManagement.selectPartner})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[P&&e.jsx(b,{className:"h-3 w-3 animate-spin text-blue-400"}),e.jsxs(p,{variant:"outline",className:"border-blue-400/30 text-blue-300 text-xs h-5",children:[e.jsx(z,{className:"h-3 w-3 mr-1"}),f.length,"ê°œ"]})]})]}),e.jsx("div",{children:P?e.jsxs("div",{className:"flex items-center justify-center py-4 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(b,{className:"h-4 w-4 animate-spin mr-2 text-blue-400"}),e.jsx("span",{className:"text-sm text-slate-300",children:n.common.loading})]}):f.length===0?e.jsxs("div",{className:"text-center py-6 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(G,{className:"h-8 w-8 mx-auto mb-2 text-slate-500"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:n.menuManagement.noActivePartners}),e.jsxs(q,{onClick:D,variant:"outline",size:"sm",children:[e.jsx(b,{className:"h-3 w-3 mr-1"}),n.menuManagement.retry]})]}):e.jsxs(Z,{value:x,onValueChange:V,disabled:P,children:[e.jsx(ee,{className:"w-full input-premium h-9 text-sm",children:e.jsx(se,{placeholder:d.level===1?n.menuManagement.selectHeadOfficePlaceholder:n.menuManagement.selectPartnerPlaceholder})}),e.jsx(te,{className:"bg-slate-900 border-slate-700",children:f.sort((s,t)=>s.level!==t.level?s.level-t.level:s.nickname.localeCompare(t.nickname)).map(s=>{const t=Math.max(0,s.level-2),a=t>0?`${t*1.5}rem`:"0";return e.jsx(ae,{value:s.id,className:"text-slate-200 focus:bg-slate-800 py-1",style:{paddingLeft:`calc(0.5rem + ${a})`},children:e.jsxs("div",{className:"flex items-center gap-2",children:[t>0&&e.jsx("span",{className:"text-slate-600 text-xs",children:"â””â”€".repeat(1)}),e.jsxs(p,{className:`${O(s.level)} text-xs h-4`,children:["L",s.level]}),e.jsx("span",{className:"text-sm",children:s.nickname}),e.jsxs("span",{className:"text-slate-400 text-xs",children:["(",s.username,")"]})]})},s.id)})})]})})]}),x&&e.jsxs("div",{className:"glass-card flex flex-col flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700/50 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4 text-emerald-400"}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm text-slate-200",children:[Q?.nickname," ",n.menuManagement.menuVisibilitySettings]}),e.jsx("p",{className:"text-xs text-slate-400",children:n.menuManagement.visibilityDescription})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"outline",className:"border-emerald-400/30 text-emerald-300 text-xs h-5",children:[e.jsx(_,{className:"h-3 w-3 mr-1"}),j.filter(s=>s.is_enabled).length,"/",j.length]}),e.jsxs(q,{onClick:()=>k(x),variant:"outline",size:"sm",disabled:S,className:"border-blue-400/30 hover:bg-blue-500/10 h-7 text-xs px-2",children:[e.jsx(b,{className:`h-3 w-3 mr-1 ${S?"animate-spin":""}`}),n.common.refresh]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3",children:S?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx("div",{className:"loading-premium mb-4"}),e.jsx("span",{className:"text-sm text-slate-300",children:n.menuManagement.loadingMenus})]}):j.length===0?e.jsxs("div",{className:"text-center py-8 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(G,{className:"h-12 w-12 mx-auto mb-3 text-slate-500"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:n.menuManagement.noMenuData}),e.jsx("p",{className:"text-xs text-slate-400 mb-3",children:h.length===0?"menu_permissions í…Œì´ë¸”ì— ê¸°ë³¸ ë©”ë‰´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.":"í•´ë‹¹ íŒŒíŠ¸ë„ˆì—ê²Œ í• ë‹¹ ê°€ëŠ¥í•œ ë©”ë‰´ê°€ ì—†ê±°ë‚˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:[e.jsxs("p",{children:["â€¢ ",n.menuManagement.baseMenus,": ",h.length,"ê°œ"]}),e.jsxs("p",{children:["â€¢ ",n.menuManagement.partnerMenus,": ",j.length,"ê°œ"]})]}),h.length===0&&e.jsxs("div",{className:"bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-left",children:[e.jsxs("p",{className:"text-xs text-amber-300 mb-1",children:["âš ï¸ ",n.menuManagement.actionRequired]}),e.jsx("p",{className:"text-xs text-slate-400",children:n.menuManagement.sqlRequired})]})]}),e.jsxs(q,{onClick:()=>{A(),k(x)},variant:"outline",size:"sm",className:"btn-premium-primary",children:[e.jsx(b,{className:"h-3 w-3 mr-1"}),n.menuManagement.retry]})]}):e.jsx("div",{className:"space-y-1.5",children:Object.entries(J).map(([s,t])=>{const a=t.filter(r=>r.is_enabled).length;return e.jsxs("div",{className:"glass-card border-slate-700/50",children:[e.jsxs("div",{className:"px-3 py-1.5 bg-slate-800/50 border-b border-slate-700/50 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"h-3 w-3 text-blue-400"}),e.jsx("h4",{className:"text-xs text-slate-200",children:s}),e.jsxs(p,{variant:"outline",className:"border-slate-600/50 text-slate-400 text-[10px] h-4 px-1",children:[t.length,"ê°œ"]})]}),e.jsxs(p,{className:`text-[10px] h-4 px-1 ${a===t.length?"badge-premium-success":a>0?"badge-premium-warning":"badge-premium-danger"}`,children:[a," / ",t.length," í™œì„±"]})]}),e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 gap-2 p-2",children:t.sort((r,i)=>{const o=r.menu_permission?.display_order??999,C=i.menu_permission?.display_order??999;return o-C}).map(r=>{const i=r.menu_permission;return i?e.jsxs("div",{className:`
                                px-2 py-1.5 rounded-lg border transition-all
                                ${r.is_enabled?"bg-emerald-500/5 border-emerald-500/30 hover:bg-emerald-500/10":"bg-slate-800/20 border-slate-700/30 hover:bg-slate-800/40"}
                              `,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[r.is_enabled?e.jsx(ie,{className:"h-3 w-3 text-emerald-400 flex-shrink-0 mt-0.5"}):e.jsx(me,{className:"h-3 w-3 text-slate-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-0.5",children:[e.jsx("span",{className:"text-xs text-slate-200 truncate",children:i.menu_name}),e.jsxs(p,{className:`text-[8px] px-1 py-0 h-3 flex-shrink-0 ${O(i.partner_level)}`,children:["L",i.partner_level]})]}),e.jsx("p",{className:"text-[9px] text-slate-400 truncate",children:i.menu_path})]})]}),e.jsx(ne,{checked:r.is_enabled,disabled:T,onCheckedChange:o=>U(r,o),className:"flex-shrink-0 scale-75"})]}),r.is_enabled&&e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(p,{className:"badge-premium-success text-[9px] h-3.5 px-1",children:"í™œì„±"})})]},r.id):null})})]},s)})})})]}),!x&&e.jsx("div",{className:"glass-card flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md px-4 space-y-3",children:[e.jsx("div",{className:"p-4 rounded-xl bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-400/20 inline-block",children:e.jsx(I,{className:"h-12 w-12 text-blue-400"})}),e.jsx("h3",{className:"text-lg text-slate-200",children:d.level===1?n.menuManagement.selectHeadOfficePrompt:n.menuManagement.selectPartnerPrompt}),e.jsxs("p",{className:"text-xs text-slate-400",children:[d.level===1?n.menuManagement.selectHeadOffice:n.menuManagement.selectPartner," í•­ëª©ì„ ì„ íƒí•˜ì—¬ ë©”ë‰´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”"]}),e.jsxs("div",{className:"pt-4 space-y-2 text-left",children:[e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(_,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:n.menuManagement.features.onlyActiveMenus})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(_,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:n.menuManagement.features.toggleMenus})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(_,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:n.menuManagement.features.levelBasedMenus})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(_,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:n.menuManagement.features.realtimeUpdate})]})]})]})})]})}export{fe as MenuManagement};
