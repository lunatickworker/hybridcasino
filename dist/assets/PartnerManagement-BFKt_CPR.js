const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-McppjVnx.js","assets/react-core-BwkdTuSg.js","assets/vendor-D410aui4.js","assets/radix-ui-omyR4zpf.js","assets/lucide-icons-CePlpqHy.js","assets/supabase-C8Oa5ukG.js","assets/index-B69pnHHb.css","assets/settlementCalculator-U6Ra3Zw5.js"])))=>i.map(i=>d[i]);
import{n as Ya,o as Ja,a as Qa,s as c,_ as Ie,B as I,i as M,m as ga,T as Xa,j as Za,k as ha,l as Pe,C as V,F as H,G,H as De,h as R,I as S,S as Te,p as Fe,q as Ee,r as $e,t as P,L as w}from"./index-McppjVnx.js";import{r as x,j as e}from"./react-core-BwkdTuSg.js";import{A as Oe,a as Ae,b as Be,c as qe,d as Ue,e as Ve}from"./AdminDialog-D_QT-Qbt.js";import{k as u}from"./vendor-D410aui4.js";import{M as F}from"./MetricCard-DnMFhTGK.js";import{PartnerTransactions as et}from"./PartnerTransactions-FwoRRefj.js";import{F as at}from"./ForceTransactionModal-Q9UFVw2D.js";import{f as A,U as He,g as Ge,h as Re,a3 as tt,ap as xa,_ as fa,n as ze,ag as We,aq as rt,N as nt,S as Z,w as st,T as lt,a9 as le,ar as _a}from"./lucide-icons-CePlpqHy.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";import"./DataTable-w2U-jZDQ.js";import"./table-CKCHMZ5m.js";import"./popover-e-C_onM2.js";import"./command-BcDTzi9L.js";const W={system_admin:"bg-purple-500",head_office:"bg-red-500",main_office:"bg-orange-500",sub_office:"bg-yellow-500",distributor:"bg-blue-500",store:"bg-green-500"},va={active:"bg-green-500",inactive:"bg-gray-500",blocked:"bg-red-500"};function Ct(){const{authState:n}=Ya(),{connected:ee,sendMessage:B}=Ja(),{t:r}=Qa(),q={system_admin:r.partnerManagement.systemAdmin,head_office:r.partnerManagement.headOffice,main_office:r.partnerManagement.mainOffice,sub_office:r.partnerManagement.subOffice,distributor:r.partnerManagement.distributor,store:r.partnerManagement.store},Ke={active:r.partnerManagement.active,inactive:r.partnerManagement.inactive,blocked:r.partnerManagement.blocked},[k,K]=x.useState([]),[z,U]=x.useState(!0),[ie,ba]=x.useState(""),[oe,ya]=x.useState("all"),[ce,ja]=x.useState("all"),[L,ae]=x.useState(null),[wa,te]=x.useState(!1),[Na,Y]=x.useState(!1),[Ma,J]=x.useState(!1),[C,re]=x.useState(null),[de,Q]=x.useState(""),[me,Ye]=x.useState(!1),[pe,Sa]=x.useState(!1),[ue,ka]=x.useState("hierarchy"),[La,Ca]=x.useState({}),[ne,Je]=x.useState([]),[ge,he]=x.useState(new Set),[Qe,Xe]=x.useState(!1),[xe,Ze]=x.useState(""),[fe,Ia]=x.useState({rolling:.5,losing:5,fee:1}),[Pa,_e]=x.useState(!1),[Da,ve]=x.useState("deposit"),[E,ea]=x.useState(null),[it,be]=x.useState({invest:0,oroplay:0}),[Ta,Fa]=x.useState(0),[Ea,ye]=x.useState(0),[$a,je]=x.useState(0),[y,we]=x.useState(null),[i,b]=x.useState({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:"",commission_rolling:.5,commission_losing:5,withdrawal_fee:0,min_withdrawal_amount:1e4,max_withdrawal_amount:1e6,daily_withdrawal_limit:5e6}),[ot,aa]=x.useState(!1),[ct,ta]=x.useState(null),[dt,ra]=x.useState(""),[mt,na]=x.useState(""),[pt,sa]=x.useState("deposit"),[ut,gt]=x.useState(!1),la=async a=>{try{const{data:t,error:l}=await c.from("partners").select("commission_rolling, commission_losing, withdrawal_fee, partner_type, nickname").eq("id",a).maybeSingle();return l?(console.error("[Partner Commission Error]:",l),null):t?{rolling:t.commission_rolling||100,losing:t.commission_losing||100,fee:t.withdrawal_fee||100,nickname:t.nickname}:null}catch(t){return console.error("[Partner Commission Fetch Failed]:",t),null}},ia=async()=>{if(!n.user?.id)return;const a=await la(n.user.id);a&&we(a)},oa=async()=>{try{const{data:a,error:t}=await c.from("system_settings").select("setting_key, setting_value").in("setting_key",["default_rolling_commission","default_losing_commission","default_withdrawal_fee"]);if(t){console.error("[System Default Commission Load Error]:",t);return}if(a&&a.length>0){const l={rolling:.5,losing:5,fee:1};a.forEach(s=>{s.setting_key==="default_rolling_commission"?l.rolling=parseFloat(s.setting_value)||.5:s.setting_key==="default_losing_commission"?l.losing=parseFloat(s.setting_value)||5:s.setting_key==="default_withdrawal_fee"&&(l.fee=parseFloat(s.setting_value)||1)}),Ia(l),b(s=>({...s,commission_rolling:l.rolling,commission_losing:l.losing,withdrawal_fee:l.fee}))}}catch(a){console.error("[System Default Commission Load Failed]:",a)}},Oa=async()=>{if(!n.user?.id||n.user?.level!==1){be({invest:0,oroplay:0});return}try{const{data:a,error:t}=await c.from("api_configs").select("invest_balance, oroplay_balance").eq("partner_id",n.user.id).single();if(t){console.error("âŒ Lv1 api_configs ì¡°íšŒ ì‹¤íŒ¨:",t);return}a&&(be({invest:a.invest_balance||0,oroplay:a.oroplay_balance||0}),console.log("ğŸ’° Lv1 API ë³´ìœ ê¸ˆ ì¡°íšŒ:",{invest:a.invest_balance,oroplay:a.oroplay_balance}))}catch(a){console.error("âŒ Lv1 API ë³´ìœ ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨:",a)}},Aa=async()=>{if(n.user?.id)try{const{data:a,error:t}=await c.from("partners").select("balance, level, invest_balance, oroplay_balance").eq("id",n.user.id).single();if(t)throw t;if(console.log("ğŸ’° [PartnerManagement] ê´€ë¦¬ì ë³´ìœ ê¸ˆ ì¡°íšŒ (partners í…Œì´ë¸”):",{level:a?.level,balance:a?.balance,invest_balance:a?.invest_balance,oroplay_balance:a?.oroplay_balance}),a?.level===1){const{data:l,error:s}=await c.from("api_configs").select("invest_balance, oroplay_balance").eq("partner_id",n.user.id).single();!s&&l?(ye(l.invest_balance||0),je(l.oroplay_balance||0),console.log("âœ… Lv1 ë³´ìœ ê¸ˆ ì„¤ì • (api_configs):",{invest:l.invest_balance||0,oroplay:l.oroplay_balance||0})):(console.warn("âš ï¸ Lv1 api_configs ì¡°íšŒ ì‹¤íŒ¨:",s),ye(0),je(0))}else if(a?.level===2){const{data:l}=await c.from("partners").select("parent_id").eq("id",n.user.id).single();let s=!1,d=!1;if(l?.parent_id){const{data:p}=await c.from("api_configs").select("invest_hidden, oroplay_hidden").eq("partner_id",l.parent_id).single();p&&(s=p.invest_hidden||!1,d=p.oroplay_hidden||!1)}const o=s?0:a?.invest_balance||0,h=d?0:a?.oroplay_balance||0;ye(o),je(h),console.log("âœ… Lv2 ë³´ìœ ê¸ˆ ì„¤ì • (ë…¸ì¶œëœ ê²Œì„ì‚¬ë§Œ):",{invest:o,investHidden:s,oroplay:h,oroplayHidden:d})}else Fa(a?.balance||0),console.log("âœ… Lv3~7 ë³´ìœ ê¸ˆ ì„¤ì •:",a?.balance||0)}catch(a){console.error("âŒ í˜„ì¬ ì‚¬ìš©ì ë³´ìœ ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨:",a)}};x.useEffect(()=>{n.user?.id&&(oa(),ia(),O(),Ne(),Oa(),Aa())},[n.user?.id]),x.useEffect(()=>{if(!n.user?.id)return;console.log("âœ… Realtime êµ¬ë…: partners.balance ë³€ê²½ ê°ì§€");const a=c.channel("partner_balance_changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"partners"},s=>{const d=s.new.id,o=s.old.balance,h=s.new.balance;o!==h&&K(p=>{const g=p.find(v=>v.id===d);return g?g.level===1?(console.log("â­ï¸ Lv1 balance ë³€ê²½ ë¬´ì‹œ (api_configs ì‚¬ìš©)"),p):g.level===2?(console.log("â­ï¸ Lv2 balance ë³€ê²½ ë¬´ì‹œ (Lv2 ì „ìš© êµ¬ë…ì—ì„œ ì²˜ë¦¬)"),p):(console.log(`ğŸ’° Lv${g.level} ë³´ìœ ê¸ˆ ë³€ê²½ (partner_id: ${d}): ${o} â†’ ${h}`),p.map(v=>v.id===d?{...v,balance:h}:v)):p})}).subscribe(),t=c.channel("api_configs_balance_changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"api_configs"},async s=>{const d=s.new.partner_id,o=s.old.invest_balance||0,h=s.new.invest_balance||0,p=s.old.oroplay_balance||0,g=s.new.oroplay_balance||0;!(o!==h)&&!(p!==g)||(console.log(`ğŸ’° API ë³´ìœ ê¸ˆ ë³€ê²½ (partner_id: ${d}): I:${h} + O:${g}`),d===n.user?.id&&n.user?.level===1&&(be({invest:h,oroplay:g}),console.log("ğŸ’° Lv1 ê´€ë¦¬ì ë³¸ì¸ API ë³´ìœ ê¸ˆ ì—…ë°ì´íŠ¸:",{invest:h,oroplay:g})),K(f=>{const $=f.find(m=>m.id===d);return!$||$.level!==1?f:f.map(m=>m.id===d?{...m,invest_balance:h,oroplay_balance:g,balance:0}:m)}))}).subscribe(),l=c.channel("lv2_balance_changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"partners"},async s=>{const d=s.new.id,o=s.old.invest_balance||0,h=s.new.invest_balance||0,p=s.old.oroplay_balance||0,g=s.new.oroplay_balance||0,v=s.new.balance||0;!(o!==h)&&!(p!==g)||K($=>{const m=$.find(_=>_.id===d);return!m||m.level!==2?$:(console.log(`ğŸ’° Lv2 ë³´ìœ ê¸ˆ ë³€ê²½ (partner_id: ${d}): I:${h} + O:${g} = B:${v}`),$.map(_=>_.id===d?{..._,invest_balance:h,oroplay_balance:g,balance:v}:_))})}).subscribe();return()=>{c.removeChannel(a),c.removeChannel(t),c.removeChannel(l)}},[n.user?.id]);const O=async()=>{try{if(U(!0),console.log("ğŸ” [íŒŒíŠ¸ë„ˆ ì¡°íšŒ] authState.user:",{id:n.user?.id,username:n.user?.username,level:n.user?.level,partner_type:n.user?.partner_type}),!n.user?.id){console.error("âŒ [íŒŒíŠ¸ë„ˆ ì¡°íšŒ] ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤"),u.error(r.partnerManagement.fetchLoginInfoError),K([]),U(!1);return}let a=c.from("partners").select(`
          *,
          parent:parent_id (
            nickname
          )
        `).order("level",{ascending:!0}).order("created_at",{ascending:!1});const t=n.user.level===1;console.log(`ğŸ” [íŒŒíŠ¸ë„ˆ ì¡°íšŒ] ì‹œìŠ¤í…œ ê´€ë¦¬ì ì—¬ë¶€: ${t}`);const{data:l,error:s}=t?await a:await c.rpc("get_hierarchical_partners",{p_partner_id:n.user.id});if(console.log("ğŸ“Š [íŒŒíŠ¸ë„ˆ ì¡°íšŒ] ê²°ê³¼:",{ë°ì´í„°ê°œìˆ˜:l?.length||0,ì—ëŸ¬:s?.message||"null"}),s)throw console.error("[Partner List Fetch Error]:",s),u.error(r.partnerManagement.fetchPartnersError),s;const d=await Promise.all((l||[]).map(async o=>{const{count:h}=await c.from("partners").select("*",{count:"exact"}).eq("parent_id",o.id),{count:p}=await c.from("users").select("*",{count:"exact"}).eq("referrer_id",o.id);let g=0,v=0;if(o.level===1){const{data:j}=await c.from("api_configs").select("invest_balance, oroplay_balance").eq("partner_id",o.id).maybeSingle();j&&(g=j.invest_balance||0,v=j.oroplay_balance||0)}else o.level===2&&(g=o.invest_balance||0,v=o.oroplay_balance||0);return{...o,parent_nickname:o.parent?.nickname||"-",child_count:h||0,user_count:p||0,balance:o.balance||0,invest_balance:g,oroplay_balance:v}}));K(d)}catch(a){console.error("[Partner List Fetch Error]:",a),u.error(r.partnerManagement.fetchPartnersError)}finally{U(!1)}},ca=(a,t,l,s)=>{if(s==="head_office")return a!==100||t!==100||l!==100?(u.error(r.partnerManagement.commissionValidation),!1):!0;if(y){if(a>y.rolling)return u.error(r.partnerManagement.exceedParentRollingError.replace("{{rate}}",y.rolling.toString())),!1;if(t>y.losing)return u.error(r.partnerManagement.exceedParentLosingError.replace("{{rate}}",y.losing.toString())),!1;if(l>y.fee)return u.error(r.partnerManagement.exceedParentFeeError.replace("{{rate}}",y.fee.toString())),!1}return!0},Ba=async()=>{try{if(U(!0),!i.username.trim()){u.error(r.partnerManagement.enterUsernameError);return}if(!i.nickname.trim()){u.error(r.partnerManagement.enterNicknameError);return}if(!i.password.trim()){u.error(r.partnerManagement.enterPasswordError);return}if(!Ga(i.partner_type)){u.error(r.partnerManagement.noPermissionError);return}if(n.user?.level!==1){const f=await Me(i.partner_type);if(f.hasGap){u.error(f.message,{duration:5e3});return}if(!f.directParentId){u.error(r.partnerManagement.parentNotFoundDetailError.replace("{{partnerType}}",q[i.partner_type]));return}}let a=i.commission_rolling,t=i.commission_losing,l=i.withdrawal_fee;if(i.partner_type==="head_office"&&(a=100,t=100,l=100),!ca(a,t,l,i.partner_type))return;const s=Se(i.partner_type);let d=n.user?.id||null;if(n.user?.level!==1){const f=await Me(i.partner_type);f.directParentId&&(d=f.directParentId)}const{data:o,error:h}=await c.rpc("hash_password",{password:i.password});if(h){console.error("âŒ ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ì˜¤ë¥˜:",h),u.error(r.common.error);return}if(i.partner_type!=="head_office"){console.log("ğŸ” [í•˜ìœ„ íŒŒíŠ¸ë„ˆ ìƒì„±] api_configsì—ì„œ API ì„¤ì • ì¡°íšŒ ì‹œì‘");try{const{getAdminOpcode:f,isMultipleOpcode:$}=await Ie(async()=>{const{getAdminOpcode:Le,isMultipleOpcode:Ce}=await import("./index-McppjVnx.js").then(Ka=>Ka.aa);return{getAdminOpcode:Le,isMultipleOpcode:Ce}},__vite__mapDeps([0,1,2,3,4,5,6]));if(console.log("ğŸ” [OPCODE ì¡°íšŒ] authState.user:",{id:n.user?.id,username:n.user?.username,partner_type:n.user?.partner_type,level:n.user?.level,parent_id:n.user?.parent_id}),!n.user)throw new Error("ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");const m=await f(n.user);let _,N,D;if($(m)){if(m.opcodes.length===0){u.error(r.partnerManagement.noApiConfigError);return}_=m.opcodes[0].opcode,N=m.opcodes[0].secretKey,D=m.opcodes[0].token}else _=m.opcode,N=m.secretKey,D=m.token;console.log("âœ… api_configsì—ì„œ API ì„¤ì • ì¡°íšŒ ì„±ê³µ:",{opcode:_});const T=i.username.replace(/^btn_/,"");console.log("ğŸ“¡ [POST /api/account] Invest API ê³„ì • ìƒì„± í˜¸ì¶œ:",{opcode:_,username:T,partner_type:i.partner_type});const{createAccount:X}=await Ie(async()=>{const{createAccount:Le}=await import("./index-McppjVnx.js").then(Ce=>Ce.a9);return{createAccount:Le}},__vite__mapDeps([0,1,2,3,4,5,6])),se=await X(_,T,N);if(console.log("ğŸ“Š [POST /api/account] API ì‘ë‹µ:",se),se.error){console.error("âŒ Invest API ê³„ì • ìƒì„± ì‹¤íŒ¨:",se.error),u.error(r.partnerManagement.apiAccountCreationError.replace("{{error}}",se.error));return}console.log("âœ… Invest API ê³„ì • ìƒì„± ì„±ê³µ")}catch(f){console.error("âŒ API ì„¤ì • ì¡°íšŒ ì‹¤íŒ¨:",f),u.error(r.partnerManagement.apiConfigFetchFailedError.replace("{{error}}",f.message));return}}else console.log("ğŸ¢ [ëŒ€ë³¸ì‚¬ ìƒì„±] API ê³„ì • ìƒì„± ê±´ë„ˆëœ€ (ìˆ˜ë™ ì„¤ì • í•„ìš”)");const g={username:i.username,nickname:i.nickname,password_hash:o,partner_type:i.partner_type,level:s,parent_id:d,commission_rolling:a,commission_losing:t,withdrawal_fee:l,status:"active"};console.log("ğŸ“ íŒŒíŠ¸ë„ˆ ìƒì„± ë°ì´í„°:",{username:g.username,partner_type:g.partner_type,level:g.level,parent_id:g.parent_id,current_user:n.user?.username,current_user_level:n.user?.level});const{data:v,error:j}=await c.from("partners").insert([g]).select().single();if(j){console.error("âŒ íŒŒíŠ¸ë„ˆ ìƒì„± DB ì˜¤ë¥˜:",j),u.error(r.partnerManagement.createPartnerError);return}if(i.partner_type==="head_office"){const{error:f}=await c.from("api_configs").insert([{partner_id:v.id,invest_opcode:null,invest_secret_key:null,invest_token:null,invest_balance:0,oroplay_client_id:null,oroplay_client_secret:null,oroplay_token:null,oroplay_token_expires_at:null,oroplay_balance:0}]);f&&f.code!=="23505"?console.warn("âš ï¸ api_configs ìƒì„± ì‹¤íŒ¨ (íŠ¸ë¦¬ê±°ê°€ ì²˜ë¦¬í•  ìˆ˜ë„ ìˆìŒ):",f.message):console.log("âœ… api_configs ë¹ˆ ë ˆì½”ë“œ ìƒì„± ì™„ë£Œ")}console.log("âœ… íŒŒíŠ¸ë„ˆ ìƒì„± ì„±ê³µ:",{id:v.id,username:v.username,partner_type:v.partner_type,level:v.level,parent_id:v.parent_id}),u.success(r.partnerManagement.partnerCreatedSuccess),te(!1),da(),ee&&B&&B({type:"partner_created",data:{partner:v}}),O()}catch(a){console.error("íŒŒíŠ¸ë„ˆ ìƒì„± ì˜¤ë¥˜:",a),u.error(r.partnerManagement.createPartnerError)}finally{U(!1)}},qa=async()=>{if(L)try{if(U(!0),!ca(i.commission_rolling,i.commission_losing,i.withdrawal_fee,L.partner_type))return;const a={nickname:i.nickname,commission_rolling:i.commission_rolling,commission_losing:i.commission_losing,withdrawal_fee:i.withdrawal_fee,min_withdrawal_amount:i.min_withdrawal_amount,max_withdrawal_amount:i.max_withdrawal_amount,daily_withdrawal_limit:i.daily_withdrawal_limit,updated_at:new Date().toISOString()};i.password&&i.password.trim()!==""&&(a.password_hash=i.password);const{error:t}=await c.from("partners").update(a).eq("id",L.id);if(t)throw t;u.success(r.partnerManagement.partnerUpdatedSuccess),Y(!1),ae(null),ee&&B&&B({type:"partner_updated",data:{partnerId:L.id,updates:a}}),O()}catch(a){console.error("íŒŒíŠ¸ë„ˆ ìˆ˜ì • ì˜¤ë¥˜:",a),u.error(r.partnerManagement.updatePartnerError)}finally{U(!1)}},Ua=async()=>{if(C){if(de!==C.username){u.error(r.partnerManagement.deleteConfirmTextError);return}try{Ye(!0);const{count:a}=await c.from("partners").select("*",{count:"exact",head:!0}).eq("parent_id",C.id);if(a&&a>0){u.error(r.partnerManagement.hasChildPartnersError.replace("{{count}}",a.toString()));return}const{count:t}=await c.from("users").select("*",{count:"exact",head:!0}).eq("referrer_id",C.id);if(t&&t>0){u.error(r.partnerManagement.hasManagedUsersError.replace("{{count}}",t.toString()));return}const{error:l}=await c.from("partners").delete().eq("id",C.id);if(l)throw l;u.success(r.partnerManagement.partnerDeletedWithName.replace("{{nickname}}",C.nickname),{duration:3e3,icon:"ğŸ—‘ï¸"}),ee&&B&&B({type:"partner_deleted",data:{partnerId:C.id}}),J(!1),re(null),Q(""),O()}catch(a){console.error("íŒŒíŠ¸ë„ˆ ì‚­ì œ ì˜¤ë¥˜:",a),u.error(r.partnerManagement.deleteFailedError)}finally{Ye(!1)}}},Va=async a=>{if(n.user?.id)try{console.log("ğŸ’° [íŒŒíŠ¸ë„ˆ ê°•ì œ ì…ì¶œê¸ˆ] ì‹œì‘:",a);const{data:t,error:l}=await c.from("partners").select("*").eq("id",a.targetId).single();if(l||!t){u.error(r.partnerManagement.targetPartnerFetchError),console.error("âŒ ëŒ€ìƒ íŒŒíŠ¸ë„ˆ ì¡°íšŒ ì‹¤íŒ¨:",l);return}const{data:s,error:d}=await c.from("partners").select("balance, level, nickname, partner_type, invest_balance, oroplay_balance").eq("id",n.user.id).single();if(d||!s){u.error(r.partnerManagement.adminInfoFetchError),console.error("âŒ ê´€ë¦¬ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:",d);return}const o=s.level===1,h=t.partner_type==="head_office",p=o&&t.level===2,g=o&&t.level===3,v=s.level===2&&t.level===3;if(console.log("ğŸ“Š [íŒŒíŠ¸ë„ˆ ê°•ì œ ì…ì¶œê¸ˆ] ìƒí™©:",{isLv1ToLv2:p,adminLevel:s.level,targetLevel:t.level,apiType:a.apiType}),a.type==="withdrawal"){if(t.level===2){const m=(t.invest_balance||0)+(t.oroplay_balance||0);if(m<a.amount){u.error(r.partnerManagement.withdrawalExceedError.replace("{{balance}}",m.toLocaleString()));return}}else if(t.balance<a.amount){u.error(r.partnerManagement.withdrawalExceedError.replace("{{balance}}",t.balance.toLocaleString()));return}}if(a.type==="deposit"){if(p&&a.apiType){const{data:m,error:_}=await c.from("api_configs").select("invest_balance, oroplay_balance").eq("partner_id",n.user.id).single();if(_||!m){u.error(r.partnerManagement.apiConfigFetchError),console.error("âŒ API ì„¤ì • ì¡°íšŒ ì‹¤íŒ¨:",_);return}const N=a.apiType==="invest"?m.invest_balance||0:m.oroplay_balance||0;if(console.log(`ğŸ’³ Lv1 ${a.apiType.toUpperCase()} API ë³´ìœ ê¸ˆ:`,N),N<a.amount){const D=a.apiType==="invest"?"Invest":"OroPlay";u.error(r.partnerManagement.apiBalanceInsufficientError.replace("{{apiName}}",D).replace("{{balance}}",N.toLocaleString()));return}}else if(s.level===2){const m=Math.min(s.invest_balance||0,s.oroplay_balance||0);if(a.amount>m){const _=(s.invest_balance||0)<(s.oroplay_balance||0)?"Invest":"OroPlay";u.error(r.partnerManagement.apiBalanceInsufficientError.replace("{{apiName}}",_).replace("{{balance}}",m.toLocaleString()));return}}else if(!p&&s.balance<a.amount){u.error(r.partnerManagement.balanceInsufficientError.replace("{{balance}}",s.balance.toLocaleString()));return}}if(p&&a.type==="deposit"&&a.apiType){console.log("âœ… [Lv1â†’Lv2 ì…ê¸ˆ] Lv1 ì™¸ë¶€ ì§€ê°‘ì€ ë³€ê²½í•˜ì§€ ì•Šê³  Lv2ì—ê²Œë§Œ í• ë‹¹"),console.log("ğŸ” [ì…ê¸ˆ ëŒ€ìƒ í™•ì¸]",{"Lv1 ID (authState.user.id)":n.user.id,"Lv1 ë‹‰ë„¤ì„":s.nickname,"Lv2 ID (data.targetId)":a.targetId,"Lv2 ë‹‰ë„¤ì„":t.nickname,"Lv2 ë ˆë²¨":t.level});const m=a.apiType==="invest"?"invest_balance":"oroplay_balance",_=t[m]||0,N=_+a.amount;console.log(`ğŸ” Lv2 partners.${m} ì¦ê°€ ì˜ˆì • (partner_id: ${a.targetId}):`,{before:_,after:N,amount:a.amount});const{error:D}=await c.from("partners").update({[m]:N,updated_at:new Date().toISOString()}).eq("id",a.targetId);if(D){u.error(r.partnerManagement.lv2BalanceUpdateError),console.error("âŒ Lv2 partners ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:",D);return}console.log(`âœ… Lv2 partners.${m} ì¦ê°€:`,{before:_,after:N,amount:a.amount});const T=a.apiType==="invest"?"Invest":"OroPlay";await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:_,balance_after:N,amount:a.amount,transaction_type:"deposit",from_partner_id:n.user.id,to_partner_id:a.targetId,processed_by:n.user.id,api_type:a.apiType,memo:`[${T} API í• ë‹¹] ${s.nickname}ìœ¼ë¡œë¶€í„° ${a.amount.toLocaleString()}ì› í• ë‹¹${a.memo?`: ${a.memo}`:""}`}),u.success(r.partnerManagement.apiAllocationSuccess.replace("{{nickname}}",t.nickname).replace("{{apiName}}",T).replace("{{amount}}",a.amount.toLocaleString())),O();return}if(p&&a.type==="withdrawal"&&a.apiType){console.log("âœ… [Lv1â†’Lv2 ì¶œê¸ˆ] Lv1 ì™¸ë¶€ ì§€ê°‘ì€ ë³€ê²½í•˜ì§€ ì•Šê³  Lv2ì—ì„œë§Œ íšŒìˆ˜");const m=a.apiType==="invest"?"invest_balance":"oroplay_balance",_=t[m]||0,N=_-a.amount;console.log(`ğŸ” Lv2 partners.${m} ì°¨ê° ì˜ˆì • (partner_id: ${a.targetId}):`,{before:_,after:N,amount:-a.amount});const{error:D}=await c.from("partners").update({[m]:N,updated_at:new Date().toISOString()}).eq("id",a.targetId);if(D){u.error(r.partnerManagement.lv2WithdrawalDeductError),console.error("âŒ Lv2 partners ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:",D);return}console.log(`âœ… Lv2 partners.${m} ì°¨ê°:`,{before:_,after:N,amount:-a.amount});const T=a.apiType==="invest"?"Invest":"OroPlay";await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:_,balance_after:N,amount:-a.amount,transaction_type:"withdrawal",from_partner_id:a.targetId,to_partner_id:n.user.id,processed_by:n.user.id,api_type:a.apiType,memo:`[${T} API íšŒìˆ˜] ${s.nickname}ì´(ê°€) ${a.amount.toLocaleString()}ì› íšŒìˆ˜${a.memo?`: ${a.memo}`:""}`}),u.success(r.partnerManagement.apiRecoveryCompletedFromPartner.replace("{{nickname}}",t.nickname).replace("{{apiName}}",T).replace("{{amount}}",a.amount.toLocaleString())),O();return}console.log("âœ… [íŒŒíŠ¸ë„ˆ ê°•ì œ ì…ì¶œê¸ˆ] ì™¸ë¶€ API í˜¸ì¶œ ê±´ë„ˆëœ€ - ë‚´ë¶€ DBë§Œ ì²˜ë¦¬");let j=s.balance,f=t.balance;if(a.type==="deposit"){if((g||v)&&t.level===3){console.log("âœ… [Lv1/Lv2â†’Lv3 ì…ê¸ˆ] Lv2 ë³€ë™ ì—†ìŒ, Lv3 balanceë§Œ ì¦ê°€");const m=t.balance,_=m+a.amount;await c.from("partners").update({balance:_,updated_at:new Date().toISOString()}).eq("id",a.targetId),await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:m,balance_after:_,amount:a.amount,transaction_type:"deposit",from_partner_id:n.user.id,to_partner_id:a.targetId,processed_by:n.user.id,memo:`[Lv3 ìˆ˜ì‹ ] ${s.nickname}ìœ¼ë¡œë¶€í„° ${a.amount.toLocaleString()}ì› ì…ê¸ˆ${a.memo?`: ${a.memo}`:""}`}),u.success(r.partnerManagement.depositCompleted.replace("{{nickname}}",t.nickname).replace("{{amount}}",a.amount.toLocaleString())),O();return}if(s.level===2&&t.level>=4&&a.apiType){const m=a.apiType==="invest"?"invest_balance":"oroplay_balance",{data:_,error:N}=await c.from("partners").select("invest_balance, oroplay_balance").eq("id",n.user.id).single();if(N||!_){u.error(r.partnerManagement.lv2BalanceFetchFailed);return}const T=(_[m]||0)-a.amount;await c.from("partners").update({[m]:T,updated_at:new Date().toISOString()}).eq("id",n.user.id),f=t.balance+a.amount,await c.from("partners").update({balance:f,updated_at:new Date().toISOString()}).eq("id",a.targetId);const X=a.apiType==="invest"?"Invest":"OroPlay";await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:t.balance,balance_after:f,amount:a.amount,transaction_type:"deposit",from_partner_id:n.user.id,to_partner_id:a.targetId,processed_by:n.user.id,memo:`[${X} ìˆ˜ì‹ ] ${s.nickname}ìœ¼ë¡œë¶€í„° ${a.amount.toLocaleString()}ì› ì…ê¸ˆ${a.memo?`: ${a.memo}`:""}`})}else j=s.balance-a.amount,await c.from("partners").update({balance:j,updated_at:new Date().toISOString()}).eq("id",n.user.id),f=t.balance+a.amount,await c.from("partners").update({balance:f,updated_at:new Date().toISOString()}).eq("id",a.targetId),await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:t.balance,balance_after:f,amount:a.amount,transaction_type:"deposit",from_partner_id:n.user.id,to_partner_id:a.targetId,processed_by:n.user.id,memo:`[ê°•ì œì…ê¸ˆ] ${s.nickname}ìœ¼ë¡œë¶€í„° ${a.amount.toLocaleString()}ì› ì…ê¸ˆ${a.memo?`: ${a.memo}`:""}`})}else{if((g||v)&&t.level===3){console.log("âœ… [Lv1/Lv2â†’Lv3 íšŒìˆ˜] Lv2 ë³€ë™ ì—†ìŒ, Lv3 balanceë§Œ ì°¨ê°");const m=t.balance,_=m-a.amount;await c.from("partners").update({balance:_,updated_at:new Date().toISOString()}).eq("id",a.targetId),await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:m,balance_after:_,amount:-a.amount,transaction_type:"withdrawal",from_partner_id:a.targetId,to_partner_id:n.user.id,processed_by:n.user.id,memo:`[Lv3 íšŒìˆ˜] ${s.nickname}ì—ê²Œ ${a.amount.toLocaleString()}ì› ì¶œê¸ˆ${a.memo?`: ${a.memo}`:""}`}),u.success(r.partnerManagement.withdrawalCompleted.replace("{{nickname}}",t.nickname).replace("{{amount}}",a.amount.toLocaleString())),O();return}if(s.level===2&&t.level>=4&&a.apiType){const m=a.apiType==="invest"?"invest_balance":"oroplay_balance",{data:_,error:N}=await c.from("partners").select("invest_balance, oroplay_balance").eq("id",n.user.id).single();if(N||!_)return;const T=(_[m]||0)+a.amount;f=t.balance-a.amount,await c.from("partners").update({balance:f,updated_at:new Date().toISOString()}).eq("id",a.targetId),await c.from("partners").update({[m]:T,updated_at:new Date().toISOString()}).eq("id",n.user.id);const X=a.apiType==="invest"?"Invest":"OroPlay";await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:t.balance,balance_after:f,amount:-a.amount,transaction_type:"withdrawal",from_partner_id:a.targetId,to_partner_id:n.user.id,processed_by:n.user.id,memo:`[${X} ì¶œê¸ˆ] ${s.nickname}ì—ê²Œ ${a.amount.toLocaleString()}ì› ì¶œê¸ˆ${a.memo?`: ${a.memo}`:""}`})}else f=t.balance-a.amount,await c.from("partners").update({balance:f,updated_at:new Date().toISOString()}).eq("id",a.targetId),j=s.balance+a.amount,await c.from("partners").update({balance:j,updated_at:new Date().toISOString()}).eq("id",n.user.id),await c.from("partner_balance_logs").insert({partner_id:a.targetId,balance_before:t.balance,balance_after:f,amount:-a.amount,transaction_type:"withdrawal",from_partner_id:a.targetId,to_partner_id:n.user.id,processed_by:n.user.id,memo:`[ê°•ì œì¶œê¸ˆ] ${s.nickname}ì—ê²Œ ${a.amount.toLocaleString()}ì› ì¶œê¸ˆ${a.memo?`: ${a.memo}`:""}`})}ee&&B&&B({type:"partner_balance_updated",data:{partnerId:a.targetId,amount:a.amount,type:a.type}});const $=a.type==="deposit"?r.partnerManagement.depositTypeLabel:r.partnerManagement.withdrawalTypeLabel;u.success(r.partnerManagement.forceTransactionSuccess.replace("{{type}}",$).replace("{{amount}}",a.amount.toLocaleString())),O()}catch(t){console.error("âŒ [íŒŒíŠ¸ë„ˆ ê°•ì œ ì…ì¶œê¸ˆ] ì˜¤ë¥˜:",t)}},Ne=async()=>{try{if(!n.user)return;const a=new Date().toISOString().split("T")[0],{data:t}=await c.from("transactions").select("transaction_type, amount").eq("partner_id",n.user.id).gte("created_at",a),l=new Date,s=new Date(l.getFullYear(),l.getMonth(),1),d=new Date(l.getFullYear(),l.getMonth()+1,0,23,59,59),{calculateIntegratedSettlement:o}=await Ie(async()=>{const{calculateIntegratedSettlement:p}=await import("./settlementCalculator-U6Ra3Zw5.js");return{calculateIntegratedSettlement:p}},__vite__mapDeps([7,0,1,2,3,4,5,6])),h=await o(n.user.id,{rolling:n.user.commission_rolling||0,losing:n.user.commission_losing||0,withdrawal:n.user.withdrawal_fee||0},s.toISOString(),d.toISOString());Ca({todayDeposits:t?.filter(p=>p.transaction_type==="deposit").reduce((p,g)=>p+Number(g.amount),0)||0,todayWithdrawals:t?.filter(p=>p.transaction_type==="withdrawal").reduce((p,g)=>p+Number(g.amount),0)||0,monthlyCommission:Math.round(h.netTotalProfit)}),await Ha()}catch(a){console.error("[Dashboard Data Fetch Error]:",a)}},Ha=async()=>{try{if(!n.user)return;const a=k.map(o=>o.id);if((n.user.level===1?a:[n.user.id,...a]).length===0){Je([]);return}const l=new Map;(n.user.level===1?k:[n.user,...k]).forEach(o=>{const h=o.partner_type;l.has(h)||l.set(h,{level:o.level,type:o.partner_type,typeName:q[o.partner_type],partnerIds:[]}),l.get(h).partnerIds.push(o.id)});const d=await Promise.all(Array.from(l.values()).map(async o=>{const{data:h}=await c.from("users").select("balance").in("referrer_id",o.partnerIds),p=h?.reduce((g,v)=>g+(v.balance||0),0)||0;return{level:o.level,type:o.type,typeName:o.typeName,partnerCount:o.partnerIds.length,usersBalance:p}}));d.sort((o,h)=>o.level-h.level),Je(d)}catch(a){console.error("ë ˆë²¨ë³„ ë¶„í¬ ì¡°íšŒ ì˜¤ë¥˜:",a)}},Me=async a=>{if(!n.user)return{hasGap:!0,missingLevels:[],directParentId:null,message:"ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."};const t=n.user.level,l=Se(a);if(t===1)return{hasGap:!1,missingLevels:[],directParentId:n.user.id,message:""};if(l===t+1)return{hasGap:!1,missingLevels:[],directParentId:n.user.id,message:""};const s=[];let d=null;for(let p=t+1;p<l;p++){const{data:g,error:v}=await c.from("partners").select("id, level, partner_type, nickname").eq("level",p).eq("status","active");if(v){console.error(`ë ˆë²¨ ${p} íŒŒíŠ¸ë„ˆ ì¡°íšŒ ì˜¤ë¥˜:`,v);continue}const{data:j,error:f}=await c.rpc("get_hierarchical_partners",{p_partner_id:n.user.id});if(f){console.error("ê³„ì¸µ íŒŒíŠ¸ë„ˆ ì¡°íšŒ ì˜¤ë¥˜:",f),s.push(p);continue}(j||[]).filter(m=>m.level===p&&m.status==="active").length===0&&s.push(p)}if(s.length===0){const p=l-1,{data:g}=await c.rpc("get_hierarchical_partners",{p_partner_id:n.user.id}),v=(g||[]).filter(j=>j.level===p&&j.status==="active");v.length>0&&(d=v.sort((j,f)=>new Date(f.created_at).getTime()-new Date(j.created_at).getTime())[0].id)}const o={2:"ëŒ€ë³¸ì‚¬",3:"ë³¸ì‚¬",4:"ë¶€ë³¸ì‚¬",5:"ì´íŒ",6:"ë§¤ì¥"};let h="";if(s.length>0){const p=s.map(g=>o[g]||`Level ${g}`).join(", ");h=`âš ï¸ ${q[a]}ì„(ë¥¼) ìƒì„±í•˜ë ¤ë©´ ë¨¼ì € ì¤‘ê°„ ê³„ì¸µ(${p})ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.`}return{hasGap:s.length>0,missingLevels:s,directParentId:d,message:h}},Ga=a=>{if(!n.user)return!1;const t=n.user.level,l=Se(a);return t===1?!0:t===2?l>2:l>t},Se=a=>({system_admin:1,head_office:2,main_office:3,sub_office:4,distributor:5,store:6})[a],da=()=>{b({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:"",opcode:"",secret_key:"",api_token:"",commission_rolling:fe.rolling,commission_losing:fe.losing,withdrawal_fee:fe.fee})},ma=a=>{b({username:a.username,nickname:a.nickname,password:"",partner_type:a.partner_type,parent_id:a.parent_id||"",opcode:a.opcode||"",secret_key:a.secret_key||"",api_token:a.api_token||"",commission_rolling:a.commission_rolling,commission_losing:a.commission_losing,withdrawal_fee:a.withdrawal_fee})},Ra=a=>{const t=new Map,l=[];return a.forEach(s=>{t.set(s.id,{...s,children:[]})}),a.forEach(s=>{const d=t.get(s.id);if(d)if(s.parent_id&&t.has(s.parent_id)){const o=t.get(s.parent_id);o&&o.children&&o.children.push(d)}else l.push(d)}),l},pa=a=>{he(t=>{const l=new Set(t);return l.has(a)?l.delete(a):l.add(a),l})},za=()=>{if(Qe)he(new Set),Xe(!1);else{const a=new Set,t=l=>{l.forEach(s=>{s.children&&s.children.length>0&&(a.add(s.id),t(s.children))})};t(ke),he(a),Xe(!0)}},Wa=k.filter(a=>{const t=a.username.toLowerCase().includes(ie.toLowerCase())||a.nickname.toLowerCase().includes(ie.toLowerCase()),l=oe==="all"||a.partner_type===oe,s=ce==="all"||a.status===ce;return t&&l&&s}),ke=Ra(Wa),ua=(a,t)=>{const l=ge.has(a.id),s=a.children&&a.children.length>0,d=t*24;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 p-2.5 rounded-lg hover:bg-slate-800/50 transition-colors border border-slate-700/30 bg-slate-800/20 min-w-[1200px]",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-[130px] flex-shrink-0",style:{paddingLeft:`${d}px`},children:[e.jsx("button",{onClick:()=>s&&pa(a.id),className:`flex items-center justify-center w-5 h-5 rounded transition-colors flex-shrink-0 ${s?"hover:bg-slate-700 text-slate-300 cursor-pointer":"invisible"}`,children:s&&(l?e.jsx(Ge,{className:"h-3 w-3"}):e.jsx(Re,{className:"h-3 w-3"}))}),e.jsx("span",{className:"font-medium text-white text-sm truncate",children:a.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("div",{className:"min-w-[90px] flex-shrink-0",children:e.jsx("span",{className:"text-slate-300 text-sm truncate",children:a.nickname})}),e.jsx("div",{className:"min-w-[85px] flex-shrink-0",children:e.jsx(I,{className:`${W[a.partner_type]} text-white text-xs`,children:q[a.partner_type]})}),e.jsx("div",{className:"min-w-[60px] flex-shrink-0",children:e.jsx(I,{className:`${va[a.status]} text-white text-xs`,children:Ke[a.status]})}),e.jsxs("div",{className:"min-w-[110px] text-right flex-shrink-0",children:[e.jsxs("span",{className:"font-mono text-green-400 text-sm",children:[a.level===1||a.level===2?((a.invest_balance||0)+(a.oroplay_balance||0)).toLocaleString():a.balance.toLocaleString(),"ì›"]}),(a.level===1||a.level===2)&&e.jsxs("div",{className:"text-[10px] text-slate-400 mt-0.5",children:["(I:",(a.invest_balance||0).toLocaleString()," + O:",(a.oroplay_balance||0).toLocaleString(),")"]})]}),e.jsx("div",{className:"min-w-[170px] flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[e.jsxs(I,{variant:"outline",className:"bg-green-500/10 text-green-400 border-green-500/30 text-xs px-1",children:["R:",a.commission_rolling,"%"]}),e.jsxs(I,{variant:"outline",className:"bg-orange-500/10 text-orange-400 border-orange-500/30 text-xs px-1",children:["L:",a.commission_losing,"%"]}),e.jsxs(I,{variant:"outline",className:"bg-blue-500/10 text-blue-400 border-blue-500/30 text-xs px-1",children:["F:",a.withdrawal_fee,"%"]})]})}),e.jsxs("div",{className:"flex items-center gap-1.5 min-w-[110px] flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(A,{className:"h-3 w-3 text-slate-400"}),e.jsx("span",{className:"text-xs text-slate-400",children:a.child_count||0})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(He,{className:"h-3 w-3 text-slate-400"}),e.jsx("span",{className:"text-xs text-slate-400",children:a.user_count||0})]})]}),e.jsx("div",{className:"min-w-[120px] flex-shrink-0",children:a.last_login_at?(()=>{const o=new Date(a.last_login_at),h=o.getFullYear(),p=String(o.getMonth()+1).padStart(2,"0"),g=String(o.getDate()).padStart(2,"0"),v=String(o.getHours()).padStart(2,"0"),j=String(o.getMinutes()).padStart(2,"0");return e.jsx("span",{className:"text-xs text-slate-400",children:`${h}/${p}/${g} ${v}:${j}`})})():e.jsx("span",{className:"text-xs text-slate-600",children:"-"})})]}),e.jsxs("div",{className:"flex items-center gap-1.5 w-[240px] flex-shrink-0",children:[(n.user?.level===1&&a.partner_type==="head_office"||a.parent_id===n.user?.id&&a.partner_type!=="head_office")&&e.jsxs(e.Fragment,{children:[e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{ea(a),ve("deposit"),_e(!0)},className:"bg-green-500/10 border-green-500/50 text-green-400 hover:bg-green-500/20 flex-shrink-0",title:n.user?.level===1&&a.partner_type==="head_office"?"ì…ê¸ˆ":"ë³´ìœ ê¸ˆ ì§€ê¸‰",children:e.jsx(le,{className:"h-4 w-4"})}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{ea(a),ve("withdrawal"),_e(!0)},className:"bg-orange-500/10 border-orange-500/50 text-orange-400 hover:bg-orange-500/20 flex-shrink-0",title:n.user?.level===1&&a.partner_type==="head_office"?"ì¶œê¸ˆ":"ë³´ìœ ê¸ˆ íšŒìˆ˜",children:e.jsx(xa,{className:"h-4 w-4"})})]}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{ae(a),ma(a),Y(!0)},className:"bg-blue-500/10 border-blue-500/50 text-blue-400 hover:bg-blue-500/20 flex-shrink-0",children:e.jsx(fa,{className:"h-3 w-3"})}),e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{u.info(`${a.nickname} íŒŒíŠ¸ë„ˆì˜ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.`)},className:"bg-slate-700/50 border-slate-600 text-slate-300 hover:bg-slate-700 flex-shrink-0",children:e.jsx(ze,{className:"h-3 w-3"})}),a.partner_type!=="system_admin"&&e.jsx(M,{variant:"outline",size:"sm",onClick:()=>{re(a),Q(""),J(!0)},className:"bg-red-500/10 border-red-500/50 text-red-400 hover:bg-red-500/20 flex-shrink-0",children:e.jsx(We,{className:"h-3 w-3"})})]})]}),l&&s&&e.jsx("div",{className:"mt-1 space-y-1",children:a.children.map(o=>ua(o,t+1))})]},a.id)};return r.partnerManagement.partnerUsername,r.partnerManagement.partnerNickname,r.partnerManagement.partnerGrade,r.partnerManagement.parentPartner,r.partnerManagement.status,r.partnerManagement.balance,x.useEffect(()=>{oa(),ia(),O(),Ne()},[]),x.useEffect(()=>{ue==="dashboard"&&Ne()},[ue]),z&&k.length===0?e.jsx(ga,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:r.partnerManagement.title}),e.jsx("p",{className:"text-sm text-slate-400",children:n.user?.nickname})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{onClick:za,variant:"outline",className:"border-blue-500/30 bg-blue-500/10 text-blue-300 hover:bg-blue-500/20 hover:border-blue-400/50",children:Qe?e.jsxs(e.Fragment,{children:[e.jsx(Ge,{className:"h-4 w-4 mr-2"}),r.partnerManagement.collapseView]}):e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:"h-4 w-4 mr-2"}),r.partnerManagement.expandView]})}),e.jsxs(M,{onClick:()=>Sa(!pe),variant:"outline",className:"border-slate-700 text-slate-300 hover:bg-slate-700/50",children:[e.jsx(A,{className:"h-4 w-4 mr-2"}),pe?r.partnerManagement.listViewToggle:r.partnerManagement.hierarchyViewToggle]}),e.jsxs(M,{variant:"outline",className:"border-slate-700 text-slate-300 hover:bg-slate-700/50",children:[e.jsx(rt,{className:"h-4 w-4 mr-2"}),r.partnerManagement.export]}),e.jsxs(M,{onClick:()=>te(!0),children:[e.jsx(nt,{className:"h-4 w-4 mr-2"}),r.partnerManagement.createPartner]})]})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-4",children:[e.jsx(F,{title:r.partnerManagement.allSubPartners,value:k.filter(a=>a.id!==n.user?.id).length.toLocaleString(),subtitle:r.partnerManagement.managingPartners,icon:A,color:"purple"}),n.user?.level===2&&e.jsx(F,{title:r.partnerManagement.mainOffice,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="main_office").length.toLocaleString(),subtitle:`${r.partnerManagement.mainOffice} ${r.partnerManagement.partnerLabel}`,icon:Z,color:"red"}),n.user?.level===3&&e.jsx(F,{title:r.partnerManagement.subOffice,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="sub_office").length.toLocaleString(),subtitle:`${r.partnerManagement.subOffice} ${r.partnerManagement.partnerLabel}`,icon:Z,color:"red"}),n.user?.level===4&&e.jsx(F,{title:r.partnerManagement.distributor,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="distributor").length.toLocaleString(),subtitle:`${r.partnerManagement.distributor} ${r.partnerManagement.partnerLabel}`,icon:Z,color:"red"}),n.user?.level===2&&e.jsx(F,{title:r.partnerManagement.subOfficeDistributorStore,value:k.filter(a=>a.id!==n.user?.id&&(a.partner_type==="sub_office"||a.partner_type==="distributor"||a.partner_type==="store")).length.toLocaleString(),subtitle:r.partnerManagement.subPartnerLabel,icon:A,color:"orange"}),n.user?.level===3&&e.jsx(F,{title:r.partnerManagement.distributorStore,value:k.filter(a=>a.id!==n.user?.id&&(a.partner_type==="distributor"||a.partner_type==="store")).length.toLocaleString(),subtitle:r.partnerManagement.subPartnerLabel,icon:A,color:"orange"}),n.user?.level===4&&e.jsx(F,{title:r.partnerManagement.storePartner,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="store").length.toLocaleString(),subtitle:r.partnerManagement.storePartnerLabel,icon:A,color:"orange"}),n.user?.level===5&&e.jsxs(e.Fragment,{children:[e.jsx(F,{title:r.partnerManagement.storePartner,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="store").length.toLocaleString(),subtitle:r.partnerManagement.storePartnerLabel,icon:Z,color:"red"}),e.jsx(F,{title:r.partnerManagement.emptyLabel,value:"0",subtitle:r.partnerManagement.noSubPartnerLabel,icon:A,color:"orange"})]}),(n.user?.level===1||n.user?.level===6)&&e.jsxs(e.Fragment,{children:[e.jsx(F,{title:r.partnerManagement.headOfficePartner,value:k.filter(a=>a.id!==n.user?.id&&a.partner_type==="head_office").length.toLocaleString(),subtitle:r.partnerManagement.headOfficePartnerLabel,icon:Z,color:"red"}),e.jsx(F,{title:r.partnerManagement.mainSubOffice,value:k.filter(a=>a.id!==n.user?.id&&(a.partner_type==="main_office"||a.partner_type==="sub_office")).length.toLocaleString(),subtitle:r.partnerManagement.middlePartner,icon:A,color:"orange"})]}),e.jsx(F,{title:r.partnerManagement.activePartners,value:k.filter(a=>a.id!==n.user?.id&&a.status==="active").length.toLocaleString(),subtitle:r.partnerManagement.normalOperation,icon:ze,color:"green"})]}),e.jsxs(Xa,{value:ue,onValueChange:ka,className:"space-y-6",children:[e.jsx("div",{className:"bg-slate-800/30 rounded-xl p-1.5 border border-slate-700/40",children:e.jsxs(Za,{className:"bg-transparent h-auto p-0 border-0 gap-2 w-full grid grid-cols-2",children:[e.jsx(ha,{value:"hierarchy",className:"bg-transparent text-slate-400 rounded-lg px-6 py-3 data-[state=active]:bg-gradient-to-br data-[state=active]:from-blue-500/20 data-[state=active]:to-cyan-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-blue-500/20 data-[state=active]:border data-[state=active]:border-blue-400/30 transition-all duration-200",children:r.partnerManagement.partnerHierarchyManagement}),e.jsx(ha,{value:"dashboard",className:"bg-transparent text-slate-400 rounded-lg px-6 py-3 data-[state=active]:bg-gradient-to-br data-[state=active]:from-purple-500/20 data-[state=active]:to-pink-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-purple-500/20 data-[state=active]:border data-[state=active]:border-purple-400/30 transition-all duration-200",children:r.partnerManagement.partnerDashboard})]})}),e.jsx(Pe,{value:"hierarchy",className:"space-y-4",children:e.jsxs(V,{className:"bg-slate-900/40 border-slate-700/50 backdrop-blur",children:[e.jsxs(H,{children:[e.jsx(G,{className:"text-white",children:r.partnerManagement.hierarchyManagementTitle}),e.jsx(De,{className:"text-slate-400",children:r.partnerManagement.hierarchyManagementDesc})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(st,{className:"absolute left-2 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(S,{placeholder:r.partnerManagement.searchIdOrNickname,className:"pl-8 bg-slate-800/50 border-slate-700 text-white",value:ie,onChange:a=>ba(a.target.value)})]})}),e.jsxs(Te,{value:oe,onValueChange:ya,children:[e.jsx(Fe,{className:"w-[180px] bg-slate-800/50 border-slate-700 text-white",children:e.jsx(Ee,{placeholder:r.partnerManagement.partnerGradeFilter})}),e.jsxs($e,{children:[e.jsx(P,{value:"all",children:r.partnerManagement.allGrades}),e.jsx(P,{value:"head_office",children:r.partnerManagement.headOffice}),e.jsx(P,{value:"main_office",children:r.partnerManagement.mainOffice}),e.jsx(P,{value:"sub_office",children:r.partnerManagement.subOffice}),e.jsx(P,{value:"distributor",children:r.partnerManagement.distributor}),e.jsx(P,{value:"store",children:r.partnerManagement.store})]})]}),e.jsxs(Te,{value:ce,onValueChange:ja,children:[e.jsx(Fe,{className:"w-[180px] bg-slate-800/50 border-slate-700 text-white",children:e.jsx(Ee,{placeholder:r.partnerManagement.statusFilter})}),e.jsxs($e,{children:[e.jsx(P,{value:"all",children:r.partnerManagement.allStatus}),e.jsx(P,{value:"active",children:r.partnerManagement.active}),e.jsx(P,{value:"inactive",children:r.partnerManagement.inactive}),e.jsx(P,{value:"blocked",children:r.partnerManagement.blocked})]})]})]}),e.jsx("div",{className:"mb-3 px-3 py-2 bg-slate-800/50 rounded-lg border border-slate-700/30",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"min-w-[130px] flex-shrink-0",children:e.jsx("div",{className:"text-xs font-medium text-slate-400",children:r.partnerManagement.id})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("div",{className:"min-w-[90px] text-xs font-medium text-slate-400",children:r.partnerManagement.nickname}),e.jsx("div",{className:"min-w-[85px] text-xs font-medium text-slate-400",children:r.partnerManagement.gradeLabel}),e.jsx("div",{className:"min-w-[60px] text-xs font-medium text-slate-400",children:r.partnerManagement.statusLabel}),e.jsx("div",{className:"min-w-[110px] text-xs font-medium text-slate-400 text-right",children:r.partnerManagement.balanceLabel}),e.jsx("div",{className:"min-w-[170px] text-xs font-medium text-slate-400",children:r.partnerManagement.commissionLabel}),e.jsx("div",{className:"min-w-[110px] text-xs font-medium text-slate-400",children:r.partnerManagement.subMembers}),e.jsx("div",{className:"min-w-[120px] text-xs font-medium text-slate-400",children:r.partnerManagement.recentAccess})]}),e.jsx("div",{className:"w-[240px] text-xs font-medium text-slate-400 text-center flex-shrink-0",children:r.partnerManagement.management})]})}),z?e.jsx(ga,{}):ke.length===0?e.jsx("div",{className:"text-center py-12 text-slate-400",children:r.partnerManagement.noPartners}):e.jsx("div",{className:"space-y-1 overflow-x-auto",children:ke.map(a=>ua(a,0))})]})]})}),e.jsx(Pe,{value:"transactions",className:"space-y-4",children:e.jsx(et,{})}),e.jsx(Pe,{value:"dashboard",className:"space-y-4",children:e.jsxs(V,{className:"bg-slate-900/40 border-slate-700/50 backdrop-blur",children:[e.jsxs(H,{children:[e.jsxs(G,{className:"flex items-center gap-2 text-white",children:[e.jsx(lt,{className:"h-5 w-5"}),"íŒŒíŠ¸ë„ˆ ëŒ€ì‹œë³´ë“œ"]}),e.jsx(De,{className:"text-slate-400",children:"íŒŒíŠ¸ë„ˆë³„ ì„±ê³¼ ë° ìˆ˜ìµ í˜„í™©ì„ í™•ì¸í•©ë‹ˆë‹¤."})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3 mb-6",children:[e.jsxs(V,{children:[e.jsxs(H,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(G,{className:"text-sm font-medium",children:"ì´ë²ˆë‹¬ ìˆœìˆ˜ìµ"}),e.jsx(le,{className:"h-4 w-4 text-green-500"})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[(La.monthlyCommission||0).toLocaleString(),"ì›"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"ë‚´ ìˆ˜ì… - í•˜ìœ„ íŒŒíŠ¸ë„ˆ ì§€ê¸‰"})]})]}),e.jsxs(V,{children:[e.jsxs(H,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(G,{className:"text-sm font-medium",children:"ì´ íŒŒíŠ¸ë„ˆ ìˆ˜"}),e.jsx(A,{className:"h-4 w-4 text-blue-500"})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[k.length.toLocaleString(),"ê°œ"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"+2 new this month"})]})]}),e.jsxs(V,{children:[e.jsxs(H,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(G,{className:"text-sm font-medium",children:"í™œì„± íšŒì› ìˆ˜"}),e.jsx(He,{className:"h-4 w-4 text-purple-500"})]}),e.jsxs(R,{children:[e.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[k.reduce((a,t)=>a+(t.user_count||0),0).toLocaleString(),"ëª…"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"+5% from last month"})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(V,{children:[e.jsx(H,{children:e.jsx(G,{className:"text-lg",children:"ìƒìœ„ ì„±ê³¼ íŒŒíŠ¸ë„ˆ"})}),e.jsx(R,{children:e.jsx("div",{className:"space-y-3",children:k.filter(a=>a.partner_type!=="system_admin").sort((a,t)=>(t.user_count||0)-(a.user_count||0)).slice(0,5).map((a,t)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(I,{className:`${W[a.partner_type]} text-white`,children:["#",t+1]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.nickname}),e.jsx("p",{className:"text-sm text-muted-foreground",children:q[a.partner_type]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-medium",children:[a.user_count||0,"ëª…"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"ê´€ë¦¬ íšŒì›"})]})]},a.id))})})]}),e.jsxs(V,{children:[e.jsxs(H,{children:[e.jsx(G,{className:"text-lg",children:"íŒŒíŠ¸ë„ˆ ë ˆë²¨ë³„ ë¶„í¬"}),e.jsx(De,{className:"text-xs",children:"ê° ë ˆë²¨ íŒŒíŠ¸ë„ˆë“¤ì´ ë³´ìœ í•œ ì‚¬ìš©ìë“¤ì˜ ì´ ë³´ìœ ê¸ˆ"})]}),e.jsx(R,{children:e.jsx("div",{className:"space-y-4",children:ne.length>0?e.jsxs(e.Fragment,{children:[ne.map(a=>{const t=Math.max(...ne.map(s=>s.usersBalance),1),l=Math.round(a.usersBalance/t*100);return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(I,{className:`${W[a.type]} text-white text-xs`,children:["LV.",a.level]}),e.jsx("span",{className:"text-sm font-medium",children:a.typeName}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",a.partnerCount,"ê°œ)"]})]}),e.jsxs("span",{className:"text-sm font-medium text-blue-600",children:["â‚©",a.usersBalance.toLocaleString()]})]}),e.jsx("div",{className:"w-full bg-slate-800/40 rounded-full h-3 overflow-hidden",children:e.jsx("div",{className:`h-3 rounded-full transition-all duration-500 ${W[a.type]}`,style:{width:`${Math.max(l,2)}%`}})})]},a.type)}),e.jsx("div",{className:"pt-3 border-t border-slate-700/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-slate-300",children:"ì´ ì‚¬ìš©ì ë³´ìœ ê¸ˆ"}),e.jsxs("span",{className:"text-sm font-bold text-emerald-400",children:["â‚©",ne.reduce((a,t)=>a+t.usersBalance,0).toLocaleString()]})]})})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground text-sm",children:"í•˜ìœ„ íŒŒíŠ¸ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤"})})})]})]})]})]})})]}),e.jsx(Oe,{open:wa,onOpenChange:te,children:e.jsxs(Ae,{className:"sm:max-w-[600px] max-h-[80vh] overflow-y-auto",children:[e.jsxs(Be,{children:[e.jsx(qe,{children:r.partnerManagement.newPartner}),e.jsx(Ue,{children:r.partnerManagement.createPartnerDescription})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"username",children:r.partnerManagement.partnerUsername}),e.jsx(S,{id:"username",value:i.username,onChange:a=>b(t=>({...t,username:a.target.value})),placeholder:r.partnerManagement.partnerUsernameInput})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"nickname",children:r.partnerManagement.partnerNickname}),e.jsx(S,{id:"nickname",value:i.nickname,onChange:a=>b(t=>({...t,nickname:a.target.value})),placeholder:r.partnerManagement.partnerNicknameInput})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"password",children:r.common.password}),e.jsx(S,{id:"password",type:"password",value:i.password,onChange:a=>b(t=>({...t,password:a.target.value})),placeholder:r.partnerManagement.initialPassword})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"partner_type",children:r.partnerManagement.partnerGrade}),e.jsxs(Te,{value:i.partner_type,onValueChange:async a=>{if(b(t=>({...t,partner_type:a})),n.user?.level!==1){const t=await Me(a);if(Ze(t.message),t.directParentId&&!t.hasGap){const l=await la(t.directParentId);l&&(we(l),console.log(`âœ… ${q[a]} ìƒìœ„ íŒŒíŠ¸ë„ˆ ì»¤ë¯¸ì…˜ ë¡œë“œ:`,l))}}else a==="head_office"&&we({rolling:100,losing:100,fee:100,nickname:r.partnerManagement.system})},children:[e.jsx(Fe,{children:e.jsx(Ee,{})}),e.jsxs($e,{children:[n.user?.level===1&&e.jsx(P,{value:"head_office",children:r.partnerManagement.headOffice}),n.user?.level===2&&e.jsx(P,{value:"main_office",children:r.partnerManagement.mainOffice}),n.user?.level===3&&e.jsx(P,{value:"sub_office",children:r.partnerManagement.subOffice}),n.user?.level===4&&e.jsx(P,{value:"distributor",children:r.partnerManagement.distributor}),n.user?.level===5&&e.jsx(P,{value:"store",children:r.partnerManagement.store})]})]}),xe&&e.jsx("div",{className:"p-3 bg-red-50 dark:bg-red-900/10 rounded-lg border border-red-200 dark:border-red-800",children:e.jsx("p",{className:"text-xs text-red-700 dark:text-red-300",children:xe})})]})]}),i.partner_type==="head_office"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(w,{htmlFor:"opcode",className:"flex items-center gap-2",children:[e.jsx(_a,{className:"h-4 w-4"}),"OPCODE"]}),e.jsx(S,{id:"opcode",value:i.opcode,onChange:a=>b(t=>({...t,opcode:a.target.value})),placeholder:r.partnerManagement.opcodeInput})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"secret_key",children:r.partnerManagement.secretKey}),e.jsx(S,{id:"secret_key",value:i.secret_key,onChange:a=>b(t=>({...t,secret_key:a.target.value})),placeholder:r.partnerManagement.secretKeyInput})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"api_token",children:r.partnerManagement.token}),e.jsx(S,{id:"api_token",value:i.api_token,onChange:a=>b(t=>({...t,api_token:a.target.value})),placeholder:r.partnerManagement.apiTokenInput})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4 text-green-500"}),r.partnerManagement.commissionSettingsLabel]}),i.partner_type!=="head_office"&&y&&e.jsxs(I,{variant:"outline",className:"text-xs",children:[r.partnerManagement.upperLimit," ",y.rolling,"% / ",y.losing,"%"]})]}),i.partner_type==="head_office"?e.jsx("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/10 rounded-lg border border-purple-200 dark:border-purple-800",children:e.jsx("p",{className:"text-xs text-purple-700 dark:text-purple-300",dangerouslySetInnerHTML:{__html:r.partnerManagement.headOfficeNote}})}):e.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-900/10 rounded-lg border border-blue-200 dark:border-blue-800",children:e.jsx("p",{className:"text-xs text-blue-700 dark:text-blue-300",children:r.partnerManagement.commissionCreateNote})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"commission_rolling",children:r.partnerManagement.rollingCommissionLabel}),e.jsx(S,{id:"commission_rolling",type:"text",step:"0.1",min:"0",max:i.partner_type==="head_office"?100:y?.rolling||100,value:i.partner_type==="head_office"?100:i.commission_rolling,onChange:a=>{if(i.partner_type==="head_office")return;const t=a.target.value;if(t===""){b(d=>({...d,commission_rolling:0}));return}const l=parseFloat(t);if(isNaN(l))return;const s=y?.rolling||100;if(l>s){u.error(r.partnerManagement.rollingExceedError.replace("{{max}}",s.toString()));return}b(d=>({...d,commission_rolling:l}))},disabled:i.partner_type==="head_office",className:i.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.partner_type==="head_office"?r.partnerManagement.headOfficeFixed:r.partnerManagement.totalBettingAmount})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"commission_losing",children:r.partnerManagement.losingCommissionLabel}),e.jsx(S,{id:"commission_losing",type:"text",step:"0.1",min:"0",max:i.partner_type==="head_office"?100:y?.losing||100,value:i.partner_type==="head_office"?100:i.commission_losing,onChange:a=>{if(i.partner_type==="head_office")return;const t=a.target.value;if(t===""){b(d=>({...d,commission_losing:0}));return}const l=parseFloat(t);if(isNaN(l))return;const s=y?.losing||100;if(l>s){u.error(r.partnerManagement.losingExceedError.replace("{{max}}",s.toString()));return}b(d=>({...d,commission_losing:l}))},disabled:i.partner_type==="head_office",className:i.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.partner_type==="head_office"?r.partnerManagement.headOfficeFixed:r.partnerManagement.memberNetLoss})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"withdrawal_fee",children:r.partnerManagement.withdrawalFeeLabel}),e.jsx(S,{id:"withdrawal_fee",type:"text",step:"0.1",min:"0",max:i.partner_type==="head_office"?100:y?.fee||100,value:i.partner_type==="head_office"?100:i.withdrawal_fee,onChange:a=>{if(i.partner_type==="head_office")return;const t=a.target.value;if(t===""){b(d=>({...d,withdrawal_fee:0}));return}const l=parseFloat(t);if(isNaN(l))return;const s=y?.fee||100;if(l>s){u.error(r.partnerManagement.feeExceedError.replace("{{max}}",s.toString()));return}b(d=>({...d,withdrawal_fee:l}))},disabled:i.partner_type==="head_office",className:i.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.partner_type==="head_office"?r.partnerManagement.headOfficeFixed:r.partnerManagement.withdrawalFeeDesc})]})]})]})]}),e.jsxs(Ve,{children:[e.jsx(M,{variant:"outline",onClick:()=>{te(!1),da(),Ze("")},children:r.common.cancel}),e.jsx(M,{onClick:Ba,disabled:z||!!xe&&n.user?.level!==1,children:z?r.partnerManagement.creating:r.partnerManagement.createPartnerButton})]})]})}),e.jsx(Oe,{open:Na,onOpenChange:Y,children:e.jsxs(Ae,{className:"sm:max-w-[600px] max-h-[80vh] overflow-y-auto",children:[e.jsxs(Be,{children:[e.jsx(qe,{children:"íŒŒíŠ¸ë„ˆ ì •ë³´ ìˆ˜ì •"}),e.jsx(Ue,{children:"íŒŒíŠ¸ë„ˆì˜ ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_username",children:"ì•„ì´ë””"}),e.jsx(S,{id:"edit_username",value:i.username,disabled:!0,className:"bg-muted"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_nickname",children:"ë‹‰ë„¤ì„"}),e.jsx(S,{id:"edit_nickname",value:i.nickname,onChange:a=>b(t=>({...t,nickname:a.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_password",children:r.partnerManagement.passwordChangeOnly}),e.jsx(S,{id:"edit_password",type:"password",value:i.password,onChange:a=>b(t=>({...t,password:a.target.value})),placeholder:r.partnerManagement.passwordChangeHint}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r.partnerManagement.passwordChangeNote})]}),L?.partner_type==="head_office"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(w,{htmlFor:"edit_opcode",className:"flex items-center gap-2",children:[e.jsx(_a,{className:"h-4 w-4"}),"OPCODE"]}),e.jsx(S,{id:"edit_opcode",value:i.opcode,onChange:a=>b(t=>({...t,opcode:a.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_secret_key",children:"Secret Key"}),e.jsx(S,{id:"edit_secret_key",value:i.secret_key,onChange:a=>b(t=>({...t,secret_key:a.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_api_token",children:"API Token"}),e.jsx(S,{id:"edit_api_token",value:i.api_token,onChange:a=>b(t=>({...t,api_token:a.target.value}))})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4 text-green-500"}),"ì»¤ë¯¸ì…˜ ì„¤ì •"]}),L?.partner_type!=="head_office"&&y&&e.jsxs(I,{variant:"outline",className:"text-xs",children:["ìƒìœ„ í•œë„: ",y.rolling,"% / ",y.losing,"% / ",y.fee,"%"]})]}),L?.partner_type==="head_office"?e.jsx("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/10 rounded-lg border border-purple-200 dark:border-purple-800",children:e.jsxs("p",{className:"text-xs text-purple-700 dark:text-purple-300",children:["ğŸ¢ ",e.jsx("strong",{children:"ëŒ€ë³¸ì‚¬"}),"ëŠ” ìµœìƒìœ„ íŒŒíŠ¸ë„ˆë¡œ ì»¤ë¯¸ì…˜ì´ ",e.jsx("strong",{children:"100%"}),"ë¡œ ê³ ì •ë©ë‹ˆë‹¤."]})}):e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-900/10 rounded-lg border border-amber-200 dark:border-amber-800",children:e.jsx("p",{className:"text-xs text-amber-700 dark:text-amber-300",children:"âš ï¸ ì»¤ë¯¸ì…˜ ë³€ê²½ ì‹œ ì •ì‚°ì— ì¦‰ì‹œ ë°˜ì˜ë˜ë©°, ìƒìœ„ íŒŒíŠ¸ë„ˆ ìš”ìœ¨ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_commission_rolling",children:"ë¡¤ë§ ì»¤ë¯¸ì…˜ (%)"}),e.jsx(S,{id:"edit_commission_rolling",type:"number",step:"0.1",min:"0",max:L?.partner_type==="head_office"?100:y?.rolling||100,value:i.commission_rolling,onChange:a=>b(t=>({...t,commission_rolling:parseFloat(a.target.value)||0})),disabled:L?.partner_type==="head_office",className:L?.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:L?.partner_type==="head_office"?"ëŒ€ë³¸ì‚¬ ê³ ì •ê°’":"íšŒì› ì´ ë² íŒ…ì•¡ Ã— ì»¤ë¯¸ì…˜ ìš”ìœ¨"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_commission_losing",children:"ë£¨ì§• ì»¤ë¯¸ì…˜ (%)"}),e.jsx(S,{id:"edit_commission_losing",type:"number",step:"0.1",min:"0",max:L?.partner_type==="head_office"?100:y?.losing||100,value:i.commission_losing,onChange:a=>b(t=>({...t,commission_losing:parseFloat(a.target.value)||0})),disabled:L?.partner_type==="head_office",className:L?.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:L?.partner_type==="head_office"?"ëŒ€ë³¸ì‚¬ ê³ ì •ê°’":"íšŒì› ìˆœì†ì‹¤ì•¡ Ã— ì»¤ë¯¸ì…˜ ìš”ìœ¨"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"edit_withdrawal_fee",children:"í™˜ì „ ìˆ˜ìˆ˜ë£Œ (%)"}),e.jsx(S,{id:"edit_withdrawal_fee",type:"number",step:"0.1",min:"0",max:L?.partner_type==="head_office"?100:y?.fee||100,value:i.withdrawal_fee,onChange:a=>b(t=>({...t,withdrawal_fee:parseFloat(a.target.value)||0})),disabled:L?.partner_type==="head_office",className:L?.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:L?.partner_type==="head_office"?"ëŒ€ë³¸ì‚¬ ê³ ì •ê°’":"í™˜ì „ ê¸ˆì•¡ì— ì ìš©ë˜ëŠ” ìˆ˜ìˆ˜ë£Œ"})]})]})]})]}),e.jsxs(Ve,{children:[e.jsx(M,{variant:"outline",onClick:()=>{Y(!1),ae(null)},children:"ì·¨ì†Œ"}),e.jsx(M,{onClick:qa,disabled:z,children:z?"ìˆ˜ì • ì¤‘...":"ìˆ˜ì • ì™„ë£Œ"})]})]})}),e.jsx(Oe,{open:Ma,onOpenChange:J,children:e.jsxs(Ae,{className:"sm:max-w-[500px]",children:[e.jsxs(Be,{children:[e.jsx(qe,{className:"text-red-600",children:"âš ï¸ íŒŒíŠ¸ë„ˆ ì‚­ì œ í™•ì¸"}),e.jsx(Ue,{children:"ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚­ì œí•˜ë ¤ë©´ ì•„ë˜ì— íŒŒíŠ¸ë„ˆ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."})]}),C&&e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"íŒŒíŠ¸ë„ˆ"}),e.jsxs("span",{className:"font-medium",children:[C.nickname," (",C.username,")"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"ë“±ê¸‰"}),e.jsx(I,{className:`${W[C.partner_type]} text-white`,children:q[C.partner_type]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"í•˜ìœ„ íŒŒíŠ¸ë„ˆ"}),e.jsxs("span",{className:"font-medium",children:[C.child_count||0,"ëª…"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"ê´€ë¦¬ íšŒì›"}),e.jsxs("span",{className:"font-medium",children:[C.user_count||0,"ëª…"]})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(w,{htmlFor:"delete-confirm",className:"text-red-600",children:["ì‚­ì œ í™•ì¸: ",e.jsx("span",{className:"font-mono",children:C.username})," ì…ë ¥"]}),e.jsx(S,{id:"delete-confirm",value:de,onChange:a=>Q(a.target.value),placeholder:"íŒŒíŠ¸ë„ˆ ì•„ì´ë””ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”",className:"border-red-300 focus:border-red-500"})]}),e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg border border-yellow-200 dark:border-yellow-800",children:e.jsxs("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:[e.jsx("strong",{children:"ì£¼ì˜:"})," í•˜ìœ„ íŒŒíŠ¸ë„ˆë‚˜ ê´€ë¦¬ íšŒì›ì´ ìˆìœ¼ë©´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."]})})]}),e.jsxs(Ve,{children:[e.jsx(M,{variant:"outline",onClick:()=>{J(!1),re(null),Q("")},disabled:me,children:"ì·¨ì†Œ"}),e.jsx(M,{variant:"destructive",onClick:Ua,disabled:me||de!==C?.username,children:me?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"ì‚­ì œ ì¤‘..."]}):e.jsxs(e.Fragment,{children:[e.jsx(We,{className:"h-4 w-4 mr-2"}),"ì‚­ì œ"]})})]})]})}),e.jsx(at,{open:Pa,onOpenChange:_e,type:Da,targetType:"partner",selectedTarget:E?{id:E.id,username:E.username,nickname:E.nickname,balance:E.level===2?(E.invest_balance||0)+(E.oroplay_balance||0):E.balance||0,level:E.level,invest_balance:E.invest_balance||0,oroplay_balance:E.oroplay_balance||0}:null,onSubmit:Va,onTypeChange:ve,currentUserLevel:n.user?.level,currentUserBalance:Ta,currentUserInvestBalance:Ea,currentUserOroplayBalance:$a})]})}export{Ct as PartnerManagement,Ct as default};
