import{r as h,j as e}from"./react-core-BwkdTuSg.js";import{a as Q,s as p,B as I,h as v,C as q,E,F as A,G as L,e as U,L as i,I as m,S as j,o as y,p as w,q as b,r as k,z as W}from"./index-CGvwOXPh.js";import{D as X}from"./DataTable-Cv4Bf9qm.js";import{k as s}from"./vendor-D410aui4.js";import{ag as Y,R as Z,a7 as ee,E as ae,n as re,f as te,S as ne,$ as se,U as ie}from"./lucide-icons-CAeZOOE5.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";import"./table-BXx61AEI.js";function fe({user:o}){const{t:r}=Q(),[O,$]=h.useState([]),[N,B]=h.useState([]),[H,P]=h.useState(!1),[S,_]=h.useState(!1),[g,R]=h.useState(!1),[t,C]=h.useState({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:o.id,level:2,commission_rolling:.5,commission_losing:5,withdrawal_fee:1,bank_name:"",bank_account:"",bank_holder:"",contact_info:""}),F=[{value:"head_office",label:r.partnerCreation.partnerTypes.head_office,level:2},{value:"main_office",label:r.partnerCreation.partnerTypes.main_office,level:3},{value:"sub_office",label:r.partnerCreation.partnerTypes.sub_office,level:4},{value:"distributor",label:r.partnerCreation.partnerTypes.distributor,level:5},{value:"store",label:r.partnerCreation.partnerTypes.store,level:6}];h.useEffect(()=>{x(),o.partner_type==="system_admin"&&V()},[]);const x=async()=>{P(!0);try{let a=p.from("partners").select("*").order("created_at",{ascending:!1});o.level>1&&(a=a.or(`parent_id.eq.${o.id},id.eq.${o.id}`));const{data:n,error:c}=await a;if(c)throw c;$(n||[])}catch(a){console.error("Failed to load partners:",a),s.error(r.partnerCreation.loadFailed)}finally{P(!1)}},V=async()=>{try{const{data:a}=await p.from("partners").select("id, username, nickname, partner_type, level").eq("partner_type","head_office").eq("status","active").order("created_at",{ascending:!0}),{data:n}=await p.from("partners").select("id, username, nickname, partner_type, level").in("partner_type",["main_office","sub_office","distributor","store"]).eq("status","active").order("level",{ascending:!0}).order("created_at",{ascending:!0});B([...a||[],...n||[]])}catch(a){console.error("소속 파트너 목록 로드 실패:",a)}},l=(a,n)=>{if(C(c=>({...c,[a]:n})),a==="partner_type"){const c=F.find(d=>d.value===n);c&&C(d=>({...d,level:c.level}))}},G=()=>t.username.trim()?t.nickname.trim()?!t.password.trim()||t.password.length<6?(s.error(r.partnerCreation.enterPassword),!1):o.partner_type==="system_admin"&&t.partner_type!=="head_office"&&!t.selected_parent_id?(s.error(r.partnerCreation.selectParent),!1):!0:(s.error(r.partnerCreation.enterNickname),!1):(s.error(r.partnerCreation.enterUsername),!1),K=async()=>{if(!G())return;_(!0);const a=s.loading(r.partnerCreation.creatingPartner);try{const{data:n}=await p.from("partners").select("id").eq("username",t.username).maybeSingle();if(n){s.error(r.partnerCreation.duplicatePartner.replace("{{username}}",t.username),{id:a}),_(!1);return}const{data:c}=await p.from("users").select("id").eq("username",t.username).maybeSingle();if(c){s.error(r.partnerCreation.duplicateUser.replace("{{username}}",t.username),{id:a}),_(!1);return}let d=t.parent_id;o.partner_type==="system_admin"&&t.selected_parent_id&&(d=t.selected_parent_id),s.loading(r.partnerCreation.creatingStep,{id:a});const f={username:t.username,nickname:t.nickname,password_hash:t.password,partner_type:t.partner_type,parent_id:d,level:t.level,commission_rolling:t.commission_rolling,commission_losing:t.commission_losing,withdrawal_fee:t.withdrawal_fee,bank_name:t.bank_name,bank_account:t.bank_account,bank_holder:t.bank_holder,contact_info:t.contact_info?JSON.parse(`{"memo": "${t.contact_info}"}`):null,status:"active",created_at:new Date().toISOString(),updated_at:new Date().toISOString()};t.partner_type==="head_office"&&t.timezone_offset!==void 0&&(f.timezone_offset=t.timezone_offset);const{data:u,error:z}=await p.from("partners").insert([f]).select().single();if(z)throw z;const{error:D}=await p.from("api_configs").insert([{partner_id:u.id,api_provider:"invest",invest_opcode:"",invest_secret_key:"",invest_token:"",balance:0,is_active:!0},{partner_id:u.id,api_provider:"oroplay",oroplay_client_id:"",oroplay_client_secret:"",oroplay_token:"",balance:0,is_active:!1}]);D?console.warn("⚠️ [파트너 생성] API config 생성 실패 (무시):",D):console.log("✅ [파트너 생성] API config 생성 완료:",u.id),s.success(r.partnerCreation.createSuccess,{id:a}),C({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:o.id,level:2,commission_rolling:.5,commission_losing:5,withdrawal_fee:1,bank_name:"",bank_account:"",bank_holder:"",contact_info:"",selected_parent_id:void 0}),await x()}catch(n){console.error("Failed to create partner:",n),s.error(r.partnerCreation.createFailed.replace("{{error}}",n.message),{id:a})}finally{_(!1)}},J=async a=>{try{const{data:n,error:c}=await p.from("partners").select("id, nickname, username").eq("parent_id",a);if(c)throw c;if(n&&n.length>0){s.error(r.partnerCreation.deleteHasChildren.replace("{{count}}",n.length.toString()));return}const{data:d,error:f}=await p.from("users").select("id, username, nickname").eq("referrer_id",a);if(f)throw f;if(d&&d.length>0){s.error(r.partnerCreation.deleteHasUsers.replace("{{count}}",d.length.toString()));return}if(!confirm(r.partnerCreation.deleteConfirm))return;const{error:u}=await p.from("partners").delete().eq("id",a);if(u)throw u;s.success(r.partnerCreation.deleteSuccess),await x()}catch(n){console.error("파트너 삭제 실패:",n),s.error(r.partnerCreation.deleteFailed.replace("{{error}}",n.message))}},T=a=>r.partnerCreation.levelText[a]||r.partnerCreation.levelText.unknown,M=[{key:"username",title:r.partnerCreation.username,sortable:!0},{key:"nickname",title:r.partnerCreation.nickname,sortable:!0},{key:"level",title:r.partnerCreation.grade,cell:a=>e.jsx(I,{variant:a.level===2?"default":"secondary",children:T(a.level)})},{key:"status",title:r.partnerCreation.status,cell:a=>e.jsx(I,{variant:a.status==="active"?"default":"secondary",children:a.status==="active"?r.partnerCreation.active:r.partnerCreation.inactive})},{key:"balance",title:r.partnerCreation.balance,cell:a=>e.jsxs("div",{className:"text-right font-mono",children:[new Intl.NumberFormat("ko-KR").format(a.balance||0),r.partnerCreation.won]})},{key:"created_at",title:r.partnerCreation.createdAt,cell:a=>e.jsx("div",{className:"text-sm text-muted-foreground",children:new Date(a.created_at).toLocaleDateString("ko-KR")})},{key:"actions",title:r.partnerCreation.actions,cell:a=>e.jsx("div",{className:"flex gap-1",children:e.jsx(v,{size:"sm",variant:"outline",onClick:()=>J(a.id),className:"h-8 w-8 p-0 text-red-600 hover:text-red-700",disabled:a.id===o.id,children:e.jsx(Y,{className:"h-4 w-4"})})})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:r.partnerCreation.title}),e.jsx("p",{className:"text-sm text-slate-400",children:r.partnerCreation.description})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(v,{onClick:x,variant:"outline",size:"sm",children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),r.common.refresh]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(q,{children:[e.jsxs(E,{children:[e.jsxs(A,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5"}),r.partnerCreation.createPartner]}),e.jsx(L,{children:r.partnerCreation.createDescription})]}),e.jsxs(U,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"username",children:r.partnerCreation.username}),e.jsx(m,{id:"username",value:t.username,onChange:a=>l("username",a.target.value),placeholder:r.partnerCreation.usernamePlaceholder})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"nickname",children:r.partnerCreation.nickname}),e.jsx(m,{id:"nickname",value:t.nickname,onChange:a=>l("nickname",a.target.value),placeholder:r.partnerCreation.nicknamePlaceholder})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(i,{htmlFor:"password",children:r.partnerCreation.password}),e.jsxs("div",{className:"relative",children:[e.jsx(m,{id:"password",type:g?"text":"password",value:t.password,onChange:a=>l("password",a.target.value),placeholder:r.partnerCreation.passwordPlaceholder}),e.jsx(v,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>R(!g),children:g?e.jsx(ae,{className:"h-4 w-4"}):e.jsx(re,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"partner_type",children:r.partnerCreation.partnerGrade}),e.jsxs(j,{value:t.partner_type,onValueChange:a=>l("partner_type",a),children:[e.jsx(y,{children:e.jsx(w,{placeholder:r.partnerCreation.selectGrade})}),e.jsx(b,{children:F.filter(a=>o.level===1?!0:a.level>o.level).map(a=>e.jsxs(k,{value:a.value,children:[a.label," (",r.partnerCreation.level," ",a.level,")"]},a.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{children:r.partnerCreation.level}),e.jsx(m,{value:`${r.partnerCreation.level} ${t.level}`,readOnly:!0,className:"bg-muted"})]})]}),o.partner_type==="system_admin"&&t.partner_type!=="head_office"&&N.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"selected_parent",children:r.partnerCreation.selectParentLabel}),e.jsxs(j,{value:t.selected_parent_id||"",onValueChange:a=>l("selected_parent_id",a),children:[e.jsx(y,{children:e.jsx(w,{placeholder:r.partnerCreation.selectParentPlaceholder})}),e.jsx(b,{children:N.map(a=>e.jsxs(k,{value:a.id,children:[a.nickname||a.username," (",T(a.level),")"]},a.id))})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r.partnerCreation.parentDescription})]}),t.partner_type==="head_office"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"timezone_offset",children:r.partnerCreation.timezoneOffset||"타임존 설정"}),e.jsxs(j,{value:String(t.timezone_offset!==void 0?t.timezone_offset:9),onValueChange:a=>l("timezone_offset",parseInt(a)),children:[e.jsx(y,{children:e.jsx(w,{placeholder:r.partnerCreation.selectTimezone||"타임존 선택"})}),e.jsx(b,{children:Array.from({length:27},(a,n)=>n-12).map(a=>e.jsxs(k,{value:String(a),children:["UTC",a>=0?"+":"",a," ",a===9?"(KST)":""]},a))})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r.partnerCreation.timezoneDescription||"대본사의 기준 타임존을 설정합니다. 통계 및 시간 표시에 적용됩니다."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:r.partnerCreation.commissionSettings})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"commission_rolling",children:r.partnerCreation.rollingCommission}),e.jsx(m,{id:"commission_rolling",type:"number",step:"0.1",value:t.commission_rolling,onChange:a=>{const n=parseFloat(a.target.value);l("commission_rolling",isNaN(n)?0:n)},placeholder:"0.5"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"commission_losing",children:r.partnerCreation.losingCommission}),e.jsx(m,{id:"commission_losing",type:"number",step:"0.1",value:t.commission_losing,onChange:a=>{const n=parseFloat(a.target.value);l("commission_losing",isNaN(n)?0:n)},placeholder:"5.0"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"withdrawal_fee",children:r.partnerCreation.withdrawalFee}),e.jsx(m,{id:"withdrawal_fee",type:"number",step:"0.1",value:t.withdrawal_fee,onChange:a=>{const n=parseFloat(a.target.value);l("withdrawal_fee",isNaN(n)?0:n)},placeholder:"1.0"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:r.partnerCreation.bankInfo})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"bank_name",children:r.partnerCreation.bankName}),e.jsx(m,{id:"bank_name",value:t.bank_name,onChange:a=>l("bank_name",a.target.value),placeholder:r.partnerCreation.bankNamePlaceholder})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"bank_account",children:r.partnerCreation.bankAccount}),e.jsx(m,{id:"bank_account",value:t.bank_account,onChange:a=>l("bank_account",a.target.value),placeholder:r.partnerCreation.bankAccountPlaceholder})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"bank_holder",children:r.partnerCreation.bankHolder}),e.jsx(m,{id:"bank_holder",value:t.bank_holder,onChange:a=>l("bank_holder",a.target.value),placeholder:r.partnerCreation.bankHolderPlaceholder})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"contact_info",children:r.partnerCreation.contactInfo}),e.jsx(W,{id:"contact_info",value:t.contact_info,onChange:a=>l("contact_info",a.target.value),placeholder:r.partnerCreation.contactInfoPlaceholder,rows:3})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsxs(v,{onClick:K,disabled:S,className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),S?r.partnerCreation.creating:r.partnerCreation.createButton]})})]})]}),e.jsxs(q,{children:[e.jsxs(E,{children:[e.jsxs(A,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-5 w-5"}),r.partnerCreation.partnerList]}),e.jsx(L,{children:r.partnerCreation.listDescription})]}),e.jsx(U,{children:e.jsx("div",{className:"rounded-md border",children:e.jsx(X,{data:O,columns:M,loading:H,searchPlaceholder:r.partnerCreation.searchPlaceholder})})})]})]})]})}export{fe as PartnerCreation};
