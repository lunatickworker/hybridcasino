import{r,j as e}from"./react-core-BwkdTuSg.js";import{n as L,a as R,s as i,m as U,i as k,I as B,B as M}from"./index-McppjVnx.js";import{k as o}from"./vendor-D410aui4.js";import{M as f}from"./MetricCard-DnMFhTGK.js";import{S as x,R as N,w,u as E}from"./lucide-icons-CePlpqHy.js";import"./radix-ui-omyR4zpf.js";import"./supabase-C8Oa5ukG.js";function z(){const{authState:u}=L(),{t,language:v}=R(),[l,b]=r.useState([]),[d,j]=r.useState(!0),[p,g]=r.useState(null),[c,_]=r.useState(""),m=async()=>{try{j(!0),console.log("ðŸ“‹ ë¸”ëž™ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ìž ì¡°íšŒ ì‹œìž‘");const{data:s,error:a}=await i.from("blacklist_users_view").select("*").order("blocked_at",{ascending:!1});if(a)throw console.error("âŒ ë¸”ëž™ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:",a),a;console.log("ðŸ“Š ë¸”ëž™ë¦¬ìŠ¤íŠ¸ ë°ì´í„°:",s),console.log(`ðŸ“ˆ ë¸”ëž™ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ìž ìˆ˜: ${s?.length||0}ëª…`),b(s||[])}catch(s){console.error("âŒ ë¸”ëž™ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì‹¤íŒ¨:",s),o.error(t("blacklist.loadFailed"))}finally{j(!1)}},S=async s=>{if(!u.user?.id){o.error(t("common.noAdminAuth"));return}try{g(s.user_id),console.log("ðŸ”“ ë¸”ëž™ë¦¬ìŠ¤íŠ¸ í•´ì œ ì‹œìž‘:",s.user_id);const{data:a,error:h}=await i.rpc("remove_user_from_blacklist_simple",{p_user_id:s.user_id,p_admin_id:u.user.id});if(h)throw console.error("âŒ ë¸”ëž™ë¦¬ìŠ¤íŠ¸ í•´ì œ ì˜¤ë¥˜:",h),h;if(console.log("âœ… RPC ì‘ë‹µ:",a),!a.success)throw new Error(a.error||"ë¸”ëž™ë¦¬ìŠ¤íŠ¸ í•´ì œ ì‹¤íŒ¨");o.success(t("blacklist.restoreSuccess",{username:s.username})),b(C=>C.filter(y=>y.user_id!==s.user_id))}catch(a){console.error("âŒ ë¸”ëž™ë¦¬ìŠ¤íŠ¸ í•´ì œ ì‹¤íŒ¨:",a),o.error(a.message||t("blacklist.restoreFailed"))}finally{g(null)}},n=l.filter(s=>s.username?.toLowerCase().includes(c.toLowerCase())||s.nickname?.toLowerCase().includes(c.toLowerCase())||s.blocked_reason?.toLowerCase().includes(c.toLowerCase()));return r.useEffect(()=>{m();const s=i.channel("blacklist-users-changes").on("postgres_changes",{event:"*",schema:"public",table:"users"},a=>{console.log("ðŸ”” ì‚¬ìš©ìž í…Œì´ë¸” ë³€ê²½ ê°ì§€:",a),(a.new?.status==="blocked"||a.old?.status==="blocked")&&m()}).subscribe();return()=>{i.removeChannel(s)}},[]),d&&l.length===0?e.jsx(U,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("h1",{className:"text-2xl font-bold text-slate-100 flex items-center gap-2",children:[e.jsx(x,{className:"h-6 w-6 text-rose-400"}),t.blacklist.title]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:t.blacklist.subtitle})]}),e.jsxs(k,{onClick:m,variant:"outline",disabled:d,children:[e.jsx(N,{className:`h-4 w-4 mr-2 ${d?"animate-spin":""}`}),t.common.refresh]})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-2",children:[e.jsx(f,{title:t.blacklist.blockedUsers,value:l.length.toLocaleString(),subtitle:t.blacklist.blockedCount,icon:x,color:"red"}),e.jsx(f,{title:t.blacklist.searchResults,value:n.length.toLocaleString(),subtitle:t.blacklist.filteredResults,icon:w,color:"blue"})]}),e.jsxs("div",{className:"glass-card rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-100 mb-1",children:t.blacklist.listTitle}),e.jsx("p",{className:"text-sm text-slate-400",children:t.blacklist.totalUsers.replace("{{count}}",n.length.toLocaleString())})]}),e.jsxs("div",{className:"relative w-96",children:[e.jsx(w,{className:"absolute left-3 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(B,{placeholder:t.blacklist.searchPlaceholder,className:"pl-10 input-premium",value:c,onChange:s=>_(s.target.value)})]})]}),e.jsx("div",{className:"space-y-4",children:n.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(x,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:l.length===0?t.blacklist.noBlacklist:t.blacklist.noSearchResults}),l.length===0&&e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:t.blacklist.addFromUserManagement})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-3",children:t.userManagement.username}),e.jsx("th",{className:"text-left p-3",children:t.userManagement.nickname}),e.jsx("th",{className:"text-left p-3",children:t.blacklist.blockReason}),e.jsx("th",{className:"text-left p-3",children:t.blacklist.processor}),e.jsx("th",{className:"text-left p-3",children:t.blacklist.blockDate}),e.jsx("th",{className:"text-left p-3",children:t.common.status}),e.jsx("th",{className:"text-left p-3",children:t.blacklist.management})]})}),e.jsx("tbody",{children:n.map(s=>e.jsxs("tr",{className:"border-b hover:bg-muted/50",children:[e.jsx("td",{className:"p-3 font-medium",children:s.username}),e.jsx("td",{className:"p-3",children:s.nickname}),e.jsx("td",{className:"p-3",children:e.jsx("div",{className:"max-w-[200px] truncate",title:s.blocked_reason||"",children:s.blocked_reason||t.blacklist.noReason})}),e.jsx("td",{className:"p-3",children:s.admin_nickname||t.common.system}),e.jsx("td",{className:"p-3",children:s.blocked_at?new Date(s.blocked_at).toLocaleString(v==="en"?"en-US":"ko-KR"):"-"}),e.jsx("td",{className:"p-3",children:e.jsx(M,{variant:"destructive",children:t.blacklist.blocked})}),e.jsx("td",{className:"p-3",children:e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>S(s),disabled:p===s.user_id,className:"text-green-600 hover:bg-green-50",children:[p===s.user_id?e.jsx(N,{className:"h-3 w-3 animate-spin mr-1"}):e.jsx(E,{className:"h-3 w-3 mr-1"}),t.blacklist.restore]})})]},s.user_id))})]})})})]})]})}export{z as BlacklistManagement,z as default};
